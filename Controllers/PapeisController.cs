using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Gestus.Modelos;
using Gestus.Dados;
using Gestus.DTOs.Papel;
using Gestus.DTOs.Comuns;
using Gestus.Validadores;
using System.Text.Json;
using OpenIddict.Abstractions;

namespace Gestus.Controllers;

/// <summary>
/// Controller para gerenciamento completo de pap√©is (roles)
/// Implementa opera√ß√µes CRUD robustas com pagina√ß√£o, filtros avan√ßados e auditoria
/// </summary>
[ApiController]
[Route("api/[controller]")]
[Produces("application/json")]
[Authorize] // ‚úÖ SEMPRE autenticado para qualquer opera√ß√£o
public class PapeisController : ControllerBase
{
    private readonly UserManager<Usuario> _userManager;
    private readonly RoleManager<Papel> _roleManager;
    private readonly GestusDbContexto _context;
    private readonly ILogger<PapeisController> _logger;

    public PapeisController(
        UserManager<Usuario> userManager,
        RoleManager<Papel> roleManager,
        GestusDbContexto context,
        ILogger<PapeisController> logger)
    {
        _userManager = userManager;
        _roleManager = roleManager;
        _context = context;
        _logger = logger;
    }

    /// <summary>
    /// Lista pap√©is com pagina√ß√£o, filtros e ordena√ß√£o avan√ßada
    /// </summary>
    /// <param name="filtros">Filtros de busca</param>
    /// <returns>Lista paginada de pap√©is</returns>
    [HttpGet]
    [ProducesResponseType(typeof(RespostaPaginada<PapelResumo>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarPapeis([FromQuery] FiltrosPapel filtros)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Listar"))
            {
                return Forbid("Permiss√£o insuficiente para listar pap√©is");
            }

            _logger.LogInformation("üìã Listando pap√©is - Filtros: {Filtros}, Usu√°rio: {UsuarioLogadoId}", 
                filtros, usuarioLogadoId);

            // ‚úÖ CONSTRUIR QUERY BASE
            var query = _context.Roles.AsQueryable();

            // ‚úÖ APLICAR FILTRO B√ÅSICO DE ATIVOS (se n√£o especificado incluir inativos)
            if (!filtros.IncluirInativos)
            {
                query = query.Where(r => r.Ativo);
            }

            // ‚úÖ APLICAR FILTROS
            if (!string.IsNullOrEmpty(filtros.Nome))
            {
                query = query.Where(r => r.Name!.Contains(filtros.Nome));
            }

            if (!string.IsNullOrEmpty(filtros.Descricao))
            {
                query = query.Where(r => r.Descricao.Contains(filtros.Descricao));
            }

            if (!string.IsNullOrEmpty(filtros.Categoria))
            {
                query = query.Where(r => r.Categoria != null && r.Categoria.Contains(filtros.Categoria));
            }

            if (filtros.Ativo.HasValue)
            {
                query = query.Where(r => r.Ativo == filtros.Ativo.Value);
            }

            if (filtros.NivelMinimo.HasValue)
            {
                query = query.Where(r => r.Nivel >= filtros.NivelMinimo.Value);
            }

            if (filtros.NivelMaximo.HasValue)
            {
                query = query.Where(r => r.Nivel <= filtros.NivelMaximo.Value);
            }

            if (filtros.DataCriacaoInicio.HasValue)
            {
                query = query.Where(r => r.DataCriacao >= filtros.DataCriacaoInicio.Value);
            }

            if (filtros.DataCriacaoFim.HasValue)
            {
                query = query.Where(r => r.DataCriacao <= filtros.DataCriacaoFim.Value);
            }

            // ‚úÖ FILTROS ESPECIAIS
            if (filtros.ApenasRolesSistema)
            {
                var rolesSistema = new[] { "SuperAdmin", "Admin", "Usuario" };
                query = query.Where(r => rolesSistema.Contains(r.Name!));
            }

            if (filtros.ApenasRolesPersonalizadas)
            {
                var rolesSistema = new[] { "SuperAdmin", "Admin", "Usuario" };
                query = query.Where(r => !rolesSistema.Contains(r.Name!));
            }

            if (filtros.Permissoes?.Any() == true)
            {
                query = query.Where(r => r.PapelPermissoes
                    .Where(pp => pp.Ativo)
                    .Any(pp => filtros.Permissoes.Contains(pp.Permissao.Nome)));
            }

            // ‚úÖ CONTAR TOTAL ANTES DA PAGINA√á√ÉO
            var totalItens = await query.CountAsync();

            // ‚úÖ APLICAR ORDENA√á√ÉO
            query = AplicarOrdenacao(query, filtros.OrdenarPor, filtros.DirecaoOrdenacao);

            // ‚úÖ APLICAR PAGINA√á√ÉO
            var skip = (filtros.Pagina - 1) * filtros.ItensPorPagina;
            var papeis = await query
                .Skip(skip)
                .Take(filtros.ItensPorPagina)
                .Include(r => r.PapelPermissoes.Where(pp => pp.Ativo))
                    .ThenInclude(pp => pp.Permissao)
                .Include(r => r.UsuarioPapeis.Where(up => up.Ativo))
                .AsSplitQuery()
                .Select(r => new PapelResumo
                {
                    Id = r.Id,
                    Nome = r.Name!,
                    Descricao = r.Descricao,
                    Categoria = r.Categoria,
                    Nivel = r.Nivel,
                    Ativo = r.Ativo,
                    DataCriacao = r.DataCriacao,
                    DataAtualizacao = r.DataAtualizacao,
                    TotalPermissoes = r.PapelPermissoes.Count(pp => pp.Ativo),
                    TotalUsuarios = r.UsuarioPapeis.Count(up => up.Ativo),
                    PermissoesResumo = r.PapelPermissoes
                        .Where(pp => pp.Ativo)
                        .Take(5)
                        .Select(pp => pp.Permissao.Nome)
                        .ToList()
                })
                .ToListAsync();

            // ‚úÖ CONSTRUIR RESPOSTA PAGINADA
            var totalPaginas = (int)Math.Ceiling((double)totalItens / filtros.ItensPorPagina);
            
            var resposta = new RespostaPaginada<PapelResumo>
            {
                Dados = papeis,
                PaginaAtual = filtros.Pagina,
                ItensPorPagina = filtros.ItensPorPagina,
                TotalItens = totalItens,
                TotalPaginas = totalPaginas,
                TemProximaPagina = filtros.Pagina < totalPaginas,
                TemPaginaAnterior = filtros.Pagina > 1
            };

            _logger.LogInformation("‚úÖ Pap√©is listados - Total: {Total}, P√°gina: {Pagina}/{TotalPaginas}", 
                totalItens, filtros.Pagina, totalPaginas);

            return Ok(resposta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar pap√©is");
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao listar pap√©is"
            });
        }
    }

    /// <summary>
    /// Obt√©m detalhes completos de um papel espec√≠fico
    /// </summary>
    /// <param name="id">ID do papel</param>
    /// <returns>Detalhes completos do papel</returns>
    [HttpGet("{id:int}")]
    [ProducesResponseType(typeof(PapelCompleto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ObterPapel(int id)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Visualizar"))
            {
                return Forbid("Permiss√£o insuficiente para visualizar pap√©is");
            }

            _logger.LogInformation("üëÅÔ∏è Obtendo papel {Id} por usu√°rio {UsuarioLogadoId}", id, usuarioLogadoId);

            var papel = await ObterPapelCompletoAsync(id);
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PapelNaoEncontrado",
                    Mensagem = "Papel n√£o encontrado"
                });
            }

            _logger.LogInformation("‚úÖ Papel {Id} obtido com sucesso", id);
            return Ok(papel);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao obter papel {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao obter papel"
            });
        }
    }

    /// <summary>
    /// Cria um novo papel no sistema
    /// </summary>
    /// <param name="request">Dados do novo papel</param>
    /// <returns>Papel criado</returns>
    [HttpPost]
    [ProducesResponseType(typeof(PapelCompleto), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> CriarPapel([FromBody] CriarPapelRequest request)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Criar"))
            {
                return Forbid("Permiss√£o insuficiente para criar pap√©is");
            }

            _logger.LogInformation("‚ûï Criando papel {Nome} por usu√°rio {UsuarioLogadoId}", 
                request.Nome, usuarioLogadoId);

            // ‚úÖ VALIDA√á√ÉO FLUENT VALIDATION
            var validador = new CriarPapelValidator(_roleManager, HttpContext.RequestServices);
            var resultadoValidacao = await validador.ValidateAsync(request);
            
            if (!resultadoValidacao.IsValid)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "DadosInvalidos",
                    Mensagem = "Dados de cria√ß√£o s√£o inv√°lidos",
                    Detalhes = resultadoValidacao.Errors.Select(e => e.ErrorMessage).ToList()
                });
            }

            // ‚úÖ VERIFICAR SE J√Å EXISTE (double check)
            var papelExiste = await _roleManager.FindByNameAsync(request.Nome);
            if (papelExiste != null)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PapelJaExiste",
                    Mensagem = "J√° existe um papel com este nome"
                });
            }

            // ‚úÖ CAPTURAR DADOS ANTES DA CRIA√á√ÉO
            var dadosAntes = new { };

            // ‚úÖ CRIAR O PAPEL
            var novoPapel = new Papel
            {
                Name = request.Nome,
                NormalizedName = request.Nome.ToUpperInvariant(),
                Descricao = request.Descricao,
                Categoria = request.Categoria,
                Nivel = request.Nivel,
                Ativo = request.Ativo,
                DataCriacao = DateTime.UtcNow
            };

            var resultado = await _roleManager.CreateAsync(novoPapel);
            if (!resultado.Succeeded)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "ErroCriacao",
                    Mensagem = "Erro ao criar papel",
                    Detalhes = resultado.Errors.Select(e => e.Description).ToList()
                });
            }

            // ‚úÖ ASSOCIAR PERMISS√ïES SE FORNECIDAS
            if (request.Permissoes?.Any() == true)
            {
                await AssociarPermissoesAoPapel(novoPapel.Id, request.Permissoes, usuarioLogadoId);
            }

            // ‚úÖ RECARREGAR PAPEL COM DADOS COMPLETOS
            var papelCriado = await ObterPapelCompletoAsync(novoPapel.Id);

            // ‚úÖ CAPTURAR DADOS DEPOIS DA CRIA√á√ÉO
            var dadosDepois = new
            {
                papelCriado!.Id,
                papelCriado.Nome,
                papelCriado.Descricao,
                papelCriado.Categoria,
                papelCriado.Nivel,
                papelCriado.Ativo,
                TotalPermissoes = papelCriado.Permissoes.Count
            };

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria("Papeis.Criar", "Papeis", novoPapel.Id.ToString(), 
                $"Papel criado: {request.Nome}", dadosAntes, dadosDepois);

            _logger.LogInformation("‚úÖ Papel {Id} '{Nome}' criado com sucesso por {UsuarioLogadoId}", 
                novoPapel.Id, request.Nome, usuarioLogadoId);

            return CreatedAtAction(nameof(ObterPapel), new { id = novoPapel.Id }, papelCriado);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao criar papel {Nome}", request.Nome);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao criar papel"
            });
        }
    }

    /// <summary>
    /// Atualiza um papel existente
    /// </summary>
    /// <param name="id">ID do papel a ser atualizado</param>
    /// <param name="request">Dados de atualiza√ß√£o do papel</param>
    /// <returns>Papel atualizado</returns>
    [HttpPut("{id:int}")]
    [ProducesResponseType(typeof(PapelCompleto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> AtualizarPapel(int id, [FromBody] AtualizarPapelRequest request)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Editar"))
            {
                return Forbid("Permiss√£o insuficiente para editar pap√©is");
            }

            _logger.LogInformation("‚úèÔ∏è Atualizando papel {Id} por usu√°rio {UsuarioLogadoId}", id, usuarioLogadoId);

            // ‚úÖ VALIDA√á√ÉO FLUENT VALIDATION
            var validador = new AtualizarPapelValidator(_roleManager, HttpContext.RequestServices);
            var resultadoValidacao = await validador.ValidateAsync(request);
            
            if (!resultadoValidacao.IsValid)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "DadosInvalidos",
                    Mensagem = "Dados de atualiza√ß√£o s√£o inv√°lidos",
                    Detalhes = resultadoValidacao.Errors.Select(e => e.ErrorMessage).ToList()
                });
            }

            // ‚úÖ BUSCAR PAPEL
            var papel = await _roleManager.FindByIdAsync(id.ToString());
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PapelNaoEncontrado",
                    Mensagem = "Papel n√£o encontrado"
                });
            }

            // ‚úÖ VALIDA√á√ÉO MANUAL DE NOME √öNICO (se fornecido)
            if (!string.IsNullOrEmpty(request.Nome) && request.Nome != papel.Name)
            {
                var papelComNome = await _roleManager.FindByNameAsync(request.Nome);
                if (papelComNome != null && papelComNome.Id != id)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "NomeJaExiste",
                        Mensagem = "J√° existe outro papel com este nome"
                    });
                }
            }

            // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
            if (papel.Name == "SuperAdmin" && request.Ativo == false)
            {
                // Verificar se h√° outros SuperAdmins ativos
                var totalSuperAdmins = await _context.Roles
                    .CountAsync(r => r.Name == "SuperAdmin" && r.Ativo);

                if (totalSuperAdmins <= 1)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "NaoPodeDesativarUltimoSuperAdmin",
                        Mensagem = "N√£o √© poss√≠vel desativar o √∫ltimo SuperAdmin do sistema"
                    });
                }
            }

            // ‚úÖ CAPTURAR DADOS ANTES DA ALTERA√á√ÉO
            var dadosAntes = new
            {
                papel.Name,
                papel.Descricao,
                papel.Categoria,
                papel.Nivel,
                papel.Ativo
            };

            // ‚úÖ APLICAR ALTERA√á√ïES
            bool alterado = false;

            if (!string.IsNullOrEmpty(request.Nome) && request.Nome != papel.Name)
            {
                papel.Name = request.Nome;
                papel.NormalizedName = request.Nome.ToUpperInvariant();
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Descricao) && request.Descricao != papel.Descricao)
            {
                papel.Descricao = request.Descricao;
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Categoria) && request.Categoria != papel.Categoria)
            {
                papel.Categoria = request.Categoria;
                alterado = true;
            }

            if (request.Nivel.HasValue && request.Nivel != papel.Nivel)
            {
                papel.Nivel = request.Nivel.Value;
                alterado = true;
            }

            if (request.Ativo.HasValue && request.Ativo != papel.Ativo)
            {
                papel.Ativo = request.Ativo.Value;
                alterado = true;
            }

            // ‚úÖ ATUALIZAR METADADOS SE HOUVE ALTERA√á√ÉO
            if (alterado)
            {
                papel.DataAtualizacao = DateTime.UtcNow;
            }

            // ‚úÖ SALVAR ALTERA√á√ïES DO PAPEL
            if (alterado)
            {
                var resultadoAtualizacao = await _roleManager.UpdateAsync(papel);
                if (!resultadoAtualizacao.Succeeded)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "ErroAtualizacao",
                        Mensagem = "Erro ao atualizar papel",
                        Detalhes = resultadoAtualizacao.Errors.Select(e => e.Description).ToList()
                    });
                }
            }

            // ‚úÖ GERENCIAR PERMISS√ïES SE ESPECIFICADAS
            if (request.Permissoes != null)
            {
                var permissoesAtuais = await ObterPermissoesDoPapel(papel.Id);
                var permissoesRemover = permissoesAtuais.Except(request.Permissoes).ToList();
                var permissoesAdicionar = request.Permissoes.Except(permissoesAtuais).ToList();

                // Remover permiss√µes
                if (permissoesRemover.Any())
                {
                    await RemoverPermissoesDoPapel(papel.Id, permissoesRemover);
                }

                // Adicionar permiss√µes
                if (permissoesAdicionar.Any())
                {
                    await AssociarPermissoesAoPapel(papel.Id, permissoesAdicionar, usuarioLogadoId);
                }

                if (permissoesRemover.Any() || permissoesAdicionar.Any())
                {
                    alterado = true;
                }
            }

            // ‚úÖ RECARREGAR PAPEL COM DADOS ATUALIZADOS
            var papelAtualizado = await ObterPapelCompletoAsync(papel.Id);

            // ‚úÖ CAPTURAR DADOS DEPOIS (para auditoria)
            var dadosDepois = new
            {
                papelAtualizado!.Nome,
                papelAtualizado.Descricao,
                papelAtualizado.Categoria,
                papelAtualizado.Nivel,
                papelAtualizado.Ativo,
                TotalPermissoes = papelAtualizado.Permissoes.Count
            };

            // ‚úÖ REGISTRAR AUDITORIA SE HOUVE ALTERA√á√ÉO
            if (alterado)
            {
                await RegistrarAuditoria("Papeis.Atualizar", "Papeis", id.ToString(), 
                    $"Papel atualizado: {papelAtualizado.Nome}",
                    dadosAntes, dadosDepois);
            }

            _logger.LogInformation("‚úÖ Papel {Id} atualizado com sucesso por {UsuarioLogadoId}", 
                id, usuarioLogadoId);

            return Ok(papelAtualizado);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao atualizar papel {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao atualizar papel"
            });
        }
    }

    /// <summary>
    /// Remove um papel do sistema (soft delete por padr√£o)
    /// </summary>
    /// <param name="id">ID do papel a ser removido</param>
    /// <param name="exclusaoPermanente">Se true, faz hard delete (exclus√£o definitiva)</param>
    /// <returns>Confirma√ß√£o da remo√ß√£o</returns>
    [HttpDelete("{id:int}")]
    [ProducesResponseType(typeof(RespostaSucesso), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> RemoverPapel(int id, [FromQuery] bool exclusaoPermanente = false)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Excluir"))
            {
                return Forbid("Permiss√£o insuficiente para excluir pap√©is");
            }

            _logger.LogInformation("üóëÔ∏è Removendo papel {Id} (permanente: {Permanente}) por usu√°rio {UsuarioLogadoId}", 
                id, exclusaoPermanente, usuarioLogadoId);

            // ‚úÖ BUSCAR PAPEL
            var papel = await _roleManager.FindByIdAsync(id.ToString());
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PapelNaoEncontrado",
                    Mensagem = "Papel n√£o encontrado"
                });
            }

            // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
            if (papel.Name == "SuperAdmin")
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "NaoPodeExcluirSuperAdmin",
                    Mensagem = "N√£o √© poss√≠vel excluir o papel SuperAdmin"
                });
            }

            // ‚úÖ CORRIGIDO: usar RoleId ao inv√©s de PapelId
            var usuariosComPapel = await _context.Set<UsuarioPapel>()
                .CountAsync(ur => ur.RoleId == id);

            if (usuariosComPapel > 0 && exclusaoPermanente)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PapelEmUso",
                    Mensagem = $"N√£o √© poss√≠vel excluir permanentemente. H√° {usuariosComPapel} usu√°rio(s) com este papel",
                    Detalhes = new List<string> { "Remova o papel de todos os usu√°rios antes da exclus√£o permanente" }
                });
            }

            // ‚úÖ CAPTURAR DADOS ANTES DA REMO√á√ÉO
            var dadosAntes = new
            {
                papel.Id,
                papel.Name,
                papel.Descricao,
                papel.Categoria,
                papel.Ativo,
                UsuariosComPapel = usuariosComPapel
            };

            string tipoOperacao;
            string mensagemSucesso;

            // ‚úÖ EXECUTAR REMO√á√ÉO
            if (exclusaoPermanente && usuariosComPapel == 0)
            {
                // Hard delete - remo√ß√£o definitiva
                var resultado = await _roleManager.DeleteAsync(papel);
                if (!resultado.Succeeded)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "ErroExclusao",
                        Mensagem = "Erro ao excluir papel permanentemente",
                        Detalhes = resultado.Errors.Select(e => e.Description).ToList()
                    });
                }

                tipoOperacao = "Papeis.ExcluirPermanente";
                mensagemSucesso = "Papel exclu√≠do permanentemente com sucesso";
            }
            else
            {
                // Soft delete - desativa√ß√£o
                papel.Ativo = false;
                papel.DataAtualizacao = DateTime.UtcNow;

                var resultado = await _roleManager.UpdateAsync(papel);
                if (!resultado.Succeeded)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "ErroDesativacao",
                        Mensagem = "Erro ao desativar papel",
                        Detalhes = resultado.Errors.Select(e => e.Description).ToList()
                    });
                }

                tipoOperacao = "Papeis.Desativar";
                mensagemSucesso = "Papel desativado com sucesso";
            }

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria(tipoOperacao, "Papeis", id.ToString(), 
                $"Papel removido: {papel.Name} (permanente: {exclusaoPermanente})",
                dadosAntes, new { Removido = true, TipoRemocao = exclusaoPermanente ? "Permanente" : "Desativacao" });

            _logger.LogInformation("‚úÖ Papel {Id} '{Nome}' removido com sucesso por {UsuarioLogadoId}", 
                id, papel.Name, usuarioLogadoId);

            return Ok(new RespostaSucesso
            {
                Sucesso = true,
                Mensagem = mensagemSucesso
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao remover papel {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao remover papel"
            });
        }
    }

    /// <summary>
    /// Reativa um papel desativado
    /// </summary>
    /// <param name="id">ID do papel a ser reativado</param>
    /// <returns>Confirma√ß√£o da reativa√ß√£o</returns>
    [HttpPost("{id:int}/reativar")]
    [ProducesResponseType(typeof(PapelCompleto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ReativarPapel(int id)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.Editar"))
            {
                return Forbid("Permiss√£o insuficiente para reativar pap√©is");
            }

            _logger.LogInformation("üîÑ Reativando papel {Id} por usu√°rio {UsuarioLogadoId}", id, usuarioLogadoId);

            // ‚úÖ BUSCAR PAPEL (incluindo inativos)
            var papel = await _context.Roles.FirstOrDefaultAsync(r => r.Id == id);
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PapelNaoEncontrado",
                    Mensagem = "Papel n√£o encontrado"
                });
            }

            if (papel.Ativo)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PapelJaAtivo",
                    Mensagem = "O papel j√° est√° ativo"
                });
            }

            // ‚úÖ REATIVAR PAPEL
            papel.Ativo = true;
            papel.DataAtualizacao = DateTime.UtcNow;

            var resultado = await _roleManager.UpdateAsync(papel);
            if (!resultado.Succeeded)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "ErroReativacao",
                    Mensagem = "Erro ao reativar papel",
                    Detalhes = resultado.Errors.Select(e => e.Description).ToList()
                });
            }

            // ‚úÖ RECARREGAR PAPEL COM DADOS COMPLETOS
            var papelReativado = await ObterPapelCompletoAsync(papel.Id);

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria("Papeis.Reativar", "Papeis", id.ToString(), 
                $"Papel reativado: {papel.Name}",
                new { Ativo = false }, new { Ativo = true });

            _logger.LogInformation("‚úÖ Papel {Id} '{Nome}' reativado com sucesso por {UsuarioLogadoId}", 
                id, papel.Name, usuarioLogadoId);

            return Ok(papelReativado);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao reativar papel {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao reativar papel"
            });
        }
    }

    /// <summary>
    /// Gerencia permiss√µes de um papel espec√≠fico
    /// </summary>
    /// <param name="id">ID do papel</param>
    /// <param name="request">Dados para gerenciamento de permiss√µes</param>
    /// <returns>Permiss√µes atualizadas do papel</returns>
    [HttpPost("{id:int}/permissoes")]
    [ProducesResponseType(typeof(RespostaGerenciamentoPermissoes), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> GerenciarPermissoesPapel(int id, [FromBody] GerenciarPermissoesRequest request)
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Papeis.GerenciarPermissoes"))
            {
                return Forbid("Permiss√£o insuficiente para gerenciar permiss√µes de pap√©is");
            }

            _logger.LogInformation("üîß Gerenciando permiss√µes do papel {Id} - Opera√ß√£o: {Operacao} por usu√°rio {UsuarioLogadoId}", 
                id, request.Operacao, usuarioLogadoId);

            // ‚úÖ VALIDA√á√ÉO FLUENT VALIDATION
            var validador = new GerenciarPermissoesPapelValidator(HttpContext.RequestServices);
            var resultadoValidacao = await validador.ValidateAsync(request);
            
            if (!resultadoValidacao.IsValid)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "DadosInvalidos",
                    Mensagem = "Dados de gerenciamento de permiss√µes s√£o inv√°lidos",
                    Detalhes = resultadoValidacao.Errors.Select(e => e.ErrorMessage).ToList()
                });
            }

            // ‚úÖ BUSCAR PAPEL
            var papel = await _roleManager.FindByIdAsync(id.ToString());
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PapelNaoEncontrado",
                    Mensagem = "Papel n√£o encontrado"
                });
            }

            if (!papel.Ativo)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PapelInativo",
                    Mensagem = "N√£o √© poss√≠vel gerenciar permiss√µes de um papel inativo"
                });
            }

            // ‚úÖ EXECUTAR OPERA√á√ÉO
            var permissoesAtuais = await ObterPermissoesDoPapel(papel.Id);
            var resultado = await ExecutarOperacaoPermissoes(
                papel.Id, 
                request.Operacao, 
                request.Permissoes ?? new List<string>(), 
                permissoesAtuais, 
                usuarioLogadoId
            );

            // ‚úÖ CORRIGIDO: Extrair propriedade para vari√°vel local (LINHA 859)
            var operacaoFoiSucesso = resultado.Sucesso;
                if (!operacaoFoiSucesso)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = resultado.CodigoErro ?? "ErroOperacao",
                        Mensagem = resultado.Mensagem,
                        // ‚úÖ CORRE√á√ÉO: Filtrar valores nulos antes de converter para List<string>
                        Detalhes = resultado.Detalhes?.Values
                            .Select(v => v?.ToString())
                            .Where(s => !string.IsNullOrEmpty(s))
                            .Cast<string>()
                            .ToList()
                    });
                }

            // ‚úÖ OBTER PERMISS√ïES ATUALIZADAS
            var permissoesFinais = await ObterPermissoesDoPapel(papel.Id);
            var permissoesMapeadas = await _context.Permissoes
                .Where(p => permissoesFinais.Contains(p.Nome))
                .Select(p => new PermissaoPapel
                {
                    Id = p.Id,
                    Nome = p.Nome,
                    Descricao = p.Descricao,
                    Recurso = p.Recurso,
                    Acao = p.Acao,
                    Categoria = p.Categoria,
                    DataAtribuicao = DateTime.UtcNow
                })
                .ToListAsync();

            // ‚úÖ CONSTRUIR RESPOSTA
            var resposta = new RespostaGerenciamentoPermissoes
            {
                Sucesso = true,
                Mensagem = resultado.Mensagem,
                Operacao = request.Operacao,
                PermissoesAfetadas = resultado.Detalhes?.ContainsKey("PermissoesAfetadas") == true ? 
                    (int)resultado.Detalhes["PermissoesAfetadas"] : 0,
                PermissoesAtuais = permissoesMapeadas,
                PermissoesAdicionadas = resultado.Detalhes?.ContainsKey("PermissoesAdicionadas") == true ?
                    (List<string>)resultado.Detalhes["PermissoesAdicionadas"] : new List<string>(),
                PermissoesRemovidas = resultado.Detalhes?.ContainsKey("PermissoesRemovidas") == true ?
                    (List<string>)resultado.Detalhes["PermissoesRemovidas"] : new List<string>(),
                Observacoes = request.Observacoes
            };

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria("Papeis.GerenciarPermissoes", "Papeis", id.ToString(),
                $"Permiss√µes do papel {papel.Name} - {request.Operacao}",
                new { PermissoesAnteriores = permissoesAtuais },
                new { PermissoesAtuais = permissoesFinais, Operacao = request.Operacao });

            _logger.LogInformation("‚úÖ Permiss√µes do papel {Id} gerenciadas com sucesso - {Operacao}", 
                id, request.Operacao);

            return Ok(resposta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao gerenciar permiss√µes do papel {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao gerenciar permiss√µes do papel"
            });
        }
    }

    /// <summary>
    /// Lista todas as permiss√µes dispon√≠veis no sistema
    /// </summary>
    /// <returns>Lista de permiss√µes dispon√≠veis</returns>
    [HttpGet("permissoes/disponiveis")]
    [ProducesResponseType(typeof(List<PermissaoDisponivel>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarPermissoesDisponiveis()
    {
        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();

            if (!TemPermissao("Permissoes.Listar"))
            {
                return Forbid("Permiss√£o insuficiente para listar permiss√µes");
            }

            _logger.LogInformation("üìã Listando permiss√µes dispon√≠veis por usu√°rio {UsuarioLogadoId}", usuarioLogadoId);

            var permissoes = await _context.Permissoes
                .Where(p => p.Ativo)
                .Select(p => new PermissaoDisponivel
                {
                    Id = p.Id,
                    Nome = p.Nome,
                    Descricao = p.Descricao,
                    Recurso = p.Recurso,
                    Acao = p.Acao,
                    Categoria = p.Categoria,
                    JaAtribuida = false, // Ser√° calculado se necess√°rio
                    Obrigatoria = p.Nome.StartsWith("Sistema."),
                    Critica = p.Nome.Contains("Excluir") || p.Nome.Contains("GerenciarPapeis") || p.Nome.StartsWith("Sistema."),
                    TotalPapeisComPermissao = p.PapelPermissoes.Count(pp => pp.Ativo)
                })
                .OrderBy(p => p.Categoria)
                .ThenBy(p => p.Recurso)
                .ThenBy(p => p.Acao)
                .ToListAsync();

            _logger.LogInformation("‚úÖ {Total} permiss√µes listadas", permissoes.Count);
            return Ok(permissoes);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar permiss√µes dispon√≠veis");
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno ao listar permiss√µes dispon√≠veis"
            });
        }
    }

    /// <summary>
    /// Lista usu√°rios que possuem um papel espec√≠fico
    /// </summary>
    /// <param name="id">ID do papel</param>
    /// <param name="filtros">Filtros de busca</param>
    /// <returns>Lista paginada de usu√°rios com o papel</returns>
    [HttpGet("{id:int}/usuarios")]
    [ProducesResponseType(typeof(RespostaPaginada<UsuarioComPapel>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarUsuariosDoPapel(int id, [FromQuery] FiltrosUsuariosPapel filtros)
    {
        try
        {
            // Verificar permiss√£o
            if (!TemPermissao("Papeis.Visualizar"))
            {
                // ‚úÖ CORRIGIDO: Usar StatusCode(403) ao inv√©s de Forbid() com string
                return StatusCode(403, new RespostaErro
                {
                    Erro = "Acesso negado",
                    Mensagem = "Voc√™ n√£o tem permiss√£o para visualizar usu√°rios de pap√©is"
                });
            }

            // Verificar se o papel existe
            var papel = await _roleManager.FindByIdAsync(id.ToString());
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Papel n√£o encontrado",
                    Mensagem = $"Papel com ID {id} n√£o foi encontrado"
                });
            }

            // ‚úÖ CORRE√á√ÉO: Construir query base com Include ANTES do Where
            var query = _context.UsuarioPapeis
                .Include(up => up.Usuario)
                .Where(up => up.RoleId == id && up.Ativo);

            // Aplicar filtros
            if (!string.IsNullOrEmpty(filtros.Nome))
            {
                query = query.Where(up => up.Usuario.Nome.Contains(filtros.Nome) ||
                                        up.Usuario.Sobrenome.Contains(filtros.Nome));
            }

            if (!string.IsNullOrEmpty(filtros.Email))
            {
                query = query.Where(up => up.Usuario.Email!.Contains(filtros.Email));
            }

            if (filtros.Ativo.HasValue)
            {
                query = query.Where(up => up.Usuario.Ativo == filtros.Ativo);
            }

            if (filtros.DataAtribuicaoInicio.HasValue)
            {
                query = query.Where(up => up.DataAtribuicao >= filtros.DataAtribuicaoInicio);
            }

            if (filtros.DataAtribuicaoFim.HasValue)
            {
                query = query.Where(up => up.DataAtribuicao <= filtros.DataAtribuicaoFim);
            }

            if (!filtros.IncluirExpirados)
            {
                query = query.Where(up => !up.DataExpiracao.HasValue || up.DataExpiracao > DateTime.UtcNow);
            }

            // Contar total
            var total = await query.CountAsync();

            // Aplicar pagina√ß√£o
            var usuarios = await query
                .Skip((filtros.Pagina - 1) * filtros.ItensPorPagina)
                .Take(filtros.ItensPorPagina)
                .Select(up => new UsuarioComPapel
                {
                    Id = up.Usuario.Id,
                    Email = up.Usuario.Email!,
                    NomeCompleto = up.Usuario.NomeCompleto ?? $"{up.Usuario.Nome} {up.Usuario.Sobrenome}",
                    Ativo = up.Usuario.Ativo,
                    DataAtribuicao = up.DataAtribuicao,
                    DataExpiracao = up.DataExpiracao,
                    UltimoLogin = up.Usuario.UltimoLogin,
                    TotalPapeis = up.Usuario.UsuarioPapeis.Count(p => p.Ativo)
                })
                .ToListAsync();

            var resposta = new RespostaPaginada<UsuarioComPapel>
            {
                Dados = usuarios,
                TotalItens = total,
                PaginaAtual = filtros.Pagina,
                ItensPorPagina = filtros.ItensPorPagina,
                TotalPaginas = (int)Math.Ceiling((double)total / filtros.ItensPorPagina)
            };

            await RegistrarAuditoria("Listar", "PapelUsuarios", id.ToString(),
                $"Listados {usuarios.Count} usu√°rios do papel {papel.Name}");

            return Ok(resposta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao listar usu√°rios do papel {PapelId}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro interno do servidor ao listar usu√°rios do papel"
            });
        }
    }

    #region M√©todos Auxiliares

    /// <summary>
    /// Aplica ordena√ß√£o √† query de pap√©is
    /// </summary>
    private IQueryable<Papel> AplicarOrdenacao(IQueryable<Papel> query, string? ordenarPor, string? direcao)
    {
        var crescente = string.IsNullOrEmpty(direcao) || direcao.ToLower() == "asc";
        
        return (ordenarPor?.ToLower()) switch
        {
            "nome" => crescente ? query.OrderBy(r => r.Name) : query.OrderByDescending(r => r.Name),
            "descricao" => crescente ? query.OrderBy(r => r.Descricao) : query.OrderByDescending(r => r.Descricao),
            "categoria" => crescente ? query.OrderBy(r => r.Categoria) : query.OrderByDescending(r => r.Categoria),
            "nivel" => crescente ? query.OrderBy(r => r.Nivel) : query.OrderByDescending(r => r.Nivel),
            "ativo" => crescente ? query.OrderBy(r => r.Ativo) : query.OrderByDescending(r => r.Ativo),
            "datacriacao" or _ => crescente ? query.OrderBy(r => r.DataCriacao) : query.OrderByDescending(r => r.DataCriacao)
        };
    }

    /// <summary>
    /// Obt√©m dados completos de um papel com relacionamentos
    /// </summary>
    private async Task<PapelCompleto?> ObterPapelCompletoAsync(int papelId)
    {
        var papel = await _context.Roles
            .Include(r => r.PapelPermissoes.Where(pp => pp.Ativo))
                .ThenInclude(pp => pp.Permissao)
            .Include(r => r.UsuarioPapeis.Where(up => up.Ativo))
            .AsSplitQuery()
            .FirstOrDefaultAsync(r => r.Id == papelId);

        if (papel == null)
        {
            return null;
        }

        // Calcular estat√≠sticas - CORRIGIDO: usar RoleId
        var totalUsuarios = papel.UsuarioPapeis.Count(up => up.Ativo);
        var usuariosAtivos = await _context.Set<UsuarioPapel>()
            .Where(up => up.RoleId == papelId && up.Ativo)
            .Include(up => up.Usuario)
            .CountAsync(up => up.Usuario.Ativo);

        var totalUsuariosAtivos = await _context.Users.CountAsync(u => u.Ativo);
        
        var estatisticas = new EstatisticasPapel
        {
            TotalPermissoes = papel.PapelPermissoes.Count(pp => pp.Ativo),
            TotalUsuarios = totalUsuarios,
            UsuariosAtivos = usuariosAtivos,
            UsuariosInativos = totalUsuarios - usuariosAtivos,
            UltimaAtribuicao = await _context.Set<UsuarioPapel>()
                .Where(up => up.RoleId == papelId)
                .OrderByDescending(up => up.DataAtribuicao)
                .Select(up => up.DataAtribuicao)
                .FirstOrDefaultAsync(),
            PermissoesPorCategoria = papel.PapelPermissoes
                .Where(pp => pp.Ativo && !string.IsNullOrEmpty(pp.Permissao.Categoria))
                .GroupBy(pp => pp.Permissao.Categoria!)
                .ToDictionary(g => g.Key, g => g.Count()),
            PercentualUso = totalUsuariosAtivos > 0 ? (decimal)usuariosAtivos / totalUsuariosAtivos * 100 : 0
        };

        return new PapelCompleto
        {
            Id = papel.Id,
            Nome = papel.Name!,
            Descricao = papel.Descricao,
            Categoria = papel.Categoria,
            Nivel = papel.Nivel,
            Ativo = papel.Ativo,
            DataCriacao = papel.DataCriacao,
            DataAtualizacao = papel.DataAtualizacao,
            TotalUsuarios = totalUsuarios,
            Estatisticas = estatisticas,
            Permissoes = papel.PapelPermissoes
                .Where(pp => pp.Ativo)
                .Select(pp => new PermissaoPapel
                {
                    Id = pp.Permissao.Id,
                    Nome = pp.Permissao.Nome,
                    Descricao = pp.Permissao.Descricao,
                    Recurso = pp.Permissao.Recurso,
                    Acao = pp.Permissao.Acao,
                    Categoria = pp.Permissao.Categoria,
                    DataAtribuicao = pp.DataAtribuicao
                })
                .ToList()
        };
    }

    /// <summary>
    /// Obt√©m lista de permiss√µes de um papel
    /// </summary>
    private async Task<List<string>> ObterPermissoesDoPapel(int papelId)
    {
        var permissoes = await _context.PapelPermissoes
            .Where(pp => pp.PapelId == papelId && pp.Ativo)
            .Include(pp => pp.Permissao)
            .Select(pp => pp.Permissao.Nome)
            .Where(nome => !string.IsNullOrEmpty(nome)) // Filtrar nulos
            .ToListAsync();

        return permissoes!; // Cast seguro ap√≥s filtrar nulos
    }

    /// <summary>
    /// Associa permiss√µes a um papel
    /// </summary>
    private async Task AssociarPermissoesAoPapel(int papelId, List<string> nomesPermissoes, int atribuidoPorId)
    {
        var permissoes = await _context.Permissoes
            .Where(p => nomesPermissoes.Contains(p.Nome) && p.Ativo)
            .ToListAsync();

        var novasAssociacoes = permissoes.Select(p => new PapelPermissao
        {
            PapelId = papelId,
            PermissaoId = p.Id,
            DataAtribuicao = DateTime.UtcNow,
            Ativo = true
        }).ToList();

        _context.Set<PapelPermissao>().AddRange(novasAssociacoes);
        await _context.SaveChangesAsync();
    }

    /// <summary>
    /// Remove permiss√µes de um papel
    /// </summary>
    private async Task RemoverPermissoesDoPapel(int papelId, List<string> nomesPermissoes)
    {
        var associacoes = await _context.Set<PapelPermissao>()
            .Where(pp => pp.PapelId == papelId && pp.Ativo)
            .Include(pp => pp.Permissao)
            .Where(pp => nomesPermissoes.Contains(pp.Permissao.Nome))
            .ToListAsync();

        foreach (var associacao in associacoes)
        {
            associacao.Ativo = false;
        }

        await _context.SaveChangesAsync();
    }

    /// <summary>
    /// Executa opera√ß√£o de gerenciamento de permiss√µes
    /// </summary>
    private async Task<ResultadoOperacao> ExecutarOperacaoPermissoes(int papelId, string operacao, 
        List<string> permissoes, List<string> permissoesAtuais, int usuarioLogadoId)
    {
        try
        {
            switch (operacao.ToLower())
            {
                case "substituir":
                    // Remove todas as permiss√µes atuais
                    await RemoverPermissoesDoPapel(papelId, permissoesAtuais);
                    
                    // Adiciona as novas permiss√µes
                    if (permissoes.Any())
                    {
                        await AssociarPermissoesAoPapel(papelId, permissoes, usuarioLogadoId);
                    }
                    
                    // ‚úÖ CORRIGIDO: Acessar propriedade, n√£o m√©todo
                    return ResultadoOperacao.CriarSucesso($"Permiss√µes substitu√≠das com sucesso. {permissoes.Count} permiss√µes definidas.");

                case "adicionar":
                    // Adiciona apenas permiss√µes que ainda n√£o existem
                    var permissoesParaAdicionar = permissoes.Except(permissoesAtuais).ToList();
                    
                    if (permissoesParaAdicionar.Any())
                    {
                        await AssociarPermissoesAoPapel(papelId, permissoesParaAdicionar, usuarioLogadoId);
                    }
                    
                    // ‚úÖ CORRIGIDO: Acessar propriedade, n√£o m√©todo  
                    return ResultadoOperacao.CriarSucesso($"{permissoesParaAdicionar.Count} permiss√µes adicionadas com sucesso.");

                case "remover":
                    // Remove apenas permiss√µes que existem
                    var permissoesParaRemover = permissoes.Intersect(permissoesAtuais).ToList();
                    
                    if (permissoesParaRemover.Any())
                    {
                        await RemoverPermissoesDoPapel(papelId, permissoesParaRemover);
                    }
                    
                    // ‚úÖ CORRIGIDO: Acessar propriedade, n√£o m√©todo
                    return ResultadoOperacao.CriarSucesso($"{permissoesParaRemover.Count} permiss√µes removidas com sucesso.");

                case "limpar":
                    // Remove todas as permiss√µes
                    await RemoverPermissoesDoPapel(papelId, permissoesAtuais);
                    
                    // ‚úÖ CORRIGIDO: Acessar propriedade, n√£o m√©todo
                    return ResultadoOperacao.CriarSucesso($"Todas as {permissoesAtuais.Count} permiss√µes foram removidas.");

                default:
                    return ResultadoOperacao.CriarErro("Opera√ß√£o inv√°lida", "OPERACAO_INVALIDA");
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao executar opera√ß√£o de permiss√µes {Operacao} para papel {PapelId}", operacao, papelId);
            return ResultadoOperacao.CriarErro($"Erro interno ao executar opera√ß√£o: {ex.Message}", "ERRO_INTERNO");
        }
    }

    /// <summary>
    /// Obt√©m ID do usu√°rio logado a partir do token
    /// </summary>
    private int ObterUsuarioLogadoId()
    {
        // ‚úÖ CORRE√á√ÉO: Especificar explicitamente o tipo
        var usuarioIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? 
                            User.FindFirst("sub")?.Value;
        
        if (string.IsNullOrEmpty(usuarioIdClaim) || !int.TryParse(usuarioIdClaim, out var usuarioId))
        {
            throw new UnauthorizedAccessException("Usu√°rio n√£o autenticado ou ID inv√°lido");
        }

        return usuarioId;
    }

    /// <summary>
    /// Verifica se o usu√°rio logado tem uma permiss√£o espec√≠fica
    /// </summary>
    private bool TemPermissao(string permissao)
    {
        try
        {
            // ‚úÖ CORRE√á√ÉO: Especificar explicitamente o tipo do delegate
            var permissoesClaim = User.Claims
                .Where(c => c.Type == "permissions")
                .Select(c => c.Value)
                .ToList();

            return permissoesClaim.Contains(permissao) || 
                   User.IsInRole("SuperAdmin");
        }
        catch (Exception)
        {
            return false;
        }
    }

    /// <summary>
    /// Registra uma a√ß√£o na auditoria
    /// </summary>
    private async Task RegistrarAuditoria(string acao, string recurso, string? recursoId, 
        string observacoes, object? dadosAntes = null, object? dadosDepois = null)
    {
        try
        {
            var usuarioId = ObterUsuarioLogadoId();
            
            var registro = new RegistroAuditoria
            {
                UsuarioId = usuarioId,
                Acao = acao,
                Recurso = recurso,
                RecursoId = recursoId,
                Observacoes = observacoes,
                DadosAntes = dadosAntes != null ? JsonSerializer.Serialize(dadosAntes) : null,
                DadosDepois = dadosDepois != null ? JsonSerializer.Serialize(dadosDepois) : null,
                DataHora = DateTime.UtcNow,
                EnderecoIp = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Desconhecido",
                UserAgent = HttpContext.Request.Headers["User-Agent"].ToString()
            };

            _context.RegistrosAuditoria.Add(registro);
            await _context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao registrar auditoria para a√ß√£o {Acao}", acao);
        }
    }

    #endregion
}