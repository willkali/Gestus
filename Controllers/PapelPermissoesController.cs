using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Gestus.Modelos;
using Gestus.Dados;
using Gestus.DTOs.PapelPermissao;
using Gestus.DTOs.Comuns;
using System.Text.Json;

namespace Gestus.Controllers;

/// <summary>
/// Controller para gerenciamento avan√ßado de associa√ß√µes papel-permiss√£o
/// Implementa opera√ß√µes de associa√ß√£o, relat√≥rios e an√°lises
/// </summary>
[ApiController]
[Route("api/[controller]")]
[Produces("application/json")]
[Authorize]
public class PapelPermissoesController : ControllerBase
{
    private readonly GestusDbContexto _context;
    private readonly ILogger<PapelPermissoesController> _logger;

    public PapelPermissoesController(
        GestusDbContexto context,
        ILogger<PapelPermissoesController> logger)
    {
        _context = context;
        _logger = logger;
    }

    /// <summary>
    /// Lista todas as associa√ß√µes papel-permiss√£o com filtros
    /// </summary>
    /// <param name="filtros">Filtros de busca</param>
    /// <returns>Lista paginada de associa√ß√µes</returns>
    [HttpGet]
    [ProducesResponseType(typeof(RespostaPaginada<AssociacaoPapelPermissao>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarAssociacoes([FromQuery] FiltrosAssociacoes filtros)
    {
        var usuarioLogadoId = ObterUsuarioLogadoId();
        _logger.LogInformation("üîç Usuario {UsuarioId} tentando acessar ListarAssociacoes", usuarioLogadoId);

        // ‚úÖ LOG DETALHADO DE DEBUG
        _logger.LogInformation("üë§ Claims do usu√°rio:");
        foreach (var claim in User.Claims.Take(10))
        {
            _logger.LogInformation("   - {Type}: {Value}", claim.Type, claim.Value);
        }

        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para visualizar associa√ß√µes papel-permiss√£o" 
            });
        }

        try
        {
            _logger.LogInformation("üîç Usuario {UsuarioId} listando associa√ß√µes papel-permiss√£o", usuarioLogadoId);

            // ‚úÖ QUERY BASE com relacionamentos otimizados
            var query = _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Include(pp => pp.Permissao)
                .AsQueryable();

            // ‚úÖ APLICAR FILTROS ESPEC√çFICOS
            query = AplicarFiltros(query, filtros);

            // ‚úÖ APLICAR ORDENA√á√ÉO
            query = AplicarOrdenacao(query, filtros.OrdenarPor, filtros.DirecaoOrdenacao);

            // ‚úÖ CONTAR TOTAL ANTES DA PAGINA√á√ÉO
            var totalItens = await query.CountAsync();

            // ‚úÖ APLICAR PAGINA√á√ÉO
            var associacoes = await query
                .Skip((filtros.Pagina - 1) * filtros.ItensPorPagina)
                .Take(filtros.ItensPorPagina)
                .Select(pp => new AssociacaoPapelPermissao
                {
                    PapelId = pp.PapelId,
                    PapelNome = pp.Papel.Name ?? "N/A",
                    PermissaoId = pp.PermissaoId,
                    PermissaoNome = pp.Permissao.Nome,
                    DataAtribuicao = pp.DataAtribuicao,
                    Ativo = pp.Ativo
                })
                .ToListAsync();

            // ‚úÖ CALCULAR DADOS DE PAGINA√á√ÉO
            var totalPaginas = (int)Math.Ceiling((double)totalItens / filtros.ItensPorPagina);

            var resposta = new RespostaPaginada<AssociacaoPapelPermissao>
            {
                Dados = associacoes,
                PaginaAtual = filtros.Pagina,
                ItensPorPagina = filtros.ItensPorPagina,
                TotalItens = totalItens,
                TotalPaginas = totalPaginas,
                TemProximaPagina = filtros.Pagina < totalPaginas,
                TemPaginaAnterior = filtros.Pagina > 1
            };

            _logger.LogInformation("‚úÖ Listagem conclu√≠da: {Total} associa√ß√µes encontradas", totalItens);
            return Ok(resposta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar associa√ß√µes papel-permiss√£o");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao processar solicita√ß√£o de listagem"
            });
        }
    }

    /// <summary>
    /// Obt√©m uma associa√ß√£o espec√≠fica por IDs do papel e permiss√£o
    /// </summary>
    /// <param name="papelId">ID do papel</param>
    /// <param name="permissaoId">ID da permiss√£o</param>
    /// <returns>Detalhes da associa√ß√£o</returns>
    [HttpGet("{papelId:int}/{permissaoId:int}")]
    [ProducesResponseType(typeof(AssociacaoPapelPermissao), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ObterAssociacaoPorIds(int papelId, int permissaoId)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para visualizar associa√ß√£o espec√≠fica" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîç Usuario {UsuarioId} consultando associa√ß√£o papel {PapelId} - permiss√£o {PermissaoId}",
                usuarioLogadoId, papelId, permissaoId);

            var associacao = await _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Include(pp => pp.Permissao)
                .Where(pp => pp.PapelId == papelId && pp.PermissaoId == permissaoId)
                .Select(pp => new AssociacaoPapelPermissao
                {
                    PapelId = pp.PapelId,
                    PapelNome = pp.Papel.Name ?? "N/A",
                    PermissaoId = pp.PermissaoId,
                    PermissaoNome = pp.Permissao.Nome,
                    DataAtribuicao = pp.DataAtribuicao,
                    Ativo = pp.Ativo
                })
                .FirstOrDefaultAsync();

            if (associacao == null)
            {
                _logger.LogWarning("‚ö†Ô∏è Associa√ß√£o n√£o encontrada: papel {PapelId} - permiss√£o {PermissaoId}", papelId, permissaoId);
                return NotFound(new RespostaErro
                {
                    Erro = "Associa√ß√£o n√£o encontrada",
                    Mensagem = $"N√£o existe associa√ß√£o entre papel {papelId} e permiss√£o {permissaoId}"
                });
            }

            _logger.LogInformation("‚úÖ Associa√ß√£o encontrada: {PapelNome} - {PermissaoNome}",
                associacao.PapelNome, associacao.PermissaoNome);

            return Ok(associacao);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao obter associa√ß√£o papel {PapelId} - permiss√£o {PermissaoId}", papelId, permissaoId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao consultar associa√ß√£o espec√≠fica"
            });
        }
    }

    /// <summary>
    /// Gera relat√≥rio detalhado de permiss√µes por papel
    /// </summary>
    /// <param name="papelId">ID do papel para an√°lise</param>
    /// <param name="incluirComparacao">Incluir compara√ß√£o com outros pap√©is</param>
    /// <returns>Relat√≥rio completo do papel</returns>
    [HttpGet("relatorio/papel/{papelId:int}")]
    [ProducesResponseType(typeof(RelatorioPermissoesPapel), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ObterRelatorioPermissoesPapel(int papelId, [FromQuery] bool incluirComparacao = true)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para gerar relat√≥rios de papel-permiss√£o" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üìä Usuario {UsuarioId} gerando relat√≥rio de permiss√µes do papel {PapelId}",
                usuarioLogadoId, papelId);

            // ‚úÖ VERIFICAR SE PAPEL EXISTE
            var papel = await _context.Papeis.FindAsync(papelId);
            if (papel == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Papel n√£o encontrado",
                    Mensagem = $"Papel com ID {papelId} n√£o existe"
                });
            }

            // ‚úÖ OBTER PERMISS√ïES DO PAPEL
            var permissoesPapel = await _context.PapelPermissoes
                .Include(pp => pp.Permissao)
                .Where(pp => pp.PapelId == papelId)
                .ToListAsync();

            // ‚úÖ CONTAR OUTRAS ASSOCIA√á√ïES PARA CADA PERMISS√ÉO
            var permissoesDetalhadas = new List<PermissaoDetalhada>();

            foreach (var pp in permissoesPapel)
            {
                var outrosPapeis = await _context.PapelPermissoes
                    .Where(x => x.PermissaoId == pp.PermissaoId && x.PapelId != papelId)
                    .CountAsync();

                permissoesDetalhadas.Add(new PermissaoDetalhada
                {
                    Id = pp.Permissao.Id,
                    Nome = pp.Permissao.Nome,
                    Categoria = pp.Permissao.Categoria,
                    DataAtribuicao = pp.DataAtribuicao,
                    Ativo = pp.Ativo,
                    OutrosPapeisComPermissao = outrosPapeis
                });
            }

            // ‚úÖ CONSTRUIR RELAT√ìRIO BASE
            var relatorio = new RelatorioPermissoesPapel
            {
                Papel = new PapelResumoRelatorio
                {
                    Id = papel.Id,
                    Nome = papel.Name ?? "N/A",
                    Descricao = papel.Descricao,
                    Categoria = papel.Categoria,
                    Nivel = papel.Nivel,
                    Ativo = papel.Ativo
                },
                TotalPermissoes = permissoesPapel.Count,
                PermissoesAtivas = permissoesPapel.Count(p => p.Ativo),
                PermissoesInativas = permissoesPapel.Count(p => !p.Ativo),
                Permissoes = permissoesDetalhadas
            };

            // ‚úÖ INCLUIR COMPARA√á√ÉO SE SOLICITADO
            if (incluirComparacao)
            {
                relatorio.Comparacao = await GerarComparacaoPapeis(papelId);
            }

            _logger.LogInformation("‚úÖ Relat√≥rio gerado: papel {PapelNome} com {Total} permiss√µes",
                papel.Name, permissoesPapel.Count);

            return Ok(relatorio);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao gerar relat√≥rio de permiss√µes do papel {PapelId}", papelId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao gerar relat√≥rio de permiss√µes"
            });
        }
    }

    /// <summary>
    /// Lista todas as permiss√µes dispon√≠veis que ainda n√£o est√£o associadas a um papel
    /// </summary>
    /// <param name="papelId">ID do papel para verificar permiss√µes dispon√≠veis</param>
    /// <returns>Lista de permiss√µes dispon√≠veis</returns>
    [HttpGet("permissoes/disponiveis/{papelId:int}")]
    [ProducesResponseType(typeof(List<PermissaoDetalhada>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarPermissoesDisponiveis(int papelId)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para listar permiss√µes dispon√≠veis" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîç Usuario {UsuarioId} listando permiss√µes dispon√≠veis para papel {PapelId}",
                usuarioLogadoId, papelId);

            // ‚úÖ VERIFICAR SE PAPEL EXISTE
            var papelExiste = await _context.Papeis.AnyAsync(p => p.Id == papelId);
            if (!papelExiste)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Papel n√£o encontrado",
                    Mensagem = $"Papel com ID {papelId} n√£o existe"
                });
            }

            // ‚úÖ OBTER PERMISS√ïES QUE O PAPEL N√ÉO TEM
            var permissoesJaAssociadas = _context.PapelPermissoes
                .Where(pp => pp.PapelId == papelId)
                .Select(pp => pp.PermissaoId);

            var permissoesDisponiveis = await _context.Permissoes
                .Where(p => p.Ativo && !permissoesJaAssociadas.Contains(p.Id))
                .Select(p => new PermissaoDetalhada
                {
                    Id = p.Id,
                    Nome = p.Nome,
                    Categoria = p.Categoria,
                    DataAtribuicao = DateTime.UtcNow, // Ser√° a data se for atribu√≠da
                    Ativo = p.Ativo,
                    OutrosPapeisComPermissao = _context.PapelPermissoes
                        .Count(pp => pp.PermissaoId == p.Id && pp.Ativo)
                })
                .OrderBy(p => p.Categoria)
                .ThenBy(p => p.Nome)
                .ToListAsync();

            _logger.LogInformation("‚úÖ Encontradas {Total} permiss√µes dispon√≠veis para o papel {PapelId}",
                permissoesDisponiveis.Count, papelId);

            return Ok(permissoesDisponiveis);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar permiss√µes dispon√≠veis para papel {PapelId}", papelId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao consultar permiss√µes dispon√≠veis"
            });
        }
    }

    /// <summary>
    /// Associa uma permiss√£o espec√≠fica a um papel
    /// </summary>
    /// <param name="papelId">ID do papel</param>
    /// <param name="permissaoId">ID da permiss√£o</param>
    /// <returns>Confirma√ß√£o da associa√ß√£o</returns>
    [HttpPost("{papelId:int}/permissoes/{permissaoId:int}")]
    [ProducesResponseType(typeof(AssociacaoPapelPermissao), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> AssociarPermissaoAoPapel(int papelId, int permissaoId)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para associar permiss√µes a pap√©is" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîó Usuario {UsuarioId} associando permiss√£o {PermissaoId} ao papel {PapelId}",
                usuarioLogadoId, permissaoId, papelId);

            // ‚úÖ VERIFICAR SE PAPEL EXISTE E EST√Å ATIVO
            var papel = await _context.Papeis.FindAsync(papelId);
            if (papel == null || !papel.Ativo)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Papel n√£o encontrado",
                    Mensagem = $"Papel com ID {papelId} n√£o existe ou est√° inativo"
                });
            }

            // ‚úÖ VERIFICAR SE PERMISS√ÉO EXISTE E EST√Å ATIVA
            var permissao = await _context.Permissoes.FindAsync(permissaoId);
            if (permissao == null || !permissao.Ativo)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Permiss√£o n√£o encontrada",
                    Mensagem = $"Permiss√£o com ID {permissaoId} n√£o existe ou est√° inativa"
                });
            }

            // ‚úÖ VERIFICAR SE ASSOCIA√á√ÉO J√Å EXISTE
            var associacaoExistente = await _context.PapelPermissoes
                .FirstOrDefaultAsync(pp => pp.PapelId == papelId && pp.PermissaoId == permissaoId);

            if (associacaoExistente != null)
            {
                if (associacaoExistente.Ativo)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "Associa√ß√£o j√° existe",
                        Mensagem = $"O papel '{papel.Name}' j√° possui a permiss√£o '{permissao.Nome}'"
                    });
                }
                else
                {
                    // ‚úÖ REATIVAR ASSOCIA√á√ÉO EXISTENTE
                    associacaoExistente.Ativo = true;
                    associacaoExistente.DataAtribuicao = DateTime.UtcNow;
                    await _context.SaveChangesAsync();

                    _logger.LogInformation("‚úÖ Associa√ß√£o reativada: {PapelNome} - {PermissaoNome}",
                        papel.Name, permissao.Nome);
                }
            }
            else
            {
                // ‚úÖ CRIAR NOVA ASSOCIA√á√ÉO
                var novaAssociacao = new PapelPermissao
                {
                    PapelId = papelId,
                    PermissaoId = permissaoId,
                    DataAtribuicao = DateTime.UtcNow,
                    Ativo = true
                };

                _context.PapelPermissoes.Add(novaAssociacao);
                await _context.SaveChangesAsync();

                _logger.LogInformation("‚úÖ Nova associa√ß√£o criada: {PapelNome} - {PermissaoNome}",
                    papel.Name, permissao.Nome);
            }

            // ‚úÖ RETORNAR DADOS DA ASSOCIA√á√ÉO
            var resultado = new AssociacaoPapelPermissao
            {
                PapelId = papelId,
                PapelNome = papel.Name ?? "N/A",
                PermissaoId = permissaoId,
                PermissaoNome = permissao.Nome,
                DataAtribuicao = DateTime.UtcNow,
                Ativo = true
            };

            return CreatedAtAction(nameof(ObterAssociacaoPorIds),
                new { papelId, permissaoId }, resultado);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao associar permiss√£o {PermissaoId} ao papel {PapelId}",
                permissaoId, papelId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao criar associa√ß√£o papel-permiss√£o"
            });
        }
    }

    /// <summary>
    /// Remove associa√ß√£o entre papel e permiss√£o
    /// </summary>
    /// <param name="papelId">ID do papel</param>
    /// <param name="permissaoId">ID da permiss√£o</param>
    /// <param name="exclusaoPermanente">Se true, remove definitivamente; se false, apenas desativa</param>
    /// <returns>Confirma√ß√£o da remo√ß√£o</returns>
    [HttpDelete("{papelId:int}/permissoes/{permissaoId:int}")]
    [ProducesResponseType(typeof(RespostaSucesso), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> DissociarPermissaoDoPapel(int papelId, int permissaoId, [FromQuery] bool exclusaoPermanente = false)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para remover associa√ß√µes papel-permiss√£o" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîó Usuario {UsuarioId} removendo associa√ß√£o papel {PapelId} - permiss√£o {PermissaoId}",
                usuarioLogadoId, papelId, permissaoId);

            // ‚úÖ VERIFICAR SE ASSOCIA√á√ÉO EXISTE
            var associacao = await _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Include(pp => pp.Permissao)
                .FirstOrDefaultAsync(pp => pp.PapelId == papelId && pp.PermissaoId == permissaoId);

            if (associacao == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Associa√ß√£o n√£o encontrada",
                    Mensagem = $"N√£o existe associa√ß√£o entre papel {papelId} e permiss√£o {permissaoId}"
                });
            }

            string operacao;
            if (exclusaoPermanente)
            {
                // ‚úÖ EXCLUS√ÉO PERMANENTE
                _context.PapelPermissoes.Remove(associacao);
                operacao = "removida permanentemente";
            }
            else
            {
                // ‚úÖ SOFT DELETE (DESATIVA√á√ÉO)
                associacao.Ativo = false;
                operacao = "desativada";
            }

            await _context.SaveChangesAsync();

            _logger.LogInformation("‚úÖ Associa√ß√£o {Operacao}: {PapelNome} - {PermissaoNome}",
                operacao, associacao.Papel.Name, associacao.Permissao.Nome);

            return Ok(new RespostaSucesso
            {
                Sucesso = true,
                Mensagem = $"Associa√ß√£o entre papel '{associacao.Papel.Name}' e permiss√£o '{associacao.Permissao.Nome}' foi {operacao} com sucesso"
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao remover associa√ß√£o papel {PapelId} - permiss√£o {PermissaoId}",
                papelId, permissaoId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao remover associa√ß√£o papel-permiss√£o"
            });
        }
    }

    /// <summary>
    /// Executa opera√ß√µes em lote com associa√ß√µes papel-permiss√£o
    /// </summary>
    /// <param name="request">Dados da opera√ß√£o em lote</param>
    /// <returns>Resultado da opera√ß√£o em lote</returns>
    [HttpPost("lote")]
    [ProducesResponseType(typeof(RespostaAssociacaoLote), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ExecutarAssociacaoLote([FromBody] AssociacaoLoteRequest request)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para opera√ß√µes em lote com associa√ß√µes papel-permiss√£o" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            var inicioOperacao = DateTime.UtcNow;

            _logger.LogInformation("üîó Usuario {UsuarioId} executando opera√ß√£o em lote: {Operacao}",
                usuarioLogadoId, request.Operacao);

            // ‚úÖ VALIDAR OPERA√á√ÉO
            var operacoesValidas = new[] { "associar", "dissociar", "substituir" };
            if (!operacoesValidas.Contains(request.Operacao.ToLower()))
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Opera√ß√£o inv√°lida",
                    Mensagem = "Opera√ß√£o deve ser: associar, dissociar ou substituir"
                });
            }

            // ‚úÖ VALIDAR DADOS
            if (!request.PapeisIds.Any() || !request.PermissoesIds.Any())
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Dados insuficientes",
                    Mensagem = "Deve fornecer pelo menos um papel e uma permiss√£o"
                });
            }

            // ‚úÖ VERIFICAR SE PAP√âIS EXISTEM
            var papeisExistentes = await _context.Papeis
                .Where(p => request.PapeisIds.Contains(p.Id) && p.Ativo)
                .ToListAsync();

            var papeisInvalidos = request.PapeisIds.Except(papeisExistentes.Select(p => p.Id)).ToList();
            if (papeisInvalidos.Any())
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Pap√©is inv√°lidos",
                    Mensagem = $"Pap√©is n√£o encontrados ou inativos: {string.Join(", ", papeisInvalidos)}"
                });
            }

            // ‚úÖ VERIFICAR SE PERMISS√ïES EXISTEM
            var permissoesExistentes = await _context.Permissoes
                .Where(p => request.PermissoesIds.Contains(p.Id) && p.Ativo)
                .ToListAsync();

            var permissoesInvalidas = request.PermissoesIds.Except(permissoesExistentes.Select(p => p.Id)).ToList();
            if (permissoesInvalidas.Any())
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Permiss√µes inv√°lidas",
                    Mensagem = $"Permiss√µes n√£o encontradas ou inativas: {string.Join(", ", permissoesInvalidas)}"
                });
            }

            // ‚úÖ EXECUTAR OPERA√á√ÉO ESPEC√çFICA
            var resultado = request.Operacao.ToLower() switch
            {
                "associar" => await ExecutarAssociacaoEmLote(papeisExistentes, permissoesExistentes),
                "dissociar" => await ExecutarDissociacaoEmLote(papeisExistentes, permissoesExistentes),
                "substituir" => await ExecutarSubstituicaoEmLote(papeisExistentes, permissoesExistentes),
                _ => throw new InvalidOperationException("Opera√ß√£o n√£o implementada")
            };

            resultado.Duracao = DateTime.UtcNow - inicioOperacao;

            _logger.LogInformation("‚úÖ Opera√ß√£o em lote conclu√≠da: {TotalSucessos}/{TotalProcessadas} sucessos",
                resultado.TotalSucessos, resultado.TotalProcessadas);

            return Ok(resultado);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao executar opera√ß√£o em lote de associa√ß√µes");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao executar opera√ß√£o em lote"
            });
        }
    }

    /// <summary>
    /// Substitui todas as permiss√µes de um papel por uma nova lista
    /// </summary>
    /// <param name="papelId">ID do papel</param>
    /// <param name="permissoesIds">Lista de IDs das novas permiss√µes</param>
    /// <returns>Lista atualizada de permiss√µes do papel</returns>
    [HttpPut("{papelId:int}/permissoes")]
    [ProducesResponseType(typeof(List<PermissaoDetalhada>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> SubstituirPermissoesDoPapel(int papelId, [FromBody] List<int> permissoesIds)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para substituir permiss√µes de papel" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîÑ Usuario {UsuarioId} substituindo permiss√µes do papel {PapelId}",
                usuarioLogadoId, papelId);

            // ‚úÖ VERIFICAR SE PAPEL EXISTE
            var papel = await _context.Papeis.FindAsync(papelId);
            if (papel == null || !papel.Ativo)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "Papel n√£o encontrado",
                    Mensagem = $"Papel com ID {papelId} n√£o existe ou est√° inativo"
                });
            }

            // ‚úÖ VERIFICAR SE PERMISS√ïES EXISTEM
            var permissoesValidas = await _context.Permissoes
                .Where(p => permissoesIds.Contains(p.Id) && p.Ativo)
                .ToListAsync();

            var permissoesInvalidas = permissoesIds.Except(permissoesValidas.Select(p => p.Id)).ToList();
            if (permissoesInvalidas.Any())
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Permiss√µes inv√°lidas",
                    Mensagem = $"Permiss√µes n√£o encontradas ou inativas: {string.Join(", ", permissoesInvalidas)}"
                });
            }

            // ‚úÖ REMOVER TODAS AS ASSOCIA√á√ïES ATUAIS (SOFT DELETE)
            var associacoesAtuais = await _context.PapelPermissoes
                .Where(pp => pp.PapelId == papelId && pp.Ativo)
                .ToListAsync();

            foreach (var associacao in associacoesAtuais)
            {
                associacao.Ativo = false;
            }

            // ‚úÖ CRIAR NOVAS ASSOCIA√á√ïES
            var novasAssociacoes = new List<PapelPermissao>();
            foreach (var permissaoId in permissoesIds)
            {
                // Verificar se j√° existe associa√ß√£o inativa para reativar
                var associacaoExistente = await _context.PapelPermissoes
                    .FirstOrDefaultAsync(pp => pp.PapelId == papelId && pp.PermissaoId == permissaoId);

                if (associacaoExistente != null)
                {
                    associacaoExistente.Ativo = true;
                    associacaoExistente.DataAtribuicao = DateTime.UtcNow;
                }
                else
                {
                    novasAssociacoes.Add(new PapelPermissao
                    {
                        PapelId = papelId,
                        PermissaoId = permissaoId,
                        DataAtribuicao = DateTime.UtcNow,
                        Ativo = true
                    });
                }
            }

            _context.PapelPermissoes.AddRange(novasAssociacoes);
            await _context.SaveChangesAsync();

            // ‚úÖ RETORNAR LISTA ATUALIZADA
            var permissoesAtualizadas = await _context.PapelPermissoes
                .Include(pp => pp.Permissao)
                .Where(pp => pp.PapelId == papelId && pp.Ativo)
                .Select(pp => new PermissaoDetalhada
                {
                    Id = pp.Permissao.Id,
                    Nome = pp.Permissao.Nome,
                    Categoria = pp.Permissao.Categoria,
                    DataAtribuicao = pp.DataAtribuicao,
                    Ativo = pp.Ativo,
                    OutrosPapeisComPermissao = _context.PapelPermissoes
                        .Count(x => x.PermissaoId == pp.PermissaoId && x.PapelId != papelId && x.Ativo)
                })
                .ToListAsync();

            _logger.LogInformation("‚úÖ Permiss√µes substitu√≠das: papel {PapelNome} agora tem {Total} permiss√µes",
                papel.Name, permissoesAtualizadas.Count);

            return Ok(permissoesAtualizadas);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao substituir permiss√µes do papel {PapelId}", papelId);
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao substituir permiss√µes do papel"
            });
        }
    }

    /// <summary>
    /// Gera relat√≥rio completo do sistema de permiss√µes por pap√©is
    /// </summary>
    /// <param name="incluirEstatisticas">Incluir estat√≠sticas detalhadas</param>
    /// <param name="incluirComparacoes">Incluir compara√ß√µes entre pap√©is</param>
    /// <returns>Relat√≥rio completo do sistema</returns>
    [HttpGet("relatorio/sistema")]
    [ProducesResponseType(typeof(RelatorioCompletoSistema), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> GerarRelatorioCompleto(
        [FromQuery] bool incluirEstatisticas = true,
        [FromQuery] bool incluirComparacoes = true)
    {
        if (!TemPermissao("Sistema.Controle.Total") && !TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para gerar relat√≥rios completos do sistema" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üìä Usuario {UsuarioId} gerando relat√≥rio completo do sistema", usuarioLogadoId);

            var inicioProcessamento = DateTime.UtcNow;

            // ‚úÖ DADOS B√ÅSICOS DO SISTEMA
            var totalPapeis = await _context.Papeis.CountAsync();
            var papeisAtivos = await _context.Papeis.CountAsync(p => p.Ativo);
            var totalPermissoes = await _context.Permissoes.CountAsync();
            var permissoesAtivas = await _context.Permissoes.CountAsync(p => p.Ativo);
            var totalAssociacoes = await _context.PapelPermissoes.CountAsync();
            var associacoesAtivas = await _context.PapelPermissoes.CountAsync(pp => pp.Ativo);

            // ‚úÖ ESTAT√çSTICAS POR PAPEL
            var estatisticasPorPapel = await _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Where(pp => pp.Ativo && pp.Papel.Ativo)
                .GroupBy(pp => new { pp.PapelId, pp.Papel.Name, pp.Papel.Categoria })
                .Select(g => new EstatisticaPapel
                {
                    PapelId = g.Key.PapelId,
                    PapelNome = g.Key.Name ?? "N/A",
                    Categoria = g.Key.Categoria,
                    TotalPermissoes = g.Count(),
                    TotalUsuarios = _context.UsuarioPapeis.Count(up => up.PapelId == g.Key.PapelId && up.Ativo)
                })
                .OrderByDescending(e => e.TotalPermissoes)
                .ToListAsync();

            // ‚úÖ ESTAT√çSTICAS POR PERMISS√ÉO
            var estatisticasPorPermissao = await _context.PapelPermissoes
                .Include(pp => pp.Permissao)
                .Where(pp => pp.Ativo && pp.Permissao.Ativo)
                .GroupBy(pp => new { pp.PermissaoId, pp.Permissao.Nome, pp.Permissao.Categoria })
                .Select(g => new EstatisticaPermissao
                {
                    PermissaoId = g.Key.PermissaoId,
                    PermissaoNome = g.Key.Nome,
                    Categoria = g.Key.Categoria,
                    TotalPapeis = g.Count()
                })
                .OrderByDescending(e => e.TotalPapeis)
                .ToListAsync();

            // ‚úÖ DISTRIBUI√á√ÉO POR CATEGORIA
            var distribuicaoCategorias = await _context.PapelPermissoes
                .Include(pp => pp.Permissao)
                .Where(pp => pp.Ativo && pp.Permissao.Ativo)
                .GroupBy(pp => pp.Permissao.Categoria ?? "Sem Categoria")
                .Select(g => new DistribuicaoCategoria
                {
                    Categoria = g.Key,
                    TotalAssociacoes = g.Count(),
                    TotalPermissoes = g.Select(pp => pp.PermissaoId).Distinct().Count(),
                    TotalPapeis = g.Select(pp => pp.PapelId).Distinct().Count()
                })
                .OrderByDescending(d => d.TotalAssociacoes)
                .ToListAsync();

            var relatorio = new RelatorioCompletoSistema
            {
                ResumoGeral = new ResumoGeral
                {
                    TotalPapeis = totalPapeis,
                    PapeisAtivos = papeisAtivos,
                    TotalPermissoes = totalPermissoes,
                    PermissoesAtivas = permissoesAtivas,
                    TotalAssociacoes = totalAssociacoes,
                    AssociacoesAtivas = associacoesAtivas,
                    DataGeracao = DateTime.UtcNow,
                    TempoProcessamento = DateTime.UtcNow - inicioProcessamento
                },
                EstatisticasPorPapel = estatisticasPorPapel,
                EstatisticasPorPermissao = estatisticasPorPermissao.Take(20).ToList(), // Top 20
                DistribuicaoCategorias = distribuicaoCategorias
            };

            // ‚úÖ INCLUIR ESTAT√çSTICAS AVAN√áADAS SE SOLICITADO
            if (incluirEstatisticas)
            {
                relatorio.EstatisticasAvancadas = await GerarEstatisticasAvancadas();
            }

            // ‚úÖ INCLUIR COMPARA√á√ïES SE SOLICITADO
            if (incluirComparacoes)
            {
                relatorio.Comparacoes = await GerarComparacoesSistema();
            }

            relatorio.ResumoGeral.TempoProcessamento = DateTime.UtcNow - inicioProcessamento;

            _logger.LogInformation("‚úÖ Relat√≥rio completo gerado em {Tempo}ms",
                relatorio.ResumoGeral.TempoProcessamento.TotalMilliseconds);

            return Ok(relatorio);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao gerar relat√≥rio completo do sistema");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao gerar relat√≥rio completo do sistema"
            });
        }
    }

    /// <summary>
    /// Compara permiss√µes entre m√∫ltiplos pap√©is
    /// </summary>
    /// <param name="papeisIds">Lista de IDs dos pap√©is para compara√ß√£o</param>
    /// <param name="mostrarApenasConflitos">Mostrar apenas diferen√ßas</param>
    /// <returns>Compara√ß√£o detalhada entre pap√©is</returns>
    [HttpPost("comparar-papeis")]
    [ProducesResponseType(typeof(ComparacaoMultiplosPapeis), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> CompararPapeis([FromBody] List<int> papeisIds, [FromQuery] bool mostrarApenasConflitos = false)
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para comparar pap√©is" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üîç Usuario {UsuarioId} comparando pap√©is: {PapeisIds}",
                usuarioLogadoId, string.Join(", ", papeisIds));

            // ‚úÖ VALIDAR ENTRADA
            if (papeisIds == null || papeisIds.Count < 2)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Dados insuficientes",
                    Mensagem = "√â necess√°rio pelo menos 2 pap√©is para compara√ß√£o"
                });
            }

            if (papeisIds.Count > 10)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Muitos pap√©is",
                    Mensagem = "M√°ximo de 10 pap√©is para compara√ß√£o simult√¢nea"
                });
            }

            // ‚úÖ VERIFICAR SE PAP√âIS EXISTEM
            var papeis = await _context.Papeis
                .Where(p => papeisIds.Contains(p.Id))
                .ToListAsync();

            var papeisNaoEncontrados = papeisIds.Except(papeis.Select(p => p.Id)).ToList();
            if (papeisNaoEncontrados.Any())
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "Pap√©is n√£o encontrados",
                    Mensagem = $"Pap√©is n√£o encontrados: {string.Join(", ", papeisNaoEncontrados)}"
                });
            }

            // ‚úÖ OBTER PERMISS√ïES DE CADA PAPEL
            var permissoesPorPapel = new Dictionary<int, List<PermissaoDetalhada>>();

            foreach (var papel in papeis)
            {
                var permissoes = await _context.PapelPermissoes
                    .Include(pp => pp.Permissao)
                    .Where(pp => pp.PapelId == papel.Id && pp.Ativo)
                    .Select(pp => new PermissaoDetalhada
                    {
                        Id = pp.Permissao.Id,
                        Nome = pp.Permissao.Nome,
                        Categoria = pp.Permissao.Categoria,
                        DataAtribuicao = pp.DataAtribuicao,
                        Ativo = pp.Ativo
                    })
                    .ToListAsync();

                permissoesPorPapel[papel.Id] = permissoes;
            }

            // ‚úÖ AN√ÅLISE DE COMPARA√á√ÉO
            var todasPermissoes = permissoesPorPapel.Values
                .SelectMany(p => p)
                .GroupBy(p => p.Id)
                .ToList();

            var permissoesComuns = todasPermissoes
                .Where(g => g.Count() == papeis.Count)
                .Select(g => g.First())
                .ToList();

            var permissoesExclusivas = new Dictionary<int, List<PermissaoDetalhada>>();
            foreach (var papel in papeis)
            {
                var exclusivas = permissoesPorPapel[papel.Id]
                    .Where(p => !permissoesComuns.Any(pc => pc.Id == p.Id))
                    .ToList();
                permissoesExclusivas[papel.Id] = exclusivas;
            }

            var permissoesParciais = todasPermissoes
                .Where(g => g.Count() > 1 && g.Count() < papeis.Count)
                .Select(g => new PermissaoParcial
                {
                    Permissao = g.First(),
                    PapeisQuetem = g.Select(p => papeis.First(papel =>
                        permissoesPorPapel[papel.Id].Any(perm => perm.Id == p.Id)).Name ?? "N/A").ToList()
                })
                .ToList();

            // ‚úÖ CONSTRUIR RESULTADO
            var comparacao = new ComparacaoMultiplosPapeis
            {
                PapeisComparados = papeis.Select(p => new PapelResumoRelatorio
                {
                    Id = p.Id,
                    Nome = p.Name ?? "N/A",
                    Descricao = p.Descricao,
                    Categoria = p.Categoria,
                    Nivel = p.Nivel,
                    Ativo = p.Ativo
                }).ToList(),
                PermissoesComuns = mostrarApenasConflitos ? new() : permissoesComuns,
                PermissoesExclusivas = permissoesExclusivas,
                PermissoesParciais = permissoesParciais,
                Estatisticas = new EstatisticasComparacao
                {
                    TotalPermissoesComuns = permissoesComuns.Count,
                    TotalPermissoesExclusivas = permissoesExclusivas.Values.Sum(list => list.Count),
                    TotalPermissoesParciais = permissoesParciais.Count,
                    PapelComMaisPermissoes = papeis.OrderByDescending(p => permissoesPorPapel[p.Id].Count).First().Name ?? "N/A",
                    PapelComMenosPermissoes = papeis.OrderBy(p => permissoesPorPapel[p.Id].Count).First().Name ?? "N/A"
                },
                DataComparacao = DateTime.UtcNow
            };

            _logger.LogInformation("‚úÖ Compara√ß√£o conclu√≠da: {Comuns} comuns, {Exclusivas} exclusivas, {Parciais} parciais",
                permissoesComuns.Count,
                permissoesExclusivas.Values.Sum(list => list.Count),
                permissoesParciais.Count);

            return Ok(comparacao);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao comparar pap√©is");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao comparar pap√©is"
            });
        }
    }

    /// <summary>
    /// Identifica permiss√µes √≥rf√£s e dados inconsistentes no sistema
    /// </summary>
    /// <param name="executarLimpeza">Se true, executa limpeza autom√°tica dos dados √≥rf√£os</param>
    /// <returns>Relat√≥rio de permiss√µes √≥rf√£s e inconsist√™ncias</returns>
    [HttpGet("orphans")]
    [ProducesResponseType(typeof(RelatorioPermissoesOrfas), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> IdentificarPermissoesOrfas([FromQuery] bool executarLimpeza = false)
    {
        if (!TemPermissao("Sistema.Controle.Total"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para identificar permiss√µes √≥rf√£s - requer controle total do sistema" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üßπ Usuario {UsuarioId} identificando permiss√µes √≥rf√£s", usuarioLogadoId);

            // ‚úÖ IDENTIFICAR ASSOCIA√á√ïES COM PAP√âIS INATIVOS
            var associacoesComPapeisInativos = await _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Include(pp => pp.Permissao)
                .Where(pp => pp.Ativo && !pp.Papel.Ativo)
                .Select(pp => new AssociacaoOrfa
                {
                    PapelId = pp.PapelId,
                    PapelNome = pp.Papel.Name ?? "N/A",
                    PermissaoId = pp.PermissaoId,
                    PermissaoNome = pp.Permissao.Nome,
                    TipoProblema = "Papel Inativo",
                    DataAtribuicao = pp.DataAtribuicao
                })
                .ToListAsync();

            // ‚úÖ IDENTIFICAR ASSOCIA√á√ïES COM PERMISS√ïES INATIVAS
            var associacoesComPermissoesInativas = await _context.PapelPermissoes
                .Include(pp => pp.Papel)
                .Include(pp => pp.Permissao)
                .Where(pp => pp.Ativo && !pp.Permissao.Ativo)
                .Select(pp => new AssociacaoOrfa
                {
                    PapelId = pp.PapelId,
                    PapelNome = pp.Papel.Name ?? "N/A",
                    PermissaoId = pp.PermissaoId,
                    PermissaoNome = pp.Permissao.Nome,
                    TipoProblema = "Permiss√£o Inativa",
                    DataAtribuicao = pp.DataAtribuicao
                })
                .ToListAsync();

            // ‚úÖ IDENTIFICAR PERMISS√ïES NUNCA ATRIBU√çDAS
            var permissoesNuncaAtribuidas = await _context.Permissoes
                .Where(p => p.Ativo && !_context.PapelPermissoes.Any(pp => pp.PermissaoId == p.Id && pp.Ativo))
                .Select(p => new PermissaoNaoUtilizada
                {
                    Id = p.Id,
                    Nome = p.Nome,
                    Descricao = p.Descricao,
                    Categoria = p.Categoria,
                    DataCriacao = p.DataCriacao,
                    DiasDesdeUltimoUso = (DateTime.UtcNow - p.DataCriacao).Days
                })
                .ToListAsync();

            // ‚úÖ IDENTIFICAR PAP√âIS SEM PERMISS√ïES
            var papeisSemPermissoes = await _context.Papeis
                .Where(p => p.Ativo && !_context.PapelPermissoes.Any(pp => pp.PapelId == p.Id && pp.Ativo))
                .Select(p => new PapelSemPermissoes
                {
                    Id = p.Id,
                    Nome = p.Name ?? "N/A",
                    Descricao = p.Descricao,
                    Categoria = p.Categoria,
                    DataCriacao = p.DataCriacao,
                    TotalUsuarios = _context.UsuarioPapeis.Count(up => up.PapelId == p.Id && up.Ativo)
                })
                .ToListAsync();

            var relatorio = new RelatorioPermissoesOrfas
            {
                AssociacoesComPapeisInativos = associacoesComPapeisInativos,
                AssociacoesComPermissoesInativas = associacoesComPermissoesInativas,
                PermissoesNuncaAtribuidas = permissoesNuncaAtribuidas,
                PapeisSemPermissoes = papeisSemPermissoes,
                Resumo = new ResumoLimpeza
                {
                    TotalAssociacoesComPapeisInativos = associacoesComPapeisInativos.Count,
                    TotalAssociacoesComPermissoesInativas = associacoesComPermissoesInativas.Count,
                    TotalPermissoesNaoUtilizadas = permissoesNuncaAtribuidas.Count,
                    TotalPapeisSemPermissoes = papeisSemPermissoes.Count,
                    LimpezaExecutada = false,
                    DataAnalise = DateTime.UtcNow
                }
            };

            // ‚úÖ EXECUTAR LIMPEZA SE SOLICITADO
            if (executarLimpeza && (associacoesComPapeisInativos.Any() || associacoesComPermissoesInativas.Any()))
            {
                var resultadoLimpeza = await ExecutarLimpezaOrfas(associacoesComPapeisInativos, associacoesComPermissoesInativas);
                relatorio.Resumo.LimpezaExecutada = true;
                relatorio.Resumo.ItensLimpos = resultadoLimpeza.ItensLimpos;
                relatorio.Resumo.ErrosLimpeza = resultadoLimpeza.Erros;
            }

            _logger.LogInformation("‚úÖ An√°lise de √≥rf√£s conclu√≠da: {Papeis} pap√©is inativos, {Permissoes} permiss√µes inativas, {NaoUtilizadas} n√£o utilizadas",
                associacoesComPapeisInativos.Count,
                associacoesComPermissoesInativas.Count,
                permissoesNuncaAtribuidas.Count);

            return Ok(relatorio);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao identificar permiss√µes √≥rf√£s");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao identificar permiss√µes √≥rf√£s"
            });
        }
    }

    /// <summary>
    /// Gera estat√≠sticas detalhadas do sistema de permiss√µes
    /// </summary>
    /// <param name="periodo">Per√≠odo para an√°lise: ultimos7dias, ultimos30dias, ultimos90dias, todos</param>
    /// <returns>Estat√≠sticas detalhadas do sistema</returns>
    [HttpGet("estatisticas")]
    [ProducesResponseType(typeof(EstatisticasDetalhadas), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ObterEstatisticasDetalhadas([FromQuery] string periodo = "todos")
    {
        if (!TemPermissao("Papeis.GerenciarPermissoes") && !TemPermissao("Sistema.Controle.Total"))
        {
            return StatusCode(403, new RespostaErro 
            { 
                Erro = "Acesso negado", 
                Mensagem = "Acesso negado para visualizar estat√≠sticas detalhadas" 
            });
        }

        try
        {
            var usuarioLogadoId = ObterUsuarioLogadoId();
            _logger.LogInformation("üìà Usuario {UsuarioId} obtendo estat√≠sticas detalhadas - per√≠odo: {Periodo}",
                usuarioLogadoId, periodo);

            // ‚úÖ CALCULAR DATA DE IN√çCIO BASEADA NO PER√çODO
            var dataInicio = CalcularDataInicioPeriodo(periodo);

            // ‚úÖ ESTAT√çSTICAS GERAIS
            var estatisticasGerais = await GerarEstatisticasGerais(dataInicio);

            // ‚úÖ TEND√äNCIAS TEMPORAIS
            var tendencias = await GerarTendenciasTempo(dataInicio);

            // ‚úÖ DISTRIBUI√á√ïES
            var distribuicoes = await GerarDistribuicoes();

            // ‚úÖ TOP RANKINGS
            var rankings = await GerarRankings();

            var estatisticas = new EstatisticasDetalhadas
            {
                Periodo = periodo,
                DataInicio = dataInicio,
                DataFim = DateTime.UtcNow,
                EstatisticasGerais = estatisticasGerais,
                Tendencias = tendencias,
                Distribuicoes = distribuicoes,
                Rankings = rankings,
                DataGeracao = DateTime.UtcNow
            };

            _logger.LogInformation("‚úÖ Estat√≠sticas detalhadas geradas para per√≠odo: {Periodo}", periodo);

            return Ok(estatisticas);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao gerar estat√≠sticas detalhadas");
            return StatusCode(500, new RespostaErro
            {
                Erro = "Erro interno",
                Mensagem = "Erro ao gerar estat√≠sticas detalhadas"
            });
        }
    }

    #region M√©todos Auxiliares

    /// <summary>
    /// Aplica filtros √† query de associa√ß√µes papel-permiss√£o
    /// </summary>
    private IQueryable<PapelPermissao> AplicarFiltros(IQueryable<PapelPermissao> query, FiltrosAssociacoes filtros)
    {
        // ‚úÖ FILTRO POR IDS DE PAP√âIS
        if (filtros.PapeisIds?.Any() == true)
        {
            query = query.Where(pp => filtros.PapeisIds.Contains(pp.PapelId));
        }

        // ‚úÖ FILTRO POR IDS DE PERMISS√ïES
        if (filtros.PermissoesIds?.Any() == true)
        {
            query = query.Where(pp => filtros.PermissoesIds.Contains(pp.PermissaoId));
        }

        // ‚úÖ FILTRO POR CATEGORIA DO PAPEL
        if (!string.IsNullOrEmpty(filtros.CategoriaPapel))
        {
            query = query.Where(pp => pp.Papel.Categoria != null &&
                pp.Papel.Categoria.ToLower().Contains(filtros.CategoriaPapel.ToLower()));
        }

        // ‚úÖ FILTRO POR CATEGORIA DA PERMISS√ÉO
        if (!string.IsNullOrEmpty(filtros.CategoriaPermissao))
        {
            query = query.Where(pp => pp.Permissao.Categoria != null &&
                pp.Permissao.Categoria.ToLower().Contains(filtros.CategoriaPermissao.ToLower()));
        }

        // ‚úÖ FILTRO POR STATUS ATIVO/INATIVO
        if (filtros.Ativo.HasValue)
        {
            query = query.Where(pp => pp.Ativo == filtros.Ativo.Value);
        }

        // ‚úÖ FILTRO POR PER√çODO DE ATRIBUI√á√ÉO
        if (filtros.DataAtribuicaoInicio.HasValue)
        {
            query = query.Where(pp => pp.DataAtribuicao >= filtros.DataAtribuicaoInicio.Value);
        }

        if (filtros.DataAtribuicaoFim.HasValue)
        {
            query = query.Where(pp => pp.DataAtribuicao <= filtros.DataAtribuicaoFim.Value);
        }

        // ‚úÖ FILTRO POR ASSOCIA√á√ïES √ìRF√ÉS
        if (filtros.ApenasAssociacoesOrfas)
        {
            query = query.Where(pp => !pp.Papel.Ativo || !pp.Permissao.Ativo);
        }

        // ‚úÖ INCLUIR INATIVOS (da classe base)
        if (!filtros.IncluirInativos)
        {
            query = query.Where(pp => pp.Ativo && pp.Papel.Ativo && pp.Permissao.Ativo);
        }

        return query;
    }

    /// <summary>
    /// Aplica ordena√ß√£o √† query de associa√ß√µes
    /// </summary>
    private IQueryable<PapelPermissao> AplicarOrdenacao(IQueryable<PapelPermissao> query, string? ordenarPor, string? direcao)
    {
        var isDesc = !string.IsNullOrEmpty(direcao) && direcao.ToLower() == "desc";

        return ordenarPor?.ToLower() switch
        {
            "papel" => isDesc ? query.OrderByDescending(pp => pp.Papel.Name)
                              : query.OrderBy(pp => pp.Papel.Name),
            "permissao" => isDesc ? query.OrderByDescending(pp => pp.Permissao.Nome)
                                  : query.OrderBy(pp => pp.Permissao.Nome),
            "dataatribuicao" => isDesc ? query.OrderByDescending(pp => pp.DataAtribuicao)
                                       : query.OrderBy(pp => pp.DataAtribuicao),
            "ativo" => isDesc ? query.OrderByDescending(pp => pp.Ativo)
                              : query.OrderBy(pp => pp.Ativo),
            "categoriapapel" => isDesc ? query.OrderByDescending(pp => pp.Papel.Categoria)
                                       : query.OrderBy(pp => pp.Papel.Categoria),
            "categoriapermissao" => isDesc ? query.OrderByDescending(pp => pp.Permissao.Categoria)
                                           : query.OrderBy(pp => pp.Permissao.Categoria),
            _ => query.OrderBy(pp => pp.Papel.Name).ThenBy(pp => pp.Permissao.Nome) // Ordena√ß√£o padr√£o
        };
    }

    /// <summary>
    /// Gera dados de compara√ß√£o entre pap√©is
    /// </summary>
    private async Task<ComparacaoPapeis> GerarComparacaoPapeis(int papelId)
    {
        // ‚úÖ ESTAT√çSTICAS GERAIS DE PERMISS√ïES POR PAPEL
        var estatisticasPapeis = await _context.PapelPermissoes
            .Where(pp => pp.Ativo && pp.Papel.Ativo)
            .GroupBy(pp => new { pp.PapelId, pp.Papel.Name })
            .Select(g => new { PapelId = g.Key.PapelId, PapelNome = g.Key.Name, TotalPermissoes = g.Count() })
            .OrderByDescending(x => x.TotalPermissoes)
            .ToListAsync();

        if (!estatisticasPapeis.Any())
        {
            return new ComparacaoPapeis();
        }

        var papelAtual = estatisticasPapeis.FirstOrDefault(x => x.PapelId == papelId);
        var posicaoAtual = estatisticasPapeis.FindIndex(x => x.PapelId == papelId) + 1;

        return new ComparacaoPapeis
        {
            PapelComMaisPermissoes = estatisticasPapeis.First().PapelNome,
            PapelComMenosPermissoes = estatisticasPapeis.Last().PapelNome,
            PosicaoRanking = posicaoAtual,
            MediaPermissoesPorPapel = (decimal)estatisticasPapeis.Average(x => x.TotalPermissoes)
        };
    }

    /// <summary>
    /// Verifica se o usu√°rio logado tem uma permiss√£o espec√≠fica
    /// </summary>
    private bool TemPermissao(string permissao)
    {
        try
        {
            // ‚úÖ M√âTODO 1: Verificar claims de permiss√£o
            var permissaoClaim = User.FindAll("permissao")
                .Any(c => c.Value == permissao);

            if (permissaoClaim)
            {
                _logger.LogInformation("‚úÖ Permiss√£o '{Permissao}' encontrada via claim", permissao);
                return true;
            }

            // ‚úÖ M√âTODO 2: Verificar se √© SuperAdmin (controle total)
            var isSuperAdmin = User.IsInRole("SuperAdmin");
            if (isSuperAdmin)
            {
                _logger.LogInformation("‚úÖ Usu√°rio √© SuperAdmin - acesso liberado para '{Permissao}'", permissao);
                return true;
            }

            // ‚úÖ M√âTODO 3: Verificar controle total do sistema
            var hasSystemControl = User.FindAll("permissao")
                .Any(c => c.Value == "Sistema.Controle.Total");

            if (hasSystemControl)
            {
                _logger.LogInformation("‚úÖ Usu√°rio tem Sistema.Controle.Total - acesso liberado para '{Permissao}'", permissao);
                return true;
            }

            _logger.LogWarning("‚ùå Permiss√£o '{Permissao}' negada. Usu√°rio: {Usuario}, Pap√©is: [{Papeis}], Permiss√µes: [{Permissoes}]", 
                permissao,
                User.Identity?.Name ?? "Desconhecido",
                string.Join(", ", User.FindAll("role").Select(c => c.Value)),
                string.Join(", ", User.FindAll("permissao").Select(c => c.Value).Take(5))
            );

            return false;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao verificar permiss√£o '{Permissao}'", permissao);
            return false;
        }
    }

    /// <summary>
    /// Obt√©m ID do usu√°rio logado
    /// </summary>
    private int ObterUsuarioLogadoId()
    {
        var userIdClaim = User.FindFirst("sub") ?? User.FindFirst("user_id") ?? User.FindFirst("id");
        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
        {
            return userId;
        }

        _logger.LogWarning("‚ö†Ô∏è N√£o foi poss√≠vel obter ID do usu√°rio logado");
        return 0;
    }

    #endregion

    #region M√©todos Auxiliares de Opera√ß√µes em Lote

    /// <summary>
    /// Executa associa√ß√£o em lote
    /// </summary>
    private async Task<RespostaAssociacaoLote> ExecutarAssociacaoEmLote(List<Papel> papeis, List<Permissao> permissoes)
    {
        var detalhes = new List<DetalheOperacao>();
        int sucessos = 0;

        foreach (var papel in papeis)
        {
            foreach (var permissao in permissoes)
            {
                try
                {
                    // Verificar se associa√ß√£o j√° existe
                    var existente = await _context.PapelPermissoes
                        .FirstOrDefaultAsync(pp => pp.PapelId == papel.Id && pp.PermissaoId == permissao.Id);

                    if (existente != null && existente.Ativo)
                    {
                        detalhes.Add(new DetalheOperacao
                        {
                            PapelId = papel.Id,
                            PermissaoId = permissao.Id,
                            Sucesso = false,
                            Erro = "Associa√ß√£o j√° existe"
                        });
                        continue;
                    }

                    if (existente != null && !existente.Ativo)
                    {
                        // Reativar associa√ß√£o existente
                        existente.Ativo = true;
                        existente.DataAtribuicao = DateTime.UtcNow;
                    }
                    else
                    {
                        // Criar nova associa√ß√£o
                        _context.PapelPermissoes.Add(new PapelPermissao
                        {
                            PapelId = papel.Id,
                            PermissaoId = permissao.Id,
                            DataAtribuicao = DateTime.UtcNow,
                            Ativo = true
                        });
                    }

                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = true
                    });
                    sucessos++;
                }
                catch (Exception ex)
                {
                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = false,
                        Erro = ex.Message
                    });
                }
            }
        }

        await _context.SaveChangesAsync();

        return new RespostaAssociacaoLote
        {
            Sucesso = sucessos > 0,
            TotalProcessadas = detalhes.Count,
            TotalSucessos = sucessos,
            TotalFalhas = detalhes.Count - sucessos,
            Detalhes = detalhes
        };
    }

    /// <summary>
    /// Executa dissocia√ß√£o em lote
    /// </summary>
    private async Task<RespostaAssociacaoLote> ExecutarDissociacaoEmLote(List<Papel> papeis, List<Permissao> permissoes)
    {
        var detalhes = new List<DetalheOperacao>();
        int sucessos = 0;

        foreach (var papel in papeis)
        {
            foreach (var permissao in permissoes)
            {
                try
                {
                    var associacao = await _context.PapelPermissoes
                        .FirstOrDefaultAsync(pp => pp.PapelId == papel.Id && pp.PermissaoId == permissao.Id && pp.Ativo);

                    if (associacao == null)
                    {
                        detalhes.Add(new DetalheOperacao
                        {
                            PapelId = papel.Id,
                            PermissaoId = permissao.Id,
                            Sucesso = false,
                            Erro = "Associa√ß√£o n√£o encontrada"
                        });
                        continue;
                    }

                    associacao.Ativo = false;
                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = true
                    });
                    sucessos++;
                }
                catch (Exception ex)
                {
                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = false,
                        Erro = ex.Message
                    });
                }
            }
        }

        await _context.SaveChangesAsync();

        return new RespostaAssociacaoLote
        {
            Sucesso = sucessos > 0,
            TotalProcessadas = detalhes.Count,
            TotalSucessos = sucessos,
            TotalFalhas = detalhes.Count - sucessos,
            Detalhes = detalhes
        };
    }

    /// <summary>
    /// Executa substitui√ß√£o em lote
    /// </summary>
    private async Task<RespostaAssociacaoLote> ExecutarSubstituicaoEmLote(List<Papel> papeis, List<Permissao> permissoes)
    {
        var detalhes = new List<DetalheOperacao>();
        int sucessos = 0;

        foreach (var papel in papeis)
        {
            try
            {
                // Desativar todas as associa√ß√µes atuais do papel
                var associacoesAtuais = await _context.PapelPermissoes
                    .Where(pp => pp.PapelId == papel.Id && pp.Ativo)
                    .ToListAsync();

                foreach (var associacao in associacoesAtuais)
                {
                    associacao.Ativo = false;
                }

                // Criar/reativar associa√ß√µes com as novas permiss√µes
                foreach (var permissao in permissoes)
                {
                    var associacaoExistente = await _context.PapelPermissoes
                        .FirstOrDefaultAsync(pp => pp.PapelId == papel.Id && pp.PermissaoId == permissao.Id);

                    if (associacaoExistente != null)
                    {
                        associacaoExistente.Ativo = true;
                        associacaoExistente.DataAtribuicao = DateTime.UtcNow;
                    }
                    else
                    {
                        _context.PapelPermissoes.Add(new PapelPermissao
                        {
                            PapelId = papel.Id,
                            PermissaoId = permissao.Id,
                            DataAtribuicao = DateTime.UtcNow,
                            Ativo = true
                        });
                    }

                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = true
                    });
                    sucessos++;
                }
            }
            catch (Exception ex)
            {
                foreach (var permissao in permissoes)
                {
                    detalhes.Add(new DetalheOperacao
                    {
                        PapelId = papel.Id,
                        PermissaoId = permissao.Id,
                        Sucesso = false,
                        Erro = ex.Message
                    });
                }
            }
        }

        await _context.SaveChangesAsync();

        return new RespostaAssociacaoLote
        {
            Sucesso = sucessos > 0,
            TotalProcessadas = detalhes.Count,
            TotalSucessos = sucessos,
            TotalFalhas = detalhes.Count - sucessos,
            Detalhes = detalhes
        };
    }

    #endregion

    #region M√©todos Auxiliares de An√°lise Avan√ßada

    /// <summary>
    /// Gera estat√≠sticas avan√ßadas do sistema
    /// </summary>
    private async Task<EstatisticasAvancadas> GerarEstatisticasAvancadas()
    {
        // Complexidade m√©dia de pap√©is (n√∫mero m√©dio de permiss√µes por papel)
        var complexidadeMedia = await _context.PapelPermissoes
            .Where(pp => pp.Ativo)
            .GroupBy(pp => pp.PapelId)
            .Select(g => g.Count())
            .DefaultIfEmpty(0)
            .AverageAsync();

        // Cobertura de permiss√µes (percentual de permiss√µes em uso)
        var totalPermissoes = await _context.Permissoes.CountAsync(p => p.Ativo);
        var permissoesEmUso = await _context.PapelPermissoes
            .Where(pp => pp.Ativo)
            .Select(pp => pp.PermissaoId)
            .Distinct()
            .CountAsync();

        var coberturaPermissoes = totalPermissoes > 0 ? (decimal)permissoesEmUso / totalPermissoes * 100 : 0;

        // Redund√¢ncia de pap√©is (permiss√µes que aparecem em muitos pap√©is)
        var redundanciaMedia = await _context.PapelPermissoes
            .Where(pp => pp.Ativo)
            .GroupBy(pp => pp.PermissaoId)
            .Select(g => g.Count())
            .DefaultIfEmpty(0)
            .AverageAsync();

        return new EstatisticasAvancadas
        {
            ComplexidadeMediaPapeis = Math.Round(complexidadeMedia, 2),
            CoberturaPermissoes = Math.Round(coberturaPermissoes, 2),
            RedundanciaMediaPermissoes = Math.Round(redundanciaMedia, 2),
            TaxaUtilizacaoSistema = Math.Round(coberturaPermissoes * (decimal)redundanciaMedia / 100, 2)
        };
    }

    /// <summary>
    /// Gera compara√ß√µes do sistema
    /// </summary>
    private async Task<ComparacoesSistema> GerarComparacoesSistema()
    {
        var papeisMaisComplexos = await _context.PapelPermissoes
            .Include(pp => pp.Papel)
            .Where(pp => pp.Ativo && pp.Papel.Ativo)
            .GroupBy(pp => new { pp.PapelId, pp.Papel.Name })
            .Select(g => new { PapelId = g.Key.PapelId, Nome = g.Key.Name, TotalPermissoes = g.Count() })
            .OrderByDescending(x => x.TotalPermissoes)
            .Take(5)
            .ToListAsync();

        var permissoesMaisUsadas = await _context.PapelPermissoes
            .Include(pp => pp.Permissao)
            .Where(pp => pp.Ativo && pp.Permissao.Ativo)
            .GroupBy(pp => new { pp.PermissaoId, pp.Permissao.Nome })
            .Select(g => new { PermissaoId = g.Key.PermissaoId, Nome = g.Key.Nome, TotalPapeis = g.Count() })
            .OrderByDescending(x => x.TotalPapeis)
            .Take(5)
            .ToListAsync();

        return new ComparacoesSistema
        {
            PapeisMaisComplexos = papeisMaisComplexos.Select(p => $"{p.Nome} ({p.TotalPermissoes} permiss√µes)").ToList(),
            PermissoesMaisUsadas = permissoesMaisUsadas.Select(p => $"{p.Nome} ({p.TotalPapeis} pap√©is)").ToList()
        };
    }

    /// <summary>
    /// Executa limpeza de dados √≥rf√£os
    /// </summary>
    private async Task<ResultadoLimpeza> ExecutarLimpezaOrfas(
        List<AssociacaoOrfa> associacoesComPapeisInativos, 
        List<AssociacaoOrfa> associacoesComPermissoesInativas)
    {
        var itensLimpos = 0;
        var erros = new List<string>();

        try
        {
            // Desativar associa√ß√µes com pap√©is inativos
            foreach (var associacao in associacoesComPapeisInativos)
            {
                var pp = await _context.PapelPermissoes
                    .FirstOrDefaultAsync(x => x.PapelId == associacao.PapelId && x.PermissaoId == associacao.PermissaoId);
                
                if (pp != null && pp.Ativo)
                {
                    pp.Ativo = false;
                    itensLimpos++;
                }
            }

            // Desativar associa√ß√µes com permiss√µes inativas
            foreach (var associacao in associacoesComPermissoesInativas)
            {
                var pp = await _context.PapelPermissoes
                    .FirstOrDefaultAsync(x => x.PapelId == associacao.PapelId && x.PermissaoId == associacao.PermissaoId);
                
                if (pp != null && pp.Ativo)
                {
                    pp.Ativo = false;
                    itensLimpos++;
                }
            }

            await _context.SaveChangesAsync();

            _logger.LogInformation("üßπ Limpeza executada: {ItensLimpos} itens limpos", itensLimpos);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro durante limpeza de √≥rf√£s");
            erros.Add($"Erro durante limpeza: {ex.Message}");
        }

        return new ResultadoLimpeza { ItensLimpos = itensLimpos, Erros = erros };
    }

    /// <summary>
    /// Calcula data de in√≠cio baseada no per√≠odo solicitado
    /// </summary>
    private DateTime? CalcularDataInicioPeriodo(string periodo)
    {
        return periodo.ToLower() switch
        {
            "ultimos7dias" => DateTime.UtcNow.AddDays(-7),
            "ultimos30dias" => DateTime.UtcNow.AddDays(-30),
            "ultimos90dias" => DateTime.UtcNow.AddDays(-90),
            "todos" => null,
            _ => null
        };
    }

    /// <summary>
    /// Gera estat√≠sticas gerais do per√≠odo
    /// </summary>
    private async Task<EstatisticasGeraisPeriodo> GerarEstatisticasGerais(DateTime? dataInicio)
    {
        var query = _context.PapelPermissoes.AsQueryable();
        
        if (dataInicio.HasValue)
        {
            query = query.Where(pp => pp.DataAtribuicao >= dataInicio.Value);
        }

        var totalNovasAssociacoes = await query.CountAsync();
        var associacoesAtivas = await query.CountAsync(pp => pp.Ativo);

        return new EstatisticasGeraisPeriodo
        {
            NovasAssociacoes = totalNovasAssociacoes,
            AssociacoesAtivas = associacoesAtivas,
            TaxaCrescimento = dataInicio.HasValue ? await CalcularTaxaCrescimento(dataInicio.Value) : 0
        };
    }

    /// <summary>
    /// Gera tend√™ncias temporais
    /// </summary>
    private async Task<TendenciasTempo> GerarTendenciasTempo(DateTime? dataInicio)
    {
        if (!dataInicio.HasValue)
        {
            return new TendenciasTempo();
        }

        var associacoesPorDia = await _context.PapelPermissoes
            .Where(pp => pp.DataAtribuicao >= dataInicio.Value)
            .GroupBy(pp => pp.DataAtribuicao.Date)
            .Select(g => new { Data = g.Key, Total = g.Count() })
            .OrderBy(x => x.Data)
            .ToListAsync();

        return new TendenciasTempo
        {
            AssociacoesPorDia = associacoesPorDia.ToDictionary(x => x.Data, x => x.Total)
        };
    }

    /// <summary>
    /// Gera distribui√ß√µes
    /// </summary>
    private async Task<Distribuicoes> GerarDistribuicoes()
    {
        var porCategoria = await _context.PapelPermissoes
            .Include(pp => pp.Permissao)
            .Where(pp => pp.Ativo)
            .GroupBy(pp => pp.Permissao.Categoria ?? "Sem Categoria")
            .Select(g => new { Categoria = g.Key, Total = g.Count() })
            .ToDictionaryAsync(x => x.Categoria, x => x.Total);

        var porNivelPapel = await _context.PapelPermissoes
            .Include(pp => pp.Papel)
            .Where(pp => pp.Ativo)
            .GroupBy(pp => pp.Papel.Nivel)
            .Select(g => new { Nivel = g.Key, Total = g.Count() })
            .ToDictionaryAsync(x => x.Nivel, x => x.Total);

        return new Distribuicoes
        {
            PorCategoria = porCategoria,
            PorNivelPapel = porNivelPapel
        };
    }

    /// <summary>
    /// Gera rankings
    /// </summary>
    private async Task<Rankings> GerarRankings()
    {
        var topPapeis = await _context.PapelPermissoes
            .Include(pp => pp.Papel)
            .Where(pp => pp.Ativo)
            .GroupBy(pp => new { pp.PapelId, pp.Papel.Name })
            .Select(g => new { Nome = g.Key.Name ?? "N/A", Total = g.Count() })
            .OrderByDescending(x => x.Total)
            .Take(10)
            .ToDictionaryAsync(x => x.Nome, x => x.Total);

        var topPermissoes = await _context.PapelPermissoes
            .Include(pp => pp.Permissao)
            .Where(pp => pp.Ativo)
            .GroupBy(pp => new { pp.PermissaoId, pp.Permissao.Nome })
            .Select(g => new { Nome = g.Key.Nome, Total = g.Count() })
            .OrderByDescending(x => x.Total)
            .Take(10)
            .ToDictionaryAsync(x => x.Nome, x => x.Total);

        return new Rankings
        {
            TopPapeisPorPermissoes = topPapeis,
            TopPermissoesPorPapeis = topPermissoes
        };
    }

    /// <summary>
    /// Calcula taxa de crescimento
    /// </summary>
    private async Task<decimal> CalcularTaxaCrescimento(DateTime dataInicio)
    {
        var periodoAnterior = dataInicio.AddDays(-(DateTime.UtcNow - dataInicio).Days);
        
        var associacoesPeriodoAtual = await _context.PapelPermissoes
            .CountAsync(pp => pp.DataAtribuicao >= dataInicio);
            
        var associacoesPeriodoAnterior = await _context.PapelPermissoes
            .CountAsync(pp => pp.DataAtribuicao >= periodoAnterior && pp.DataAtribuicao < dataInicio);

        if (associacoesPeriodoAnterior == 0) return 0;

        return Math.Round(((decimal)associacoesPeriodoAtual - associacoesPeriodoAnterior) / associacoesPeriodoAnterior * 100, 2);
    }

    #endregion
}