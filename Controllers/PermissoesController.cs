using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Gestus.Modelos;
using Gestus.Dados;
using Gestus.DTOs.Permissao;
using Gestus.DTOs.Comuns;
using System.Text.Json;

namespace Gestus.Controllers;

/// <summary>
/// Controller para gerenciamento completo de permiss√µes
/// Implementa opera√ß√µes CRUD robustas com pagina√ß√£o, filtros avan√ßados e auditoria
/// </summary>
[ApiController]
[Route("api/[controller]")]
[Produces("application/json")]
[Authorize] // ‚úÖ SEMPRE autenticado para qualquer opera√ß√£o
public class PermissoesController : ControllerBase
{
    private readonly GestusDbContexto _context;
    private readonly ILogger<PermissoesController> _logger;

    public PermissoesController(
        GestusDbContexto context,
        ILogger<PermissoesController> logger)
    {
        _context = context;
        _logger = logger;
    }

    /// <summary>
    /// Lista permiss√µes com pagina√ß√£o, filtros e ordena√ß√£o avan√ßada
    /// </summary>
    /// <param name="filtros">Filtros de busca</param>
    /// <returns>Lista paginada de permiss√µes</returns>
    [HttpGet]
    [ProducesResponseType(typeof(RespostaPaginada<PermissaoResumo>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarPermissoes([FromQuery] FiltrosPermissao filtros)
    {
        try
        {
            _logger.LogInformation("üìã Listando permiss√µes - Usu√°rio: {UsuarioId}", ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Listar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para listar permiss√µes");
            }

            // ‚úÖ VALIDAR FILTROS
            if (filtros.Pagina <= 0) filtros.Pagina = 1;
            if (filtros.ItensPorPagina <= 0 || filtros.ItensPorPagina > 100) filtros.ItensPorPagina = 20;

            // ‚úÖ CONSTRUIR QUERY BASE
            var query = _context.Permissoes.AsQueryable();

            // ‚úÖ APLICAR FILTROS
            if (!filtros.IncluirInativas)
            {
                query = query.Where(p => p.Ativo);
            }

            if (!string.IsNullOrEmpty(filtros.Nome))
            {
                query = query.Where(p => p.Nome.ToLower().Contains(filtros.Nome.ToLower()));
            }

            if (!string.IsNullOrEmpty(filtros.Descricao))
            {
                query = query.Where(p => p.Descricao.ToLower().Contains(filtros.Descricao.ToLower()));
            }

            if (!string.IsNullOrEmpty(filtros.Recurso))
            {
                query = query.Where(p => p.Recurso.ToLower().Contains(filtros.Recurso.ToLower()));
            }

            if (!string.IsNullOrEmpty(filtros.Acao))
            {
                query = query.Where(p => p.Acao.ToLower().Contains(filtros.Acao.ToLower()));
            }

            if (!string.IsNullOrEmpty(filtros.Categoria))
            {
                query = query.Where(p => p.Categoria != null && p.Categoria.ToLower().Contains(filtros.Categoria.ToLower()));
            }

            if (filtros.Ativo.HasValue)
            {
                query = query.Where(p => p.Ativo == filtros.Ativo.Value);
            }

            if (filtros.DataCriacaoInicio.HasValue)
            {
                query = query.Where(p => p.DataCriacao >= filtros.DataCriacaoInicio.Value);
            }

            if (filtros.DataCriacaoFim.HasValue)
            {
                query = query.Where(p => p.DataCriacao <= filtros.DataCriacaoFim.Value);
            }

            // ‚úÖ APLICAR ORDENA√á√ÉO
            query = AplicarOrdenacao(query, filtros.OrdenarPor, filtros.DirecaoOrdenacao);

            // ‚úÖ CONTAR TOTAL
            var totalItens = await query.CountAsync();

            // ‚úÖ APLICAR PAGINA√á√ÉO
            var permissoes = await query
                .Skip((filtros.Pagina - 1) * filtros.ItensPorPagina)
                .Take(filtros.ItensPorPagina)
                .Select(p => new PermissaoResumo
                {
                    Id = p.Id,
                    Nome = p.Nome,
                    Descricao = p.Descricao,
                    Recurso = p.Recurso,
                    Acao = p.Acao,
                    Categoria = p.Categoria,
                    Ativo = p.Ativo,
                    DataCriacao = p.DataCriacao,
                    TotalPapeis = p.PapelPermissoes.Count(pp => pp.Ativo)
                })
                .ToListAsync();

            // ‚úÖ MONTAR RESPOSTA PAGINADA
            var resposta = new RespostaPaginada<PermissaoResumo>
            {
                Dados = permissoes,
                PaginaAtual = filtros.Pagina,
                ItensPorPagina = filtros.ItensPorPagina,
                TotalItens = totalItens,
                TotalPaginas = (int)Math.Ceiling((double)totalItens / filtros.ItensPorPagina),
                TemProximaPagina = filtros.Pagina < (int)Math.Ceiling((double)totalItens / filtros.ItensPorPagina),
                TemPaginaAnterior = filtros.Pagina > 1
            };

            _logger.LogInformation("‚úÖ Listagem conclu√≠da - {Total} permiss√µes encontradas", totalItens);
            return Ok(resposta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar permiss√µes");
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao listar permiss√µes"
            });
        }
    }

    /// <summary>
    /// Obt√©m detalhes completos de uma permiss√£o espec√≠fica
    /// </summary>
    /// <param name="id">ID da permiss√£o</param>
    /// <returns>Detalhes completos da permiss√£o</returns>
    [HttpGet("{id:int}")]
    [ProducesResponseType(typeof(PermissaoCompleta), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ObterPermissao(int id)
    {
        try
        {
            _logger.LogInformation("üîç Obtendo permiss√£o {Id} - Usu√°rio: {UsuarioId}", id, ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Visualizar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para visualizar permiss√µes");
            }

            // ‚úÖ BUSCAR PERMISS√ÉO COM RELACIONAMENTOS
            var permissaoCompleta = await ObterPermissaoCompletaAsync(id);

            if (permissaoCompleta == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PermissaoNaoEncontrada",
                    Mensagem = $"Permiss√£o com ID {id} n√£o foi encontrada"
                });
            }

            _logger.LogInformation("‚úÖ Permiss√£o {Id} encontrada: {Nome}", id, permissaoCompleta.Nome);
            return Ok(permissaoCompleta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao obter permiss√£o {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao obter permiss√£o"
            });
        }
    }

    /// <summary>
    /// Cria uma nova permiss√£o no sistema
    /// </summary>
    /// <param name="request">Dados da nova permiss√£o</param>
    /// <returns>Permiss√£o criada</returns>
    [HttpPost]
    [ProducesResponseType(typeof(PermissaoCompleta), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> CriarPermissao([FromBody] CriarPermissaoRequest request)
    {
        try
        {
            _logger.LogInformation("üÜï Criando permiss√£o '{Nome}' - Usu√°rio: {UsuarioId}", request.Nome, ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Criar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para criar permiss√µes");
            }

            // ‚úÖ VALIDAR SE PERMISS√ÉO J√Å EXISTE
            var permissaoExistente = await _context.Permissoes
                .FirstOrDefaultAsync(p => p.Nome == request.Nome || 
                                         (p.Recurso == request.Recurso && p.Acao == request.Acao));

            if (permissaoExistente != null)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PermissaoJaExiste",
                    Mensagem = permissaoExistente.Nome == request.Nome 
                        ? $"J√° existe uma permiss√£o com o nome '{request.Nome}'"
                        : $"J√° existe uma permiss√£o para o recurso '{request.Recurso}' com a a√ß√£o '{request.Acao}'"
                });
            }

            // ‚úÖ CRIAR NOVA PERMISS√ÉO
            var novaPermissao = new Permissao
            {
                Nome = request.Nome,
                Descricao = request.Descricao,
                Recurso = request.Recurso,
                Acao = request.Acao,
                Categoria = request.Categoria,
                Ativo = true,
                DataCriacao = DateTime.UtcNow
            };

            _context.Permissoes.Add(novaPermissao);
            await _context.SaveChangesAsync();

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria("Criar", "Permissao", novaPermissao.Id.ToString(),
                $"Permiss√£o '{novaPermissao.Nome}' criada", null, novaPermissao);

            // ‚úÖ BUSCAR DADOS COMPLETOS PARA RESPOSTA
            var permissaoCompleta = await ObterPermissaoCompletaAsync(novaPermissao.Id);

            _logger.LogInformation("‚úÖ Permiss√£o criada com sucesso - ID: {Id}, Nome: {Nome}", 
                novaPermissao.Id, novaPermissao.Nome);

            return CreatedAtAction(nameof(ObterPermissao), new { id = novaPermissao.Id }, permissaoCompleta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao criar permiss√£o '{Nome}'", request.Nome);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao criar permiss√£o"
            });
        }
    }
    
    /// <summary>
    /// Atualiza uma permiss√£o existente
    /// </summary>
    /// <param name="id">ID da permiss√£o a ser atualizada</param>
    /// <param name="request">Dados de atualiza√ß√£o da permiss√£o</param>
    /// <returns>Permiss√£o atualizada</returns>
    [HttpPut("{id:int}")]
    [ProducesResponseType(typeof(PermissaoCompleta), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> AtualizarPermissao(int id, [FromBody] AtualizarPermissaoRequest request)
    {
        try
        {
            _logger.LogInformation("üîÑ Atualizando permiss√£o {Id} - Usu√°rio: {UsuarioId}", id, ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Editar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para editar permiss√µes");
            }

            // ‚úÖ BUSCAR PERMISS√ÉO EXISTENTE
            var permissao = await _context.Permissoes.FindAsync(id);
            if (permissao == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PermissaoNaoEncontrada",
                    Mensagem = $"Permiss√£o com ID {id} n√£o foi encontrada"
                });
            }

            // ‚úÖ VALIDAR CONFLITOS DE DUPLICA√á√ÉO
            if (!string.IsNullOrEmpty(request.Nome) && request.Nome != permissao.Nome)
            {
                var permissaoComNome = await _context.Permissoes
                    .FirstOrDefaultAsync(p => p.Nome == request.Nome && p.Id != id);

                if (permissaoComNome != null)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "NomeJaExiste",
                        Mensagem = $"J√° existe uma permiss√£o com o nome '{request.Nome}'"
                    });
                }
            }

            if (!string.IsNullOrEmpty(request.Recurso) && !string.IsNullOrEmpty(request.Acao) &&
                (request.Recurso != permissao.Recurso || request.Acao != permissao.Acao))
            {
                var permissaoComRecursoAcao = await _context.Permissoes
                    .FirstOrDefaultAsync(p => p.Recurso == request.Recurso && p.Acao == request.Acao && p.Id != id);

                if (permissaoComRecursoAcao != null)
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "RecursoAcaoJaExiste",
                        Mensagem = $"J√° existe uma permiss√£o para o recurso '{request.Recurso}' com a a√ß√£o '{request.Acao}'"
                    });
                }
            }

            // ‚úÖ GUARDAR DADOS ORIGINAIS PARA AUDITORIA
            var dadosAntes = new
            {
                permissao.Nome,
                permissao.Descricao,
                permissao.Recurso,
                permissao.Acao,
                permissao.Categoria,
                permissao.Ativo
            };

            // ‚úÖ APLICAR ALTERA√á√ïES
            var alterado = false;

            if (!string.IsNullOrEmpty(request.Nome) && request.Nome != permissao.Nome)
            {
                permissao.Nome = request.Nome;
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Descricao) && request.Descricao != permissao.Descricao)
            {
                permissao.Descricao = request.Descricao;
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Recurso) && request.Recurso != permissao.Recurso)
            {
                permissao.Recurso = request.Recurso;
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Acao) && request.Acao != permissao.Acao)
            {
                permissao.Acao = request.Acao;
                alterado = true;
            }

            if (!string.IsNullOrEmpty(request.Categoria) && request.Categoria != permissao.Categoria)
            {
                permissao.Categoria = request.Categoria;
                alterado = true;
            }

            if (request.Ativo.HasValue && request.Ativo != permissao.Ativo)
            {
                permissao.Ativo = request.Ativo.Value;
                alterado = true;
            }

            // ‚úÖ SALVAR APENAS SE HOUVE ALTERA√á√ïES
            if (alterado)
            {
                await _context.SaveChangesAsync();

                // ‚úÖ REGISTRAR AUDITORIA
                var dadosDepois = new
                {
                    permissao.Nome,
                    permissao.Descricao,
                    permissao.Recurso,
                    permissao.Acao,
                    permissao.Categoria,
                    permissao.Ativo
                };

                await RegistrarAuditoria("Atualizar", "Permissao", permissao.Id.ToString(),
                    $"Permiss√£o '{permissao.Nome}' atualizada", dadosAntes, dadosDepois);

                _logger.LogInformation("‚úÖ Permiss√£o {Id} atualizada com sucesso", id);
            }
            else
            {
                _logger.LogInformation("‚ÑπÔ∏è Nenhuma altera√ß√£o detectada para permiss√£o {Id}", id);
            }

            // ‚úÖ RETORNAR DADOS ATUALIZADOS
            var permissaoCompleta = await ObterPermissaoCompletaAsync(id);
            return Ok(permissaoCompleta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao atualizar permiss√£o {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao atualizar permiss√£o"
            });
        }
    }

    /// <summary>
    /// Remove uma permiss√£o do sistema (soft delete por padr√£o)
    /// </summary>
    /// <param name="id">ID da permiss√£o a ser removida</param>
    /// <param name="exclusaoPermanente">Se true, faz hard delete (exclus√£o definitiva)</param>
    /// <returns>Confirma√ß√£o da remo√ß√£o</returns>
    [HttpDelete("{id:int}")]
    [ProducesResponseType(typeof(RespostaSucesso), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> RemoverPermissao(int id, [FromQuery] bool exclusaoPermanente = false)
    {
        try
        {
            _logger.LogInformation("üóëÔ∏è Removendo permiss√£o {Id} (permanente: {Permanente}) - Usu√°rio: {UsuarioId}", 
                id, exclusaoPermanente, ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Excluir"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para excluir permiss√µes");
            }

            // ‚úÖ BUSCAR PERMISS√ÉO
            var permissao = await _context.Permissoes
                .Include(p => p.PapelPermissoes)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (permissao == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PermissaoNaoEncontrada",
                    Mensagem = $"Permiss√£o com ID {id} n√£o foi encontrada"
                });
            }

            // ‚úÖ VERIFICAR SE A PERMISS√ÉO EST√Å EM USO
            var papeisComPermissao = await _context.PapelPermissoes
                .Where(pp => pp.PermissaoId == id && pp.Ativo)
                .CountAsync();

            if (papeisComPermissao > 0 && exclusaoPermanente)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PermissaoEmUso",
                    Mensagem = $"N√£o √© poss√≠vel excluir permanentemente a permiss√£o. Ela est√° associada a {papeisComPermissao} papel(√©is). Remova as associa√ß√µes primeiro ou use exclus√£o l√≥gica."
                });
            }

            // ‚úÖ VERIFICAR PERMISS√ïES DO SISTEMA (N√ÉO PODEM SER EXCLU√çDAS)
            var permissoesSistema = new[]
            {
                "Sistema.Controle.Total",
                "Sistema.Configuracao.Gerenciar",
                "Usuarios.Criar", "Usuarios.Listar", "Usuarios.Visualizar", "Usuarios.Editar", "Usuarios.Excluir",
                "Papeis.Criar", "Papeis.Listar", "Papeis.Visualizar", "Papeis.Editar", "Papeis.Excluir",
                "Permissoes.Criar", "Permissoes.Listar", "Permissoes.Visualizar", "Permissoes.Editar", "Permissoes.Excluir"
            };

            if (permissoesSistema.Contains(permissao.Nome))
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PermissaoSistema",
                    Mensagem = $"A permiss√£o '{permissao.Nome}' √© uma permiss√£o do sistema e n√£o pode ser exclu√≠da."
                });
            }

            // ‚úÖ GUARDAR DADOS PARA AUDITORIA
            var dadosAntes = new
            {
                permissao.Id,
                permissao.Nome,
                permissao.Descricao,
                permissao.Recurso,
                permissao.Acao,
                permissao.Categoria,
                permissao.Ativo,
                TotalPapeis = papeisComPermissao
            };

            // ‚úÖ EXECUTAR REMO√á√ÉO
            if (exclusaoPermanente && papeisComPermissao == 0)
            {
                // ‚úÖ HARD DELETE - Remove definitivamente
                _context.Permissoes.Remove(permissao);
                await _context.SaveChangesAsync();

                await RegistrarAuditoria("ExcluirPermanente", "Permissao", id.ToString(),
                    $"Permiss√£o '{permissao.Nome}' exclu√≠da permanentemente", dadosAntes, null);

                _logger.LogInformation("‚úÖ Permiss√£o {Id} exclu√≠da permanentemente", id);

                return Ok(new RespostaSucesso
                {
                    Sucesso = true,
                    Mensagem = $"Permiss√£o '{permissao.Nome}' foi exclu√≠da permanentemente do sistema."
                });
            }
            else
            {
                // ‚úÖ SOFT DELETE - Apenas desativa
                if (permissao.Ativo)
                {
                    permissao.Ativo = false;
                    await _context.SaveChangesAsync();

                    await RegistrarAuditoria("Desativar", "Permissao", id.ToString(),
                        $"Permiss√£o '{permissao.Nome}' desativada", dadosAntes, new { permissao.Ativo });

                    _logger.LogInformation("‚úÖ Permiss√£o {Id} desativada", id);

                    return Ok(new RespostaSucesso
                    {
                        Sucesso = true,
                        Mensagem = $"Permiss√£o '{permissao.Nome}' foi desativada. As associa√ß√µes com pap√©is foram mantidas."
                    });
                }
                else
                {
                    return BadRequest(new RespostaErro
                    {
                        Erro = "PermissaoJaInativa",
                        Mensagem = "A permiss√£o j√° est√° inativa"
                    });
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao remover permiss√£o {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao remover permiss√£o"
            });
        }
    }

    /// <summary>
    /// Reativa uma permiss√£o desativada
    /// </summary>
    /// <param name="id">ID da permiss√£o a ser reativada</param>
    /// <returns>Confirma√ß√£o da reativa√ß√£o</returns>
    [HttpPost("{id:int}/reativar")]
    [ProducesResponseType(typeof(PermissaoCompleta), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ReativarPermissao(int id)
    {
        try
        {
            _logger.LogInformation("üîÑ Reativando permiss√£o {Id} - Usu√°rio: {UsuarioId}", id, ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Editar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para reativar permiss√µes");
            }

            // ‚úÖ BUSCAR PERMISS√ÉO
            var permissao = await _context.Permissoes.FindAsync(id);
            if (permissao == null)
            {
                return NotFound(new RespostaErro
                {
                    Erro = "PermissaoNaoEncontrada",
                    Mensagem = $"Permiss√£o com ID {id} n√£o foi encontrada"
                });
            }

            // ‚úÖ VERIFICAR SE J√Å EST√Å ATIVA
            if (permissao.Ativo)
            {
                return BadRequest(new RespostaErro
                {
                    Erro = "PermissaoJaAtiva",
                    Mensagem = "A permiss√£o j√° est√° ativa"
                });
            }

            // ‚úÖ REATIVAR
            permissao.Ativo = true;
            await _context.SaveChangesAsync();

            // ‚úÖ REGISTRAR AUDITORIA
            await RegistrarAuditoria("Reativar", "Permissao", id.ToString(),
                $"Permiss√£o '{permissao.Nome}' reativada", new { Ativo = false }, new { Ativo = true });

            _logger.LogInformation("‚úÖ Permiss√£o {Id} reativada com sucesso", id);

            // ‚úÖ RETORNAR DADOS COMPLETOS
            var permissaoCompleta = await ObterPermissaoCompletaAsync(id);
            return Ok(permissaoCompleta);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao reativar permiss√£o {Id}", id);
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao reativar permiss√£o"
            });
        }
    }

    /// <summary>
    /// Lista todas as categorias de permiss√µes dispon√≠veis
    /// </summary>
    /// <returns>Lista de categorias</returns>
    [HttpGet("categorias")]
    [ProducesResponseType(typeof(List<CategoriaPermissao>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(RespostaErro), StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> ListarCategorias()
    {
        try
        {
            _logger.LogInformation("üìã Listando categorias de permiss√µes - Usu√°rio: {UsuarioId}", ObterUsuarioLogadoId());

            // ‚úÖ VERIFICAR PERMISS√ÉO
            if (!TemPermissao("Permissoes.Listar"))
            {
                return Forbid("Usu√°rio n√£o tem permiss√£o para listar categorias de permiss√µes");
            }

            // ‚úÖ BUSCAR CATEGORIAS COM ESTAT√çSTICAS
            var categorias = await _context.Permissoes
                .Where(p => p.Categoria != null)
                .GroupBy(p => p.Categoria)
                .Select(g => new CategoriaPermissao
                {
                    Nome = g.Key!,
                    TotalPermissoes = g.Count(),
                    PermissoesAtivas = g.Count(p => p.Ativo),
                    PermissoesInativas = g.Count(p => !p.Ativo)
                })
                .OrderBy(c => c.Nome)
                .ToListAsync();

            _logger.LogInformation("‚úÖ {Total} categorias encontradas", categorias.Count);
            return Ok(categorias);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao listar categorias");
            return StatusCode(500, new RespostaErro
            {
                Erro = "ErroInterno",
                Mensagem = "Erro interno do servidor ao listar categorias"
            });
        }
    }
    
    #region M√©todos Auxiliares

    /// <summary>
    /// Aplica ordena√ß√£o din√¢mica √† query de permiss√µes
    /// </summary>
    /// <param name="query">Query base</param>
    /// <param name="ordenarPor">Campo para ordena√ß√£o</param>
    /// <param name="direcaoOrdenacao">Dire√ß√£o da ordena√ß√£o (asc/desc)</param>
    /// <returns>Query com ordena√ß√£o aplicada</returns>
    private IQueryable<Permissao> AplicarOrdenacao(IQueryable<Permissao> query, string? ordenarPor, string? direcaoOrdenacao)
    {
        if (string.IsNullOrEmpty(ordenarPor))
        {
            // Ordena√ß√£o padr√£o: Nome crescente
            return query.OrderBy(p => p.Nome);
        }

        var crescente = string.IsNullOrEmpty(direcaoOrdenacao) || direcaoOrdenacao.ToLower() == "asc";

        return ordenarPor.ToLower() switch
        {
            "nome" => crescente ? query.OrderBy(p => p.Nome) : query.OrderByDescending(p => p.Nome),
            "descricao" => crescente ? query.OrderBy(p => p.Descricao) : query.OrderByDescending(p => p.Descricao),
            "recurso" => crescente ? query.OrderBy(p => p.Recurso) : query.OrderByDescending(p => p.Recurso),
            "acao" => crescente ? query.OrderBy(p => p.Acao) : query.OrderByDescending(p => p.Acao),
            "categoria" => crescente ? query.OrderBy(p => p.Categoria) : query.OrderByDescending(p => p.Categoria),
            "ativo" => crescente ? query.OrderBy(p => p.Ativo) : query.OrderByDescending(p => p.Ativo),
            "datacriacao" => crescente ? query.OrderBy(p => p.DataCriacao) : query.OrderByDescending(p => p.DataCriacao),
            "totalpapeis" => crescente 
                ? query.OrderBy(p => p.PapelPermissoes.Count(pp => pp.Ativo))
                : query.OrderByDescending(p => p.PapelPermissoes.Count(pp => pp.Ativo)),
            _ => query.OrderBy(p => p.Nome) // Fallback para ordena√ß√£o padr√£o
        };
    }

    /// <summary>
    /// Obt√©m dados completos de uma permiss√£o com relacionamentos
    /// </summary>
    /// <param name="permissaoId">ID da permiss√£o</param>
    /// <returns>Dados completos da permiss√£o ou null se n√£o encontrada</returns>
    private async Task<PermissaoCompleta?> ObterPermissaoCompletaAsync(int permissaoId)
    {
        var permissao = await _context.Permissoes
            .Include(p => p.PapelPermissoes.Where(pp => pp.Ativo))
                .ThenInclude(pp => pp.Papel)
            .FirstOrDefaultAsync(p => p.Id == permissaoId);

        if (permissao == null)
        {
            return null;
        }

        // Mapear para DTO
        return new PermissaoCompleta
        {
            Id = permissao.Id,
            Nome = permissao.Nome,
            Descricao = permissao.Descricao,
            Recurso = permissao.Recurso,
            Acao = permissao.Acao,
            Categoria = permissao.Categoria,
            Ativo = permissao.Ativo,
            DataCriacao = permissao.DataCriacao,
            TotalPapeis = permissao.PapelPermissoes.Count(pp => pp.Ativo),
            Papeis = permissao.PapelPermissoes
                .Where(pp => pp.Ativo)
                .Select(pp => new PapelPermissaoResumo
                {
                    Id = pp.Papel.Id,
                    Nome = pp.Papel.Name!,
                    Descricao = pp.Papel.Descricao,
                    Categoria = pp.Papel.Categoria,
                    Nivel = pp.Papel.Nivel,
                    DataAtribuicao = pp.DataAtribuicao,
                    Ativo = pp.Papel.Ativo
                })
                .OrderBy(p => p.Nome)
                .ToList(),
            Estatisticas = new EstatisticasPermissao
            {
                TotalPapeisAtivos = permissao.PapelPermissoes.Count(pp => pp.Ativo && pp.Papel.Ativo),
                TotalPapeisInativos = permissao.PapelPermissoes.Count(pp => pp.Ativo && !pp.Papel.Ativo),
                TotalUsuariosComPermissao = await ContarUsuariosComPermissao(permissaoId),
                UltimaAtribuicao = permissao.PapelPermissoes
                    .Where(pp => pp.Ativo)
                    .Max(pp => (DateTime?)pp.DataAtribuicao)
            }
        };
    }

    /// <summary>
    /// Conta quantos usu√°rios t√™m uma permiss√£o espec√≠fica atrav√©s dos pap√©is
    /// </summary>
    /// <param name="permissaoId">ID da permiss√£o</param>
    /// <returns>N√∫mero de usu√°rios com a permiss√£o</returns>
    private async Task<int> ContarUsuariosComPermissao(int permissaoId)
    {
        return await _context.UsuarioPapeis
            .Where(up => up.Ativo && 
                            up.Papel.Ativo && 
                            up.Usuario.Ativo &&
                            up.Papel.PapelPermissoes.Any(pp => pp.PermissaoId == permissaoId && pp.Ativo))
            .Select(up => up.UsuarioId)
            .Distinct()
            .CountAsync();
    }

    /// <summary>
    /// Obt√©m ID do usu√°rio logado a partir do token JWT
    /// </summary>
    /// <returns>ID do usu√°rio logado</returns>
    private int ObterUsuarioLogadoId()
    {
        var usuarioIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? 
                            User.FindFirstValue("sub") ?? 
                            User.FindFirstValue("id");
        
        if (string.IsNullOrEmpty(usuarioIdClaim) || !int.TryParse(usuarioIdClaim, out var usuarioId))
        {
            throw new UnauthorizedAccessException("ID do usu√°rio n√£o encontrado no token");
        }

        return usuarioId;
    }

    /// <summary>
    /// Verifica se o usu√°rio logado tem uma permiss√£o espec√≠fica
    /// </summary>
    /// <param name="permissao">Nome da permiss√£o a verificar</param>
    /// <returns>True se o usu√°rio tem a permiss√£o</returns>
    private bool TemPermissao(string permissao)
    {
        try
        {
            // Verificar se √© SuperAdmin (tem todas as permiss√µes)
            if (User.IsInRole("SuperAdmin"))
            {
                return true;
            }

            // Verificar permiss√£o espec√≠fica via claims
            var permissoesClaim = User.FindFirstValue("permissions") ?? User.FindFirstValue("permissoes");
            
            if (!string.IsNullOrEmpty(permissoesClaim))
            {
                var permissoesUsuario = permissoesClaim.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                                        .Select(p => p.Trim())
                                                        .ToHashSet();
                
                return permissoesUsuario.Contains(permissao);
            }

            // Fallback: verificar permiss√µes via pap√©is (consulta ao banco)
            var usuarioId = ObterUsuarioLogadoId();
            return VerificarPermissaoViaPapeis(usuarioId, permissao);
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Erro ao verificar permiss√£o {Permissao} para usu√°rio", permissao);
            return false;
        }
    }

    /// <summary>
    /// Verifica permiss√£o consultando diretamente os pap√©is do usu√°rio no banco
    /// </summary>
    /// <param name="usuarioId">ID do usu√°rio</param>
    /// <param name="permissao">Nome da permiss√£o</param>
    /// <returns>True se o usu√°rio tem a permiss√£o</returns>
    private bool VerificarPermissaoViaPapeis(int usuarioId, string permissao)
    {
        try
        {
            return _context.UsuarioPapeis
                .Where(up => up.UsuarioId == usuarioId && 
                            up.Ativo && 
                            up.Papel.Ativo)
                .Any(up => up.Papel.PapelPermissoes
                    .Any(pp => pp.Permissao.Nome == permissao && 
                                pp.Ativo && 
                                pp.Permissao.Ativo));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao verificar permiss√£o {Permissao} via pap√©is para usu√°rio {UsuarioId}", 
                permissao, usuarioId);
            return false;
        }
    }

    /// <summary>
    /// Registra uma a√ß√£o na auditoria do sistema
    /// </summary>
    /// <param name="acao">A√ß√£o realizada</param>
    /// <param name="recurso">Tipo de recurso</param>
    /// <param name="recursoId">ID do recurso</param>
    /// <param name="observacoes">Observa√ß√µes adicionais</param>
    /// <param name="dadosAntes">Dados antes da altera√ß√£o</param>
    /// <param name="dadosDepois">Dados depois da altera√ß√£o</param>
    private async Task RegistrarAuditoria(string acao, string recurso, string? recursoId, 
        string observacoes, object? dadosAntes = null, object? dadosDepois = null)
    {
        try
        {
            var usuarioId = ObterUsuarioLogadoId();
            var httpContext = HttpContext;

            var registro = new RegistroAuditoria
            {
                UsuarioId = usuarioId,
                Acao = acao,
                Recurso = recurso,
                RecursoId = recursoId,
                DataHora = DateTime.UtcNow,
                EnderecoIp = ObterEnderecoIp(httpContext),
                UserAgent = httpContext.Request.Headers.UserAgent.ToString(),
                DadosAntes = dadosAntes != null ? JsonSerializer.Serialize(dadosAntes) : null,
                DadosDepois = dadosDepois != null ? JsonSerializer.Serialize(dadosDepois) : null,
                Observacoes = observacoes
            };

            _context.RegistrosAuditoria.Add(registro);
            await _context.SaveChangesAsync();

            _logger.LogInformation("üìù Auditoria registrada: {Acao} em {Recurso} por usu√°rio {UsuarioId}", 
                acao, recurso, usuarioId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "‚ùå Erro ao registrar auditoria: {Acao} em {Recurso}", acao, recurso);
            // N√£o fazer throw para n√£o interromper a opera√ß√£o principal
        }
    }

    /// <summary>
    /// Obt√©m o endere√ßo IP da requisi√ß√£o considerando proxies
    /// </summary>
    /// <param name="httpContext">Contexto HTTP da requisi√ß√£o</param>
    /// <returns>Endere√ßo IP do cliente</returns>
    private static string ObterEnderecoIp(HttpContext httpContext)
    {
        // Verificar cabe√ßalhos de proxy primeiro
        var xForwardedFor = httpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(xForwardedFor))
        {
            // Pegar o primeiro IP da lista (IP original do cliente)
            var ips = xForwardedFor.Split(',', StringSplitOptions.RemoveEmptyEntries);
            if (ips.Length > 0)
            {
                return ips[0].Trim();
            }
        }

        // Verificar cabe√ßalho X-Real-IP
        var xRealIp = httpContext.Request.Headers["X-Real-IP"].FirstOrDefault();
        if (!string.IsNullOrEmpty(xRealIp))
        {
            return xRealIp;
        }

        // Fallback para RemoteIpAddress
        return httpContext.Connection.RemoteIpAddress?.ToString() ?? "Desconhecido";
    }

    /// <summary>
    /// Valida se uma permiss√£o pode ser criada/atualizada
    /// </summary>
    /// <param name="nome">Nome da permiss√£o</param>
    /// <param name="recurso">Recurso da permiss√£o</param>
    /// <param name="acao">A√ß√£o da permiss√£o</param>
    /// <param name="permissaoIdExcluir">ID da permiss√£o a excluir da valida√ß√£o (para updates)</param>
    /// <returns>Resultado da valida√ß√£o</returns>
    private async Task<ResultadoValidacao> ValidarPermissao(string nome, string recurso, string acao, int? permissaoIdExcluir = null)
    {
        var erros = new List<string>();

        // Validar nome √∫nico
        var permissaoComNome = await _context.Permissoes
            .FirstOrDefaultAsync(p => p.Nome == nome && (permissaoIdExcluir == null || p.Id != permissaoIdExcluir));

        if (permissaoComNome != null)
        {
            erros.Add($"J√° existe uma permiss√£o com o nome '{nome}'");
        }

        // Validar combina√ß√£o recurso+a√ß√£o √∫nica
        var permissaoComRecursoAcao = await _context.Permissoes
            .FirstOrDefaultAsync(p => p.Recurso == recurso && p.Acao == acao && 
                                (permissaoIdExcluir == null || p.Id != permissaoIdExcluir));

        if (permissaoComRecursoAcao != null)
        {
            erros.Add($"J√° existe uma permiss√£o para o recurso '{recurso}' com a a√ß√£o '{acao}'");
        }

        // Validar padr√£o de nomenclatura
        if (!nome.Contains('.'))
        {
            erros.Add("Nome da permiss√£o deve seguir o padr√£o 'Recurso.Acao'");
        }

        // Validar se segue conven√ß√µes
        var partesNome = nome.Split('.');
        if (partesNome.Length >= 2)
        {
            var recursoNome = partesNome[0];
            var acaoNome = partesNome[1];

            if (!string.Equals(recursoNome, recurso, StringComparison.OrdinalIgnoreCase))
            {
                erros.Add($"O recurso no nome '{recursoNome}' deve corresponder ao campo recurso '{recurso}'");
            }

            if (!string.Equals(acaoNome, acao, StringComparison.OrdinalIgnoreCase))
            {
                erros.Add($"A a√ß√£o no nome '{acaoNome}' deve corresponder ao campo a√ß√£o '{acao}'");
            }
        }

        return new ResultadoValidacao
        {
            Valido = !erros.Any(),
            Erros = erros
        };
    }

    #endregion

    #region Classes Auxiliares

    /// <summary>
    /// Resultado de valida√ß√£o
    /// </summary>
    private class ResultadoValidacao
    {
        public bool Valido { get; set; }
        public List<string> Erros { get; set; } = new();
    }

    #endregion
}