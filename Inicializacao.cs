using Gestus.Configuracoes;
using Gestus.Dados;
using Serilog;
using Prometheus;
using Microsoft.EntityFrameworkCore;
using FluentValidation;
using Microsoft.AspNetCore.Diagnostics.HealthChecks;
using Microsoft.Extensions.Diagnostics.HealthChecks;
using Microsoft.Extensions.Http.Resilience;
using System.Reflection;
using Gestus.Services;

namespace Gestus;

public static class Inicializacao
{
    public static void ConfigurarServicos(this WebApplicationBuilder builder)
    {
        var configuration = builder.Configuration;
        var services = builder.Services;

        // Configurar Serilog
        builder.Host.UseSerilog((context, loggerConfiguration) =>
        {
            loggerConfiguration.ReadFrom.Configuration(context.Configuration);
        });

        // Entity Framework e Identity
        services.AdicionarEntityFramework(configuration);

        // ‚úÖ ADICIONAR: Servi√ßo de timezone
        services.AddScoped<ITimezoneService, TimezoneService>();

        // Controllers e API
        services.AddControllers()
                .AddNewtonsoftJson(options =>
                {
                    options.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;
                    options.SerializerSettings.DateTimeZoneHandling = Newtonsoft.Json.DateTimeZoneHandling.Utc;
                });

        // OpenAPI/Swagger
        services.AddEndpointsApiExplorer();
        services.ConfigurarSwagger(configuration);

        // CORS
        services.ConfigurarCors(configuration);

        // Autentica√ß√£o e Autoriza√ß√£o
        services.ConfigurarAutenticacao(configuration);

        // Health Checks
        services.ConfigurarHealthChecks(configuration);

        // AutoMapper (corrigido)
        services.AddAutoMapper(Assembly.GetExecutingAssembly());

        // FluentValidation (corrigido)
        services.AddValidatorsFromAssembly(Assembly.GetExecutingAssembly());

        // HttpClient com Resilience (nova abordagem)
        services.AddHttpClient("default")
                .AddStandardResilienceHandler();

        services.AddHttpClient();
    }

    public static async Task<WebApplication> ConfigurarPipelineAsync(this WebApplication app)
    {
        var environment = app.Environment;

        // ‚úÖ Log do ambiente (manter para debug)
        var logger = app.Services.GetRequiredService<ILogger<Program>>();
        logger.LogInformation($"üîç Ambiente atual: {environment.EnvironmentName}");
        logger.LogInformation($"üîç √â Development? {environment.IsDevelopment()}");

        // Logging de requisi√ß√µes
        app.UseSerilogRequestLogging();

        // ‚úÖ SWAGGER SEMPRE ATIVO
        app.UseSwagger();
        app.UseSwaggerUI(c =>
        {
            c.SwaggerEndpoint("/swagger/v1/swagger.json", "Gestus API v1");
            c.RoutePrefix = string.Empty;
            c.DisplayRequestDuration();
            c.EnableTryItOutByDefault();
        });

        if (environment.IsDevelopment())
        {
            // ‚úÖ SEEDER APENAS EM DESENVOLVIMENTO (restaurado)
            await app.AplicarMigracoesESeederAsync();
        }
        else
        {
            app.UseExceptionHandler("/Error");
            app.UseHsts();
        }

        // HTTPS Redirection
        app.UseHttpsRedirection();

        // Arquivos est√°ticos
        app.UseStaticFiles();

        // CORS
        app.UseCors("PoliticaCorsGestus");

        // Autentica√ß√£o e Autoriza√ß√£o
        app.UseAuthentication();
        app.UseAuthorization();

        // M√©tricas do Prometheus
        app.UseMetricServer();
        app.UseHttpMetrics();

        // Health Checks
        app.UseHealthChecks("/saude", new HealthCheckOptions
        {
            ResponseWriter = async (context, report) =>
            {
                context.Response.ContentType = "application/json";
                var response = new
                {
                    status = report.Status.ToString(),
                    checks = report.Entries.Select(x => new
                    {
                        name = x.Key,
                        status = x.Value.Status.ToString(),
                        exception = x.Value.Exception?.Message,
                        duration = x.Value.Duration.ToString()
                    })
                };
                await context.Response.WriteAsync(System.Text.Json.JsonSerializer.Serialize(response));
            }
        });
        app.UseHealthChecksUI(options => options.UIPath = "/saude-ui");

        // Controllers
        app.MapControllers();

        return app;
    }

    private static async Task AplicarMigracoesESeederAsync(this WebApplication app)
    {
        using var scope = app.Services.CreateScope();
        var context = scope.ServiceProvider.GetRequiredService<GestusDbContexto>();
        var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();

        try
        {
            logger.LogInformation("üîß Verificando estado do banco de dados...");
            
            // ‚úÖ Verificar se pode conectar
            var canConnect = await context.Database.CanConnectAsync();
            if (!canConnect)
            {
                logger.LogError("‚ùå N√£o foi poss√≠vel conectar ao banco. Pulando inicializa√ß√£o.");
                return;
            }

            // ‚úÖ Tentar aplicar migra√ß√µes, mas n√£o falhar se tabelas j√° existirem
            try
            {
                await context.Database.MigrateAsync();
                logger.LogInformation("‚úÖ Migra√ß√µes aplicadas com sucesso");
            }
            catch (Exception migrationEx)
            {
                logger.LogWarning($"‚ö†Ô∏è Erro ao aplicar migra√ß√µes (provavelmente j√° existem): {migrationEx.Message}");
                logger.LogInformation("üîÑ Continuando com o seeder mesmo assim...");
            }

            logger.LogInformation("üå± Executando seeder inicial...");
            await SeederInicial.ExecutarAsync(scope.ServiceProvider);

            logger.LogInformation("‚úÖ Inicializa√ß√£o do banco conclu√≠da com sucesso.");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "‚ùå Erro durante a inicializa√ß√£o do banco de dados");
            // ‚úÖ N√ÉO fazer throw para n√£o parar a aplica√ß√£o
            logger.LogWarning("‚ö†Ô∏è Continuando inicializa√ß√£o da aplica√ß√£o mesmo com erro no seeder...");
        }
    }
}