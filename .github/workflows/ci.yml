name: CI - Valida√ß√£o de Padr√µes Gestus

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: 'Gestus.sln'

jobs:
  # ============================================
  # Job 1: Valida√ß√£o de Formata√ß√£o
  # ============================================
  format-validation:
    name: üé® Valida√ß√£o de Formata√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: üì¶ Restaurar depend√™ncias
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: üé® Verificar formata√ß√£o
      run: |
        dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic
        if [ $? -ne 0 ]; then
          echo "‚ùå C√≥digo n√£o est√° formatado corretamente!"
          echo "Execute: dotnet format"
          exit 1
        fi
        echo "‚úÖ Formata√ß√£o OK!"

  # ============================================
  # Job 2: An√°lise Est√°tica e Build
  # ============================================
  build-and-analyze:
    name: üî® Build e An√°lise Est√°tica
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: üì¶ Restaurar depend√™ncias
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: üî® Build
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-restore \
          /p:TreatWarningsAsErrors=true \
          /p:WarningLevel=4
          
    - name: üìä An√°lise de c√≥digo
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-restore \
          /p:RunAnalyzers=true \
          /p:EnforceCodeStyleInBuild=true

  # ============================================
  # Job 3: Testes
  # ============================================
  tests:
    name: üß™ Testes
    runs-on: ubuntu-latest
    needs: build-and-analyze
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: üì¶ Restaurar depend√™ncias
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: üî® Build
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
      
    - name: üß™ Executar testes
      run: |
        dotnet test ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults
          
    - name: üìä Upload resultados dos testes
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ./TestResults
        
    - name: üìà Publicar cobertura
      if: always()
      uses: codecov/codecov-action@v3
      with:
        files: ./TestResults/**/coverage.cobertura.xml
        flags: unittests
        name: codecov-gestus

  # ============================================
  # Job 4: Valida√ß√£o de Nomenclatura
  # ============================================
  naming-validation:
    name: üìù Valida√ß√£o de Nomenclatura
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîç Verificar nomenclatura em portugu√™s
      run: |
        echo "üîç Verificando nomenclatura..."
        
        # Verificar se h√° classes/m√©todos em ingl√™s (exceto keywords)
        ENGLISH_NAMES=$(grep -r --include="*.cs" \
          -E "(class|interface|enum)\s+(User|Role|Permission|Application|Group)" \
          --exclude-dir={bin,obj,Migrations} \
          . || true)
        
        if [ ! -z "$ENGLISH_NAMES" ]; then
          echo "‚ùå Encontradas classes em ingl√™s:"
          echo "$ENGLISH_NAMES"
          echo ""
          echo "üìã Padr√£o: Classes devem estar em portugu√™s"
          echo "Exemplos: Usuario, Papel, Permissao, Aplicacao, Grupo"
          exit 1
        fi
        
        echo "‚úÖ Nomenclatura OK!"
        
    - name: üîç Verificar sufixo Async
      run: |
        echo "üîç Verificando sufixo Async..."
        
        # Verificar m√©todos async sem sufixo Async
        MISSING_ASYNC=$(grep -r --include="*.cs" \
          -E "public\s+async\s+Task.*\s+\w+\(" \
          --exclude-dir={bin,obj,Migrations} \
          . | grep -v "Async(" || true)
        
        if [ ! -z "$MISSING_ASYNC" ]; then
          echo "‚ùå M√©todos async sem sufixo 'Async':"
          echo "$MISSING_ASYNC"
          echo ""
          echo "üìã Padr√£o: M√©todos async devem ter sufixo 'Async'"
          exit 1
        fi
        
        echo "‚úÖ Sufixo Async OK!"

  # ============================================
  # Job 5: Valida√ß√£o de Estrutura
  # ============================================
  structure-validation:
    name: üèóÔ∏è Valida√ß√£o de Estrutura
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîç Verificar um arquivo = uma classe
      run: |
        echo "üîç Verificando estrutura de arquivos..."
        
        # Verificar arquivos com m√∫ltiplas classes p√∫blicas
        MULTI_CLASS_FILES=$(find . -name "*.cs" \
          -not -path "*/bin/*" \
          -not -path "*/obj/*" \
          -not -path "*/Migrations/*" \
          -exec sh -c '
            PUBLIC_CLASSES=$(grep -c "^[[:space:]]*public class\|^[[:space:]]*public interface\|^[[:space:]]*public enum" "$1" 2>/dev/null || echo 0)
            if [ "$PUBLIC_CLASSES" -gt 1 ]; then
              echo "$1 tem $PUBLIC_CLASSES classes/interfaces/enums p√∫blicos"
            fi
          ' _ {} \; || true)
        
        if [ ! -z "$MULTI_CLASS_FILES" ]; then
          echo "‚ùå Arquivos com m√∫ltiplas classes p√∫blicas:"
          echo "$MULTI_CLASS_FILES"
          echo ""
          echo "üìã Padr√£o: Um arquivo = Uma classe/interface/enum"
          exit 1
        fi
        
        echo "‚úÖ Estrutura de arquivos OK!"
        
    - name: üîç Verificar DTOs fora de controllers
      run: |
        echo "üîç Verificando DTOs em controllers..."
        
        # Verificar se h√° DTOs definidos dentro de controllers
        DTOS_IN_CONTROLLERS=$(find ./Gestus.Api/Controllers -name "*.cs" 2>/dev/null \
          -exec grep -l "public class.*Request\|public class.*Response\|public class.*Dto" {} \; || true)
        
        if [ ! -z "$DTOS_IN_CONTROLLERS" ]; then
          echo "‚ùå DTOs encontrados dentro de controllers:"
          echo "$DTOS_IN_CONTROLLERS"
          echo ""
          echo "üìã Padr√£o: DTOs devem estar em Gestus.Application/DTOs/"
          exit 1
        fi
        
        echo "‚úÖ DTOs OK!"

  # ============================================
  # Job 6: Valida√ß√£o de Seguran√ßa
  # ============================================
  security-validation:
    name: üîí Valida√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîç Verificar senhas em logs
      run: |
        echo "üîç Verificando logs de dados sens√≠veis..."
        
        # Verificar se h√° logs de senhas/tokens
        SENSITIVE_LOGS=$(grep -r --include="*.cs" \
          -iE "LogInformation.*senha|LogDebug.*senha|LogWarning.*senha|LogError.*senha" \
          --exclude-dir={bin,obj,Migrations} \
          . || true)
        
        if [ ! -z "$SENSITIVE_LOGS" ]; then
          echo "‚ö†Ô∏è AVISO: Poss√≠vel log de dados sens√≠veis:"
          echo "$SENSITIVE_LOGS"
          echo ""
          echo "üìã Padr√£o: NUNCA logar senhas, tokens ou dados sens√≠veis"
          echo "Revise manualmente se isso √© realmente um problema"
        fi
        
        # Verificar secrets em appsettings
        SECRETS_IN_CONFIG=$(grep -r --include="appsettings*.json" \
          -iE "password.*:.*[^{]|secret.*:.*[^{]|key.*:.*[^{]" \
          --exclude="appsettings.json" \
          . || true)
        
        if [ ! -z "$SECRETS_IN_CONFIG" ]; then
          echo "‚ùå Secrets encontrados em arquivos de configura√ß√£o:"
          echo "$SECRETS_IN_CONFIG"
          echo ""
          echo "üìã Padr√£o: Usar vari√°veis de ambiente ou User Secrets"
          exit 1
        fi
        
        echo "‚úÖ Valida√ß√£o de seguran√ßa OK!"

  # ============================================
  # Job 7: Valida√ß√£o de Documenta√ß√£o
  # ============================================
  documentation-validation:
    name: üìö Valida√ß√£o de Documenta√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîç Verificar XML comments
      run: |
        echo "üîç Verificando documenta√ß√£o XML..."
        
        # Verificar classes p√∫blicas sem XML comments
        MISSING_DOCS=$(find . -name "*.cs" \
          -not -path "*/bin/*" \
          -not -path "*/obj/*" \
          -not -path "*/Migrations/*" \
          -exec sh -c '
            # Verificar se h√° classes p√∫blicas sem /// <summary>
            grep -B1 "^[[:space:]]*public class\|^[[:space:]]*public interface" "$1" 2>/dev/null | \
            grep -v "///" | grep -v "^--$" | grep "public" || true
          ' _ {} \; || true)
        
        if [ ! -z "$MISSING_DOCS" ]; then
          echo "‚ö†Ô∏è AVISO: Classes p√∫blicas sem XML comments:"
          echo "$MISSING_DOCS"
          echo ""
          echo "üìã Padr√£o: Todos os membros p√∫blicos devem ter XML comments"
          echo "Isso n√£o bloqueia o build, mas deve ser corrigido"
        fi
        
        echo "‚úÖ Valida√ß√£o de documenta√ß√£o conclu√≠da!"

  # ============================================
  # Job Final: Resumo
  # ============================================
  summary:
    name: üìä Resumo da Valida√ß√£o
    runs-on: ubuntu-latest
    needs: [format-validation, build-and-analyze, tests, naming-validation, structure-validation, security-validation, documentation-validation]
    if: always()
    
    steps:
    - name: üìä Gerar resumo
      run: |
        echo "# üìä Resumo da Valida√ß√£o de Padr√µes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ‚úÖ Valida√ß√µes Executadas" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- üé® Formata√ß√£o de c√≥digo" >> $GITHUB_STEP_SUMMARY
        echo "- üî® Build e an√°lise est√°tica" >> $GITHUB_STEP_SUMMARY
        echo "- üß™ Testes unit√°rios" >> $GITHUB_STEP_SUMMARY
        echo "- üìù Nomenclatura em portugu√™s" >> $GITHUB_STEP_SUMMARY
        echo "- üèóÔ∏è Estrutura de arquivos" >> $GITHUB_STEP_SUMMARY
        echo "- üîí Seguran√ßa (logs e secrets)" >> $GITHUB_STEP_SUMMARY
        echo "- üìö Documenta√ß√£o XML" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìã Padr√µes Gestus" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Todos os padr√µes definidos em PADRONIZACAO.md foram validados!" >> $GITHUB_STEP_SUMMARY
        
    - name: ‚úÖ Sucesso
      if: ${{ needs.format-validation.result == 'success' && needs.build-and-analyze.result == 'success' && needs.tests.result == 'success' && needs.naming-validation.result == 'success' && needs.structure-validation.result == 'success' && needs.security-validation.result == 'success' }}
      run: |
        echo "‚úÖ Todas as valida√ß√µes passaram!"
        echo "O c√≥digo est√° em conformidade com os padr√µes Gestus!"
        
    - name: ‚ùå Falha
      if: ${{ needs.format-validation.result == 'failure' || needs.build-and-analyze.result == 'failure' || needs.tests.result == 'failure' || needs.naming-validation.result == 'failure' || needs.structure-validation.result == 'failure' || needs.security-validation.result == 'failure' }}
      run: |
        echo "‚ùå Algumas valida√ß√µes falharam!"
        echo "Revise os logs acima para detalhes"
        exit 1
