# Script para executar testes do Gestus IAM
# Uso: .\tests\scripts\run-tests.ps1 [op√ß√µes]

param(
    [switch]$Coverage,      # Gerar relat√≥rio de cobertura
    [switch]$Verbose,       # Output detalhado
    [string]$Filter = "",   # Filtrar testes espec√≠ficos
    [switch]$Watch,         # Modo watch para desenvolvimento
    [switch]$Quick,         # Apenas testes unit√°rios (mais r√°pido)
    [switch]$Help           # Mostrar ajuda
)

# Fun√ß√£o para mostrar ajuda
function Show-Help {
    Write-Host @"
üß™ Script de Testes - Gestus IAM
================================

USO:
    .\tests\scripts\run-tests.ps1 [op√ß√µes]

OP√á√ïES:
    -Coverage       Gera relat√≥rio de cobertura de c√≥digo
    -Verbose        Mostra output detalhado dos testes
    -Filter <nome>  Executa apenas testes que contenham o nome especificado
    -Watch          Executa testes em modo watch (re-executa quando arquivos mudam)
    -Quick          Executa apenas testes unit√°rios (mais r√°pido)
    -Help           Mostra esta ajuda

EXEMPLOS:
    .\tests\scripts\run-tests.ps1                    # Executa todos os testes
    .\tests\scripts\run-tests.ps1 -Coverage          # Executa com cobertura
    .\tests\scripts\run-tests.ps1 -Filter "Usuario"  # Executa apenas testes de Usuario
    .\tests\scripts\run-tests.ps1 -Quick -Watch      # Modo desenvolvimento r√°pido
    .\tests\scripts\run-tests.ps1 -Verbose           # Output detalhado

"@ -ForegroundColor Cyan
    exit 0
}

if ($Help) { Show-Help }

# Configura√ß√µes
$ErrorActionPreference = "Stop"
$testProject = "tests\Gestus.Tests\Gestus.Tests.csproj"
$resultsPath = "tests\results"

# Verificar se estamos no diret√≥rio correto
if (!(Test-Path "Gestus.csproj")) {
    Write-Host "‚ùå Execute este script a partir do diret√≥rio raiz do projeto Gestus" -ForegroundColor Red
    exit 1
}

# Criar diret√≥rio de resultados
if (!(Test-Path $resultsPath)) {
    New-Item -ItemType Directory -Path $resultsPath | Out-Null
}

try {
    Write-Host "üß™ Executando Testes - Gestus IAM" -ForegroundColor Cyan
    Write-Host "=================================" -ForegroundColor Cyan
    Write-Host "‚è± $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
    Write-Host ""

    # Construir argumentos do comando
    $testArgs = @("test", $testProject)
    
    if ($Coverage) {
        Write-Host "üìä Cobertura de c√≥digo habilitada" -ForegroundColor Yellow
        $testArgs += @("--collect", "XPlat Code Coverage")
        $testArgs += @("--results-directory", $resultsPath)
    }
    
    if ($Verbose) {
        $testArgs += @("--verbosity", "detailed")
    } else {
        $testArgs += @("--verbosity", "minimal")
    }
    
    if ($Filter) {
        Write-Host "üéØ Filtrando por: $Filter" -ForegroundColor Yellow
        $testArgs += @("--filter", "DisplayName~$Filter")
    }
    
    if ($Watch) {
        Write-Host "üëÅ Modo Watch ativo - Pressione Ctrl+C para parar" -ForegroundColor Green
        $testArgs += "--watch"
    }

    # Log da configura√ß√£o
    if ($Quick) {
        Write-Host "‚ö° Modo r√°pido: apenas testes unit√°rios" -ForegroundColor Green
    }
    
    Write-Host "üîß Comando: dotnet $($testArgs -join ' ')" -ForegroundColor Gray
    Write-Host ""

    # Executar testes
    $startTime = Get-Date
    & dotnet @testArgs
    $endTime = Get-Date
    $duration = $endTime - $startTime
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host ""
        Write-Host "‚úÖ Todos os testes passaram!" -ForegroundColor Green
        Write-Host "‚è± Tempo total: $($duration.TotalSeconds.ToString('F2')) segundos" -ForegroundColor Gray
        
        if ($Coverage) {
            Write-Host ""
            Write-Host "üìà Relat√≥rios de cobertura:" -ForegroundColor Cyan
            Get-ChildItem $resultsPath -Recurse -Filter "coverage.cobertura.xml" | ForEach-Object {
                Write-Host "   $($_.FullName)" -ForegroundColor Gray
            }
        }
        
    } else {
        Write-Host ""
        Write-Host "‚ùå Alguns testes falharam!" -ForegroundColor Red
        Write-Host "‚è± Tempo total: $($duration.TotalSeconds.ToString('F2')) segundos" -ForegroundColor Gray
        exit 1
    }
    
} catch {
    Write-Host ""
    Write-Host "üí• Erro durante execu√ß√£o dos testes:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "üèÅ Execu√ß√£o conclu√≠da!" -ForegroundColor Green