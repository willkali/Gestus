using Gestus.Modelos;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using OpenIddict.Abstractions;

namespace Gestus.Dados;

public static class SeederInicial
{
    public static async Task ExecutarAsync(IServiceProvider serviceProvider)
    {
        var context = serviceProvider.GetRequiredService<GestusDbContexto>();
        var userManager = serviceProvider.GetRequiredService<UserManager<Usuario>>();
        var roleManager = serviceProvider.GetRequiredService<RoleManager<Papel>>();
        var logger = serviceProvider.GetRequiredService<ILogger<Program>>();

        // ‚úÖ ADICIONAR: Gerenciador de aplica√ß√µes e scopes OpenIddict
        var applicationManager = serviceProvider.GetRequiredService<IOpenIddictApplicationManager>();
        var scopeManager = serviceProvider.GetRequiredService<IOpenIddictScopeManager>();

        try
        {
            logger.LogInformation("üå± Iniciando seeder de dados iniciais...");

            // ‚úÖ Verificar se o banco est√° conectado
            var canConnect = await context.Database.CanConnectAsync();
            logger.LogInformation($"üìä Conex√£o com banco: {(canConnect ? "OK" : "FALHOU")}");

            if (!canConnect)
            {
                logger.LogError("‚ùå N√£o foi poss√≠vel conectar ao banco de dados. Pulando seeder.");
                return;
            }

            // 1. Criar scopes OpenIddict PRIMEIRO
            logger.LogInformation("üîß Iniciando cria√ß√£o de scopes OpenIddict...");
            await CriarScopesOpenIddict(scopeManager, logger);

            // 2. Criar aplica√ß√µes OpenIddict
            logger.LogInformation("üîß Iniciando cria√ß√£o de aplica√ß√µes OpenIddict...");
            await CriarAplicacoesOpenIddict(applicationManager, logger);

            // 3. Criar os pap√©is base
            logger.LogInformation("üìã Iniciando cria√ß√£o de pap√©is...");
            await CriarPapeisBase(roleManager, logger);

            // 4. Criar as permiss√µes base
            logger.LogInformation("üîê Iniciando cria√ß√£o de permiss√µes...");
            await CriarPermissoesBase(context, logger);

            // 5. Associar permiss√µes aos pap√©is
            logger.LogInformation("üîó Iniciando associa√ß√£o de permiss√µes...");
            await AssociarPermissoesAosPapeis(context, roleManager, logger);

            // 6. Criar usu√°rio Super Admin
            logger.LogInformation("üëë Iniciando cria√ß√£o do Super Admin...");
            await CriarSuperAdmin(userManager, logger);

            // 7. Criar grupos base
            logger.LogInformation("üë• Iniciando cria√ß√£o de grupos...");
            await CriarGruposBase(context, logger);

            // ‚úÖ Salvar todas as mudan√ßas
            logger.LogInformation("üíæ Salvando mudan√ßas no banco...");
            var changesSaved = await context.SaveChangesAsync();
            logger.LogInformation($"üíæ {changesSaved} mudan√ßas salvas no banco");

            logger.LogInformation("‚úÖ Seeder executado com sucesso!");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "‚ùå Erro durante a execu√ß√£o do seeder: {Message}", ex.Message);
            throw;
        }
    }

    private static async Task CriarAplicacoesOpenIddict(IOpenIddictApplicationManager applicationManager, ILogger logger)
    {
        logger.LogInformation("üîß Criando aplica√ß√µes OpenIddict...");

        // Aplica√ß√£o para API (Resource Server)
        if (await applicationManager.FindByClientIdAsync("gestus_api") == null)
        {
            await applicationManager.CreateAsync(new OpenIddictApplicationDescriptor
            {
                ClientId = "gestus_api",
                ClientSecret = "gestus_api_secret_2024",
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus API",
                ClientType = OpenIddictConstants.ClientTypes.Confidential,
                Permissions =
                {
                    OpenIddictConstants.Permissions.Endpoints.Token,
                    OpenIddictConstants.Permissions.Endpoints.Introspection,
                    OpenIddictConstants.Permissions.GrantTypes.ClientCredentials,
                    OpenIddictConstants.Permissions.GrantTypes.Password,
                    OpenIddictConstants.Permissions.GrantTypes.RefreshToken,
                    
                    // ‚úÖ CORRIGIDO: Usar scopes que realmente existem
                    OpenIddictConstants.Permissions.Scopes.Email,
                    OpenIddictConstants.Permissions.Scopes.Profile,
                    OpenIddictConstants.Permissions.Scopes.Roles,
                    // ‚úÖ ADICIONADO: Scope customizado para openid via string
                    "scp:openid"
                }
            });

            logger.LogInformation("‚úÖ Aplica√ß√£o 'gestus_api' criada no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o 'gestus_api' j√° existe no OpenIddict");
        }

        // Aplica√ß√£o para Frontend (SPA)
        if (await applicationManager.FindByClientIdAsync("gestus_spa") == null)
        {
            await applicationManager.CreateAsync(new OpenIddictApplicationDescriptor
            {
                ClientId = "gestus_spa",
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus SPA",
                ClientType = OpenIddictConstants.ClientTypes.Public,
                PostLogoutRedirectUris =
                {
                    new Uri("https://localhost:3000/"),
                    new Uri("http://localhost:3000/")
                },
                RedirectUris =
                {
                    new Uri("https://localhost:3000/callback"),
                    new Uri("http://localhost:3000/callback")
                },
                Permissions =
                {
                    OpenIddictConstants.Permissions.Endpoints.Authorization,
                    OpenIddictConstants.Permissions.Endpoints.Token,
                    OpenIddictConstants.Permissions.GrantTypes.AuthorizationCode,
                    OpenIddictConstants.Permissions.GrantTypes.RefreshToken,
                    OpenIddictConstants.Permissions.ResponseTypes.Code,
                    
                    // ‚úÖ CORRIGIDO: Usar scopes que realmente existem
                    OpenIddictConstants.Permissions.Scopes.Email,
                    OpenIddictConstants.Permissions.Scopes.Profile,
                    OpenIddictConstants.Permissions.Scopes.Roles,
                    // ‚úÖ ADICIONADO: Scope customizado para openid via string
                    "scp:openid"
                },
                Requirements =
                {
                    OpenIddictConstants.Requirements.Features.ProofKeyForCodeExchange
                }
            });

            logger.LogInformation("‚úÖ Aplica√ß√£o 'gestus_spa' criada no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o 'gestus_spa' j√° existe no OpenIddict");
        }
    }

    private static async Task CriarPapeisBase(RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üìã Criando pap√©is base...");

        var papeisBase = new[]
        {
            new { Nome = "SuperAdmin", Descricao = "Super Administrador - Controle total do sistema", Categoria = "Sistema", Nivel = 1000 },
            new { Nome = "Admin", Descricao = "Administrador - Gerenciamento operacional", Categoria = "Sistema", Nivel = 500 },
            new { Nome = "Usuario", Descricao = "Usu√°rio - Acesso b√°sico ao sistema", Categoria = "Sistema", Nivel = 100 },
            
            // Pap√©is funcionais adicionais
            new { Nome = "GestorUsuarios", Descricao = "Gestor de Usu√°rios - Pode gerenciar usu√°rios", Categoria = "Funcional", Nivel = 300 },
            new { Nome = "GestorPermissoes", Descricao = "Gestor de Permiss√µes - Pode gerenciar permiss√µes", Categoria = "Funcional", Nivel = 400 },
            new { Nome = "Auditor", Descricao = "Auditor - Acesso apenas leitura para auditoria", Categoria = "Funcional", Nivel = 200 }
        };

        var papeisCountAntes = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes antes: {papeisCountAntes}");

        foreach (var papelInfo in papeisBase)
        {
            logger.LogInformation($"üìã Verificando papel: {papelInfo.Nome}");

            if (!await roleManager.RoleExistsAsync(papelInfo.Nome))
            {
                logger.LogInformation($"üìã Criando papel: {papelInfo.Nome}");

                var papel = new Papel
                {
                    Name = papelInfo.Nome,
                    NormalizedName = papelInfo.Nome.ToUpperInvariant(),
                    Descricao = papelInfo.Descricao,
                    Categoria = papelInfo.Categoria,
                    Nivel = papelInfo.Nivel,
                    Ativo = true,
                    DataCriacao = DateTime.UtcNow
                };

                var resultado = await roleManager.CreateAsync(papel);
                if (resultado.Succeeded)
                {
                    logger.LogInformation($"‚úÖ Papel '{papelInfo.Nome}' criado com sucesso (ID: {papel.Id})");
                }
                else
                {
                    logger.LogError($"‚ùå Erro ao criar papel '{papelInfo.Nome}': {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Papel '{papelInfo.Nome}' j√° existe");
            }
        }

        var papeisCountDepois = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes depois: {papeisCountDepois}");
    }

    private static async Task CriarSuperAdmin(UserManager<Usuario> userManager, ILogger logger)
    {
        logger.LogInformation("üëë Criando usu√°rio Super Admin...");

        const string emailSuperAdmin = "super@gestus.local";
        const string senhaSuperAdmin = "Reboot3!";

        logger.LogInformation($"üëë Verificando se usu√°rio {emailSuperAdmin} j√° existe...");
        
        var superAdminExiste = await userManager.FindByEmailAsync(emailSuperAdmin);
        if (superAdminExiste == null)
        {
            logger.LogInformation($"üëë Usu√°rio n√£o existe. Criando {emailSuperAdmin}...");
            
            var superAdmin = new Usuario
            {
                UserName = emailSuperAdmin,
                Email = emailSuperAdmin,
                EmailConfirmed = true,
                Nome = "Super",
                Sobrenome = "Administrador",
                NomeCompleto = "Super Administrador",
                Ativo = true,
                DataCriacao = DateTime.UtcNow,
                Observacoes = "Usu√°rio Super Admin criado automaticamente pelo seeder"
            };

            logger.LogInformation($"üëë Tentando criar usu√°rio...");
            var resultado = await userManager.CreateAsync(superAdmin, senhaSuperAdmin);
            
            if (resultado.Succeeded)
            {
                logger.LogInformation($"‚úÖ Usu√°rio criado com sucesso! ID: {superAdmin.Id}");
                
                // Verificar se o papel SuperAdmin existe
                var papelSuperAdminExiste = await userManager.IsInRoleAsync(superAdmin, "SuperAdmin");
                logger.LogInformation($"üîç Usu√°rio j√° tem papel SuperAdmin: {papelSuperAdminExiste}");
                
                if (!papelSuperAdminExiste)
                {
                    logger.LogInformation($"üëë Adicionando papel SuperAdmin ao usu√°rio...");
                    var resultadoPapel = await userManager.AddToRoleAsync(superAdmin, "SuperAdmin");
                    
                    if (resultadoPapel.Succeeded)
                    {
                        logger.LogInformation($"‚úÖ Papel SuperAdmin adicionado com sucesso!");
                    }
                    else
                    {
                        logger.LogError($"‚ùå Erro ao adicionar papel: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                    }
                }
                
                logger.LogInformation($"‚úÖ Super Admin criado: {emailSuperAdmin}");
                logger.LogInformation($"üîë Credenciais: {emailSuperAdmin} / {senhaSuperAdmin}");
            }
            else
            {
                logger.LogError($"‚ùå Erro ao criar Super Admin: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                
                // Log mais detalhado dos erros
                foreach (var error in resultado.Errors)
                {
                    logger.LogError($"‚ùå Erro espec√≠fico - C√≥digo: {error.Code}, Descri√ß√£o: {error.Description}");
                }
            }
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è  Super Admin j√° existe (ID: {superAdminExiste.Id})");
            
            // Verificar se tem o papel correto
            var temPapel = await userManager.IsInRoleAsync(superAdminExiste, "SuperAdmin");
            logger.LogInformation($"üîç Usu√°rio tem papel SuperAdmin: {temPapel}");
            
            if (!temPapel)
            {
                logger.LogInformation($"üëë Adicionando papel SuperAdmin ao usu√°rio existente...");
                await userManager.AddToRoleAsync(superAdminExiste, "SuperAdmin");
            }
        }
        
        // ‚úÖ Verifica√ß√£o final
        var usuarioFinal = await userManager.FindByEmailAsync(emailSuperAdmin);
        if (usuarioFinal != null)
        {
            var papeis = await userManager.GetRolesAsync(usuarioFinal);
            logger.LogInformation($"‚úÖ Usu√°rio final - ID: {usuarioFinal.Id}, Pap√©is: {string.Join(", ", papeis)}");
        }
    }

    private static async Task CriarPermissoesBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üîê Criando permiss√µes base...");

        var permissoesCountAntes = await context.Permissoes.CountAsync();
        logger.LogInformation($"üîê Permiss√µes existentes antes: {permissoesCountAntes}");

        var permissoesBase = new[]
        {
            // Permiss√µes de Sistema (Super Admin)
            new { Nome = "Sistema.Controle.Total", Descricao = "Controle total do sistema", Recurso = "Sistema", Acao = "Total", Categoria = "Sistema" },
            new { Nome = "Sistema.Configuracao.Gerenciar", Descricao = "Gerenciar configura√ß√µes do sistema", Recurso = "Sistema", Acao = "Gerenciar", Categoria = "Sistema" },
            
            // Permiss√µes de Usu√°rios
            new { Nome = "Usuarios.Criar", Descricao = "Criar novos usu√°rios", Recurso = "Usuarios", Acao = "Criar", Categoria = "Usuarios" },
            new { Nome = "Usuarios.Listar", Descricao = "Listar usu√°rios", Recurso = "Usuarios", Acao = "Listar", Categoria = "Usuarios" },
            new { Nome = "Usuarios.Visualizar", Descricao = "Visualizar detalhes de usu√°rios", Recurso = "Usuarios", Acao = "Visualizar", Categoria = "Usuarios" },
            new { Nome = "Usuarios.Editar", Descricao = "Editar usu√°rios", Recurso = "Usuarios", Acao = "Editar", Categoria = "Usuarios" },
            new { Nome = "Usuarios.Excluir", Descricao = "Excluir usu√°rios", Recurso = "Usuarios", Acao = "Excluir", Categoria = "Usuarios" },
            new { Nome = "Usuarios.GerenciarPapeis", Descricao = "Gerenciar pap√©is de usu√°rios", Recurso = "Usuarios", Acao = "GerenciarPapeis", Categoria = "Usuarios" },
            
            // Permiss√µes de Pap√©is
            new { Nome = "Papeis.Criar", Descricao = "Criar novos pap√©is", Recurso = "Papeis", Acao = "Criar", Categoria = "Papeis" },
            new { Nome = "Papeis.Listar", Descricao = "Listar pap√©is", Recurso = "Papeis", Acao = "Listar", Categoria = "Papeis" },
            new { Nome = "Papeis.Visualizar", Descricao = "Visualizar detalhes de pap√©is", Recurso = "Papeis", Acao = "Visualizar", Categoria = "Papeis" },
            new { Nome = "Papeis.Editar", Descricao = "Editar pap√©is", Recurso = "Papeis", Acao = "Editar", Categoria = "Papeis" },
            new { Nome = "Papeis.Excluir", Descricao = "Excluir pap√©is", Recurso = "Papeis", Acao = "Excluir", Categoria = "Papeis" },
            new { Nome = "Papeis.GerenciarPermissoes", Descricao = "Gerenciar permiss√µes de pap√©is", Recurso = "Papeis", Acao = "GerenciarPermissoes", Categoria = "Papeis" },
            
            // Permiss√µes de Permiss√µes
            new { Nome = "Permissoes.Criar", Descricao = "Criar novas permiss√µes", Recurso = "Permissoes", Acao = "Criar", Categoria = "Permissoes" },
            new { Nome = "Permissoes.Listar", Descricao = "Listar permiss√µes", Recurso = "Permissoes", Acao = "Listar", Categoria = "Permissoes" },
            new { Nome = "Permissoes.Visualizar", Descricao = "Visualizar detalhes de permiss√µes", Recurso = "Permissoes", Acao = "Visualizar", Categoria = "Permissoes" },
            new { Nome = "Permissoes.Editar", Descricao = "Editar permiss√µes", Recurso = "Permissoes", Acao = "Editar", Categoria = "Permissoes" },
            new { Nome = "Permissoes.Excluir", Descricao = "Excluir permiss√µes", Recurso = "Permissoes", Acao = "Excluir", Categoria = "Permissoes" },
            
            // Permiss√µes de Auditoria
            new { Nome = "Auditoria.Visualizar", Descricao = "Visualizar logs de auditoria", Recurso = "Auditoria", Acao = "Visualizar", Categoria = "Auditoria" },
            new { Nome = "Auditoria.Exportar", Descricao = "Exportar dados de auditoria", Recurso = "Auditoria", Acao = "Exportar", Categoria = "Auditoria" },
            
            // Permiss√µes de Grupos
            new { Nome = "Grupos.Criar", Descricao = "Criar novos grupos", Recurso = "Grupos", Acao = "Criar", Categoria = "Grupos" },
            new { Nome = "Grupos.Listar", Descricao = "Listar grupos", Recurso = "Grupos", Acao = "Listar", Categoria = "Grupos" },
            new { Nome = "Grupos.Visualizar", Descricao = "Visualizar detalhes de grupos", Recurso = "Grupos", Acao = "Visualizar", Categoria = "Grupos" },
            new { Nome = "Grupos.Editar", Descricao = "Editar grupos", Recurso = "Grupos", Acao = "Editar", Categoria = "Grupos" },
            new { Nome = "Grupos.Excluir", Descricao = "Excluir grupos", Recurso = "Grupos", Acao = "Excluir", Categoria = "Grupos" }
        };

        foreach (var permissaoInfo in permissoesBase)
        {
            var permissaoExiste = await context.Permissoes
                .AnyAsync(p => p.Recurso == permissaoInfo.Recurso && p.Acao == permissaoInfo.Acao);

            if (!permissaoExiste)
            {
                var permissao = new Permissao
                {
                    Nome = permissaoInfo.Nome,
                    Descricao = permissaoInfo.Descricao,
                    Recurso = permissaoInfo.Recurso,
                    Acao = permissaoInfo.Acao,
                    Categoria = permissaoInfo.Categoria,
                    Ativo = true,
                    DataCriacao = DateTime.UtcNow
                };

                context.Permissoes.Add(permissao);
                logger.LogInformation($"‚úÖ Permiss√£o '{permissaoInfo.Nome}' criada");
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Permiss√£o '{permissaoInfo.Nome}' j√° existe");
            }
        }

        await context.SaveChangesAsync();
        
        var permissoesCountDepois = await context.Permissoes.CountAsync();
        logger.LogInformation($"üîê Permiss√µes existentes depois: {permissoesCountDepois}");
    }

    private static async Task AssociarPermissoesAosPapeis(GestusDbContexto context, RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üîó Associando permiss√µes aos pap√©is...");

        // Super Admin: TODAS as permiss√µes
        var superAdminPapel = await roleManager.FindByNameAsync("SuperAdmin");
        if (superAdminPapel != null)
        {
            var todasPermissoes = await context.Permissoes.ToListAsync();
            await AssociarPermissoesAoPapel(context, superAdminPapel.Id, todasPermissoes, logger, "SuperAdmin");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è  Papel SuperAdmin n√£o encontrado para associar permiss√µes");
        }

        // Admin: Permiss√µes administrativas (exceto sistema total)
        var adminPapel = await roleManager.FindByNameAsync("Admin");
        if (adminPapel != null)
        {
            var permissoesAdmin = await context.Permissoes
                .Where(p => p.Categoria != "Sistema" || p.Acao != "Total")
                .ToListAsync();
            await AssociarPermissoesAoPapel(context, adminPapel.Id, permissoesAdmin, logger, "Admin");
        }

        // Usuario: Apenas permiss√µes de visualiza√ß√£o b√°sica
        var usuarioPapel = await roleManager.FindByNameAsync("Usuario");
        if (usuarioPapel != null)
        {
            var permissoesUsuario = await context.Permissoes
                .Where(p => p.Acao == "Listar" || p.Acao == "Visualizar")
                .Where(p => p.Categoria == "Usuarios" || p.Categoria == "Grupos")
                .ToListAsync();
            await AssociarPermissoesAoPapel(context, usuarioPapel.Id, permissoesUsuario, logger, "Usuario");
        }

        // GestorUsuarios: Todas as permiss√µes relacionadas a usu√°rios
        var gestorUsuariosPapel = await roleManager.FindByNameAsync("GestorUsuarios");
        if (gestorUsuariosPapel != null)
        {
            var permissoesGestorUsuarios = await context.Permissoes
                .Where(p => p.Categoria == "Usuarios")
                .ToListAsync();
            await AssociarPermissoesAoPapel(context, gestorUsuariosPapel.Id, permissoesGestorUsuarios, logger, "GestorUsuarios");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è  Papel GestorUsuarios n√£o encontrado para associar permiss√µes");
        }

        // GestorPermissoes: Permiss√µes para gerenciar pap√©is e permiss√µes
        var gestorPermissoesPapel = await roleManager.FindByNameAsync("GestorPermissoes");
        if (gestorPermissoesPapel != null)
        {
            var permissoesGestorPermissoes = await context.Permissoes
                .Where(p => p.Categoria == "Papeis" || p.Categoria == "Permissoes")
                .ToListAsync();
            await AssociarPermissoesAoPapel(context, gestorPermissoesPapel.Id, permissoesGestorPermissoes, logger, "GestorPermissoes");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è  Papel GestorPermissoes n√£o encontrado para associar permiss√µes");
        }

        // Auditor: Apenas permiss√µes de visualiza√ß√£o e auditoria
        var auditorPapel = await roleManager.FindByNameAsync("Auditor");
        if (auditorPapel != null)
        {
            var permissoesAuditor = await context.Permissoes
                .Where(p => p.Acao == "Visualizar" || p.Acao == "Listar" || p.Categoria == "Auditoria")
                .ToListAsync();
            await AssociarPermissoesAoPapel(context, auditorPapel.Id, permissoesAuditor, logger, "Auditor");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è  Papel Auditor n√£o encontrado para associar permiss√µes");
        }

        await context.SaveChangesAsync();
    }

    private static async Task AssociarPermissoesAoPapel(GestusDbContexto context, int papelId, List<Permissao> permissoes, ILogger logger, string nomePapel)
    {
        foreach (var permissao in permissoes)
        {
            var associacaoExiste = await context.PapelPermissoes
                .AnyAsync(pp => pp.PapelId == papelId && pp.PermissaoId == permissao.Id);

            if (!associacaoExiste)
            {
                var papelPermissao = new PapelPermissao
                {
                    PapelId = papelId,
                    PermissaoId = permissao.Id,
                    Ativo = true,
                    DataAtribuicao = DateTime.UtcNow
                };

                context.PapelPermissoes.Add(papelPermissao);
            }
        }

        logger.LogInformation($"üîó Permiss√µes associadas ao papel '{nomePapel}': {permissoes.Count}");
    }

    private static async Task CriarScopesOpenIddict(IOpenIddictScopeManager scopeManager, ILogger logger)
    {
        logger.LogInformation("üîß Criando scopes OpenIddict...");

        // Scope profile
        if (await scopeManager.FindByNameAsync("profile") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "profile",
                DisplayName = "Profile",
                Description = "Acesso √†s informa√ß√µes b√°sicas do perfil do usu√°rio",
                Resources =
                {
                    "gestus_api"
                }
            });

            logger.LogInformation("‚úÖ Scope 'profile' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'profile' j√° existe no OpenIddict");
        }

        // Scope email
        if (await scopeManager.FindByNameAsync("email") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "email",
                DisplayName = "Email",
                Description = "Acesso ao endere√ßo de email do usu√°rio",
                Resources =
                {
                    "gestus_api"
                }
            });

            logger.LogInformation("‚úÖ Scope 'email' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'email' j√° existe no OpenIddict");
        }

        // Scope roles
        if (await scopeManager.FindByNameAsync("roles") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "roles",
                DisplayName = "Roles",
                Description = "Acesso aos pap√©is e permiss√µes do usu√°rio",
                Resources =
                {
                    "gestus_api"
                }
            });

            logger.LogInformation("‚úÖ Scope 'roles' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'roles' j√° existe no OpenIddict");
        }
    }

    private static async Task CriarGruposBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üë• Criando grupos base...");

        var gruposBase = new[]
        {
            new { Nome = "Administradores", Descricao = "Grupo dos administradores do sistema", Tipo = "Sistema" },
            new { Nome = "Gestores", Descricao = "Grupo dos gestores operacionais", Tipo = "Operacional" },
            new { Nome = "Usuarios", Descricao = "Grupo dos usu√°rios finais", Tipo = "Geral" },
            new { Nome = "Auditores", Descricao = "Grupo dos auditores do sistema", Tipo = "Auditoria" }
        };

        foreach (var grupoInfo in gruposBase)
        {
            var grupoExiste = await context.Grupos.AnyAsync(g => g.Nome == grupoInfo.Nome);
            if (!grupoExiste)
            {
                var grupo = new Grupo
                {
                    Nome = grupoInfo.Nome,
                    Descricao = grupoInfo.Descricao,
                    Tipo = grupoInfo.Tipo,
                    Ativo = true,
                    DataCriacao = DateTime.UtcNow
                };

                context.Grupos.Add(grupo);
                logger.LogInformation($"‚úÖ Grupo '{grupoInfo.Nome}' criado");
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Grupo '{grupoInfo.Nome}' j√° existe");
            }
        }

        await context.SaveChangesAsync();
    }
}