using Gestus.Modelos;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using OpenIddict.Abstractions;

namespace Gestus.Dados;

public static class SeederInicial
{
    public static async Task ExecutarAsync(IServiceProvider serviceProvider)
    {
        var context = serviceProvider.GetRequiredService<GestusDbContexto>();
        var userManager = serviceProvider.GetRequiredService<UserManager<Usuario>>();
        var roleManager = serviceProvider.GetRequiredService<RoleManager<Papel>>();
        var logger = serviceProvider.GetRequiredService<ILogger<Program>>();

        // ‚úÖ ADICIONAR: Gerenciador de aplica√ß√µes e scopes OpenIddict
        var applicationManager = serviceProvider.GetRequiredService<IOpenIddictApplicationManager>();
        var scopeManager = serviceProvider.GetRequiredService<IOpenIddictScopeManager>();

        try
        {
            logger.LogInformation("üå± Iniciando seeder de dados iniciais...");

            // Verificar conex√£o
            var canConnect = await context.Database.CanConnectAsync();
            logger.LogInformation($"üìä Conex√£o com banco: {(canConnect ? "OK" : "FALHOU")}");

            if (!canConnect)
            {
                logger.LogError("‚ùå N√£o foi poss√≠vel conectar ao banco de dados");
                return;
            }

            // 1. Criar scopes OpenIddict
            logger.LogInformation("üîß Iniciando cria√ß√£o de scopes OpenIddict...");
            await CriarScopesOpenIddict(scopeManager, logger);

            // 2. Criar aplica√ß√µes OpenIddict
            logger.LogInformation("üîß Iniciando cria√ß√£o de aplica√ß√µes OpenIddict...");
            await CriarAplicacoesOpenIddict(applicationManager, logger);

            // 3. Criar pap√©is base
            logger.LogInformation("üìã Iniciando cria√ß√£o de pap√©is...");
            await CriarPapeisBase(roleManager, logger);

            // 4. Criar permiss√µes base (incluindo as de email)
            logger.LogInformation("üîê Iniciando cria√ß√£o de permiss√µes...");
            await CriarPermissoesBase(context, logger);

            // 5. Associar permiss√µes aos pap√©is
            logger.LogInformation("üîó Iniciando associa√ß√£o de permiss√µes...");
            await AssociarPermissoesAosPapeis(context, roleManager, logger);

            // 6. Criar usu√°rio super admin
            logger.LogInformation("üëë Iniciando cria√ß√£o do Super Admin...");
            await CriarSuperAdmin(userManager, logger);

            // 7. Criar grupos base
            logger.LogInformation("üë• Iniciando cria√ß√£o de grupos...");
            await CriarGruposBase(context, logger);

            // 8. Salvar mudan√ßas
            logger.LogInformation("üíæ Salvando mudan√ßas no banco...");
            var mudancas = await context.SaveChangesAsync();
            logger.LogInformation($"üíæ {mudancas} mudan√ßas salvas no banco");

            logger.LogInformation("‚úÖ Seeder executado com sucesso!");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "‚ùå Erro durante a execu√ß√£o do seeder");
            throw;
        }
    }

    private static async Task CriarAplicacoesOpenIddict(IOpenIddictApplicationManager applicationManager, ILogger logger)
    {
        logger.LogInformation("üîß Criando aplica√ß√µes OpenIddict...");

        // Aplica√ß√£o para API (Resource Server)
        if (await applicationManager.FindByClientIdAsync("gestus_api") == null)
        {
            await applicationManager.CreateAsync(new OpenIddictApplicationDescriptor
            {
                ClientId = "gestus_api",
                ClientSecret = "gestus_api_secret_2024",
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus API",
                ClientType = OpenIddictConstants.ClientTypes.Confidential,
                Permissions =
                {
                    OpenIddictConstants.Permissions.Endpoints.Token,
                    OpenIddictConstants.Permissions.Endpoints.Introspection,
                    OpenIddictConstants.Permissions.GrantTypes.ClientCredentials,
                    OpenIddictConstants.Permissions.GrantTypes.Password,
                    OpenIddictConstants.Permissions.GrantTypes.RefreshToken,
                    OpenIddictConstants.Permissions.Scopes.Email,
                    OpenIddictConstants.Permissions.Scopes.Profile,
                    OpenIddictConstants.Permissions.Scopes.Roles,
                    "scp:openid"
                }
            });

            logger.LogInformation("‚úÖ Aplica√ß√£o 'gestus_api' criada no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o 'gestus_api' j√° existe no OpenIddict");
        }

        // Aplica√ß√£o para Frontend (SPA)
        if (await applicationManager.FindByClientIdAsync("gestus_spa") == null)
        {
            await applicationManager.CreateAsync(new OpenIddictApplicationDescriptor
            {
                ClientId = "gestus_spa",
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus SPA",
                ClientType = OpenIddictConstants.ClientTypes.Public,
                PostLogoutRedirectUris =
                {
                    new Uri("https://localhost:3000/"),
                    new Uri("http://localhost:3000/")
                },
                RedirectUris =
                {
                    new Uri("https://localhost:3000/callback"),
                    new Uri("http://localhost:3000/callback")
                },
                Permissions =
                {
                    OpenIddictConstants.Permissions.Endpoints.Authorization,
                    OpenIddictConstants.Permissions.Endpoints.Token,
                    OpenIddictConstants.Permissions.GrantTypes.AuthorizationCode,
                    OpenIddictConstants.Permissions.GrantTypes.RefreshToken,
                    OpenIddictConstants.Permissions.ResponseTypes.Code,
                    OpenIddictConstants.Permissions.Scopes.Email,
                    OpenIddictConstants.Permissions.Scopes.Profile,
                    OpenIddictConstants.Permissions.Scopes.Roles,
                    "scp:openid"
                },
                Requirements =
                {
                    OpenIddictConstants.Requirements.Features.ProofKeyForCodeExchange
                }
            });

            logger.LogInformation("‚úÖ Aplica√ß√£o 'gestus_spa' criada no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o 'gestus_spa' j√° existe no OpenIddict");
        }
    }

    private static async Task CriarPapeisBase(RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üìã Criando pap√©is base...");

        var papeisBase = new[]
        {
            new { Nome = "SuperAdmin", Descricao = "Super Administrador - Controle total do sistema", Categoria = "Sistema", Nivel = 1000 },
            new { Nome = "Admin", Descricao = "Administrador - Gerenciamento operacional", Categoria = "Sistema", Nivel = 500 },
            new { Nome = "Usuario", Descricao = "Usu√°rio - Acesso b√°sico ao sistema", Categoria = "Sistema", Nivel = 100 },
            new { Nome = "GestorUsuarios", Descricao = "Gestor de Usu√°rios - Pode gerenciar usu√°rios", Categoria = "Funcional", Nivel = 300 },
            new { Nome = "GestorPermissoes", Descricao = "Gestor de Permiss√µes - Pode gerenciar permiss√µes", Categoria = "Funcional", Nivel = 400 },
            new { Nome = "Auditor", Descricao = "Auditor - Acesso apenas leitura para auditoria", Categoria = "Funcional", Nivel = 200 }
        };

        var papeisCountAntes = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes antes: {papeisCountAntes}");

        foreach (var papelInfo in papeisBase)
        {
            logger.LogInformation($"üìã Verificando papel: {papelInfo.Nome}");

            if (!await roleManager.RoleExistsAsync(papelInfo.Nome))
            {
                var novoPapel = new Papel
                {
                    Name = papelInfo.Nome,
                    NormalizedName = papelInfo.Nome.ToUpper(),
                    Descricao = papelInfo.Descricao,
                    Categoria = papelInfo.Categoria,
                    Nivel = papelInfo.Nivel,
                    Ativo = true
                };

                var resultado = await roleManager.CreateAsync(novoPapel);
                if (resultado.Succeeded)
                {
                    logger.LogInformation($"‚úÖ Papel criado: {papelInfo.Nome}");
                }
                else
                {
                    logger.LogError($"‚ùå Erro ao criar papel {papelInfo.Nome}: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Papel '{papelInfo.Nome}' j√° existe");
            }
        }

        var papeisCountDepois = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes depois: {papeisCountDepois}");
    }

    private static async Task CriarSuperAdmin(UserManager<Usuario> userManager, ILogger logger)
    {
        logger.LogInformation("üëë Criando usu√°rio Super Admin...");

        const string emailSuperAdmin = "super@gestus.local";
        const string senhaSuperAdmin = "Reboot3!";

        logger.LogInformation($"üëë Verificando se usu√°rio {emailSuperAdmin} j√° existe...");
        
        var superAdminExiste = await userManager.FindByEmailAsync(emailSuperAdmin);
        if (superAdminExiste == null)
        {
            logger.LogInformation($"üëë Usu√°rio n√£o existe. Criando {emailSuperAdmin}...");
            
            var superAdmin = new Usuario
            {
                UserName = emailSuperAdmin,
                Email = emailSuperAdmin,
                EmailConfirmed = true,
                Nome = "Super",
                Sobrenome = "Administrador",
                NomeCompleto = "Super Administrador",
                Ativo = true,
                DataCriacao = DateTime.UtcNow,
                Observacoes = "Usu√°rio Super Admin criado automaticamente pelo seeder"
            };

            logger.LogInformation($"üëë Tentando criar usu√°rio...");
            var resultado = await userManager.CreateAsync(superAdmin, senhaSuperAdmin);
            
            if (resultado.Succeeded)
            {
                logger.LogInformation($"‚úÖ Usu√°rio criado com sucesso! ID: {superAdmin.Id}");
                
                // Verificar se o papel SuperAdmin existe
                var papelSuperAdminExiste = await userManager.IsInRoleAsync(superAdmin, "SuperAdmin");
                logger.LogInformation($"üîç Usu√°rio j√° tem papel SuperAdmin: {papelSuperAdminExiste}");
                
                if (!papelSuperAdminExiste)
                {
                    logger.LogInformation($"üëë Adicionando papel SuperAdmin ao usu√°rio...");
                    var resultadoPapel = await userManager.AddToRoleAsync(superAdmin, "SuperAdmin");
                    
                    if (resultadoPapel.Succeeded)
                    {
                        logger.LogInformation($"‚úÖ Papel SuperAdmin adicionado com sucesso!");
                    }
                    else
                    {
                        logger.LogError($"‚ùå Erro ao adicionar papel: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                    }
                }
                
                logger.LogInformation($"‚úÖ Super Admin criado: {emailSuperAdmin}");
                logger.LogInformation($"üîë Credenciais: {emailSuperAdmin} / {senhaSuperAdmin}");
            }
            else
            {
                logger.LogError($"‚ùå Erro ao criar Super Admin: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                
                // Log mais detalhado dos erros
                foreach (var error in resultado.Errors)
                {
                    logger.LogError($"‚ùå Erro espec√≠fico: {error.Code} - {error.Description}");
                }
            }
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è  Super Admin j√° existe (ID: {superAdminExiste.Id})");
            
            // Verificar se tem o papel correto
            var temPapel = await userManager.IsInRoleAsync(superAdminExiste, "SuperAdmin");
            logger.LogInformation($"üîç Usu√°rio tem papel SuperAdmin: {temPapel}");
            
            if (!temPapel)
            {
                logger.LogInformation($"üëë Adicionando papel SuperAdmin ao usu√°rio existente...");
                await userManager.AddToRoleAsync(superAdminExiste, "SuperAdmin");
            }
        }
        
        // ‚úÖ Verifica√ß√£o final
        var usuarioFinal = await userManager.FindByEmailAsync(emailSuperAdmin);
        if (usuarioFinal != null)
        {
            var papeis = await userManager.GetRolesAsync(usuarioFinal);
            logger.LogInformation($"‚úÖ Usu√°rio final - ID: {usuarioFinal.Id}, Pap√©is: {string.Join(", ", papeis)}");
        }
    }

    private static async Task CriarPermissoesBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üîê Criando permiss√µes base...");

        var permissoesCountAntes = await context.Permissoes.CountAsync();
        logger.LogInformation($"üîê Permiss√µes existentes antes: {permissoesCountAntes}");

        // ‚úÖ PERMISS√ïES ATUALIZADAS COM SISTEMA DE EMAIL
        var permissoesBase = new[]
        {
            // Sistema
            new { Nome = "Sistema.Controle.Total", Descricao = "Controle total do sistema", Recurso = "Sistema", Acao = "Controle", Categoria = "Sistema" },
            new { Nome = "Sistema.Configuracao.Gerenciar", Descricao = "Gerenciar configura√ß√µes do sistema", Recurso = "Sistema", Acao = "Configuracao", Categoria = "Sistema" },
            
            // ‚úÖ NOVAS PERMISS√ïES DE EMAIL
            new { Nome = "sistema.email.ler", Descricao = "Visualizar configura√ß√µes de email", Recurso = "Sistema", Acao = "EmailLer", Categoria = "Email" },
            new { Nome = "sistema.email.configurar", Descricao = "Configurar sistema de email", Recurso = "Sistema", Acao = "EmailConfigurar", Categoria = "Email" },
            new { Nome = "sistema.email.testar", Descricao = "Testar configura√ß√µes de email", Recurso = "Sistema", Acao = "EmailTestar", Categoria = "Email" },
            
            // ‚úÖ NOVAS PERMISS√ïES DE TEMPLATES
            new { Nome = "templates.criar", Descricao = "Criar templates de email", Recurso = "Templates", Acao = "Criar", Categoria = "Email" },
            new { Nome = "templates.editar", Descricao = "Editar templates de email", Recurso = "Templates", Acao = "Editar", Categoria = "Email" },
            new { Nome = "templates.excluir", Descricao = "Excluir templates de email", Recurso = "Templates", Acao = "Excluir", Categoria = "Email" },
            new { Nome = "templates.testar", Descricao = "Testar templates de email", Recurso = "Templates", Acao = "Testar", Categoria = "Email" },
            new { Nome = "sistema.configurar", Descricao = "Configurar sistema", Recurso = "Sistema", Acao = "Configurar", Categoria = "Sistema" },

            // Usu√°rios
            new { Nome = "Usuarios.Criar", Descricao = "Criar novos usu√°rios", Recurso = "Usuarios", Acao = "Criar", Categoria = "Gest√£o" },
            new { Nome = "Usuarios.Listar", Descricao = "Listar usu√°rios", Recurso = "Usuarios", Acao = "Listar", Categoria = "Gest√£o" },
            new { Nome = "Usuarios.Visualizar", Descricao = "Visualizar detalhes de usu√°rios", Recurso = "Usuarios", Acao = "Visualizar", Categoria = "Gest√£o" },
            new { Nome = "Usuarios.Editar", Descricao = "Editar usu√°rios existentes", Recurso = "Usuarios", Acao = "Editar", Categoria = "Gest√£o" },
            new { Nome = "Usuarios.Excluir", Descricao = "Excluir usu√°rios", Recurso = "Usuarios", Acao = "Excluir", Categoria = "Gest√£o" },
            new { Nome = "Usuarios.GerenciarPapeis", Descricao = "Gerenciar pap√©is de usu√°rios", Recurso = "Usuarios", Acao = "GerenciarPapeis", Categoria = "Gest√£o" },

            // Pap√©is
            new { Nome = "Papeis.Criar", Descricao = "Criar novos pap√©is", Recurso = "Papeis", Acao = "Criar", Categoria = "Seguran√ßa" },
            new { Nome = "Papeis.Listar", Descricao = "Listar pap√©is", Recurso = "Papeis", Acao = "Listar", Categoria = "Seguran√ßa" },
            new { Nome = "Papeis.Visualizar", Descricao = "Visualizar detalhes de pap√©is", Recurso = "Papeis", Acao = "Visualizar", Categoria = "Seguran√ßa" },
            new { Nome = "Papeis.Editar", Descricao = "Editar pap√©is existentes", Recurso = "Papeis", Acao = "Editar", Categoria = "Seguran√ßa" },
            new { Nome = "Papeis.Excluir", Descricao = "Excluir pap√©is", Recurso = "Papeis", Acao = "Excluir", Categoria = "Seguran√ßa" },
            new { Nome = "Papeis.GerenciarPermissoes", Descricao = "Gerenciar permiss√µes de pap√©is", Recurso = "Papeis", Acao = "GerenciarPermissoes", Categoria = "Seguran√ßa" },

            // Permiss√µes
            new { Nome = "Permissoes.Criar", Descricao = "Criar novas permiss√µes", Recurso = "Permissoes", Acao = "Criar", Categoria = "Seguran√ßa" },
            new { Nome = "Permissoes.Listar", Descricao = "Listar permiss√µes", Recurso = "Permissoes", Acao = "Listar", Categoria = "Seguran√ßa" },
            new { Nome = "Permissoes.Visualizar", Descricao = "Visualizar detalhes de permiss√µes", Recurso = "Permissoes", Acao = "Visualizar", Categoria = "Seguran√ßa" },
            new { Nome = "Permissoes.Editar", Descricao = "Editar permiss√µes existentes", Recurso = "Permissoes", Acao = "Editar", Categoria = "Seguran√ßa" },
            new { Nome = "Permissoes.Excluir", Descricao = "Excluir permiss√µes", Recurso = "Permissoes", Acao = "Excluir", Categoria = "Seguran√ßa" },

            // Auditoria
            new { Nome = "Auditoria.Visualizar", Descricao = "Visualizar logs de auditoria", Recurso = "Auditoria", Acao = "Visualizar", Categoria = "Auditoria" },
            new { Nome = "Auditoria.Exportar", Descricao = "Exportar logs de auditoria", Recurso = "Auditoria", Acao = "Exportar", Categoria = "Auditoria" },

            // Grupos
            new { Nome = "Grupos.Criar", Descricao = "Criar novos grupos", Recurso = "Grupos", Acao = "Criar", Categoria = "Gest√£o" },
            new { Nome = "Grupos.Listar", Descricao = "Listar grupos", Recurso = "Grupos", Acao = "Listar", Categoria = "Gest√£o" },
            new { Nome = "Grupos.Visualizar", Descricao = "Visualizar detalhes de grupos", Recurso = "Grupos", Acao = "Visualizar", Categoria = "Gest√£o" },
            new { Nome = "Grupos.Editar", Descricao = "Editar grupos existentes", Recurso = "Grupos", Acao = "Editar", Categoria = "Gest√£o" },
            new { Nome = "Grupos.Excluir", Descricao = "Excluir grupos", Recurso = "Grupos", Acao = "Excluir", Categoria = "Gest√£o" }
        };

        foreach (var permissaoInfo in permissoesBase)
        {
            var permissaoExiste = await context.Permissoes
                .AnyAsync(p => p.Nome == permissaoInfo.Nome);

            if (!permissaoExiste)
            {
                var novaPermissao = new Permissao
                {
                    Nome = permissaoInfo.Nome,
                    Descricao = permissaoInfo.Descricao,
                    Recurso = permissaoInfo.Recurso,
                    Acao = permissaoInfo.Acao,
                    Categoria = permissaoInfo.Categoria,
                    Ativo = true
                };

                context.Permissoes.Add(novaPermissao);
                logger.LogInformation($"‚úÖ Permiss√£o criada: {permissaoInfo.Nome}");
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Permiss√£o '{permissaoInfo.Nome}' j√° existe");
            }
        }

        var permissoesCountDepois = await context.Permissoes.CountAsync();
        logger.LogInformation($"üîê Permiss√µes existentes depois: {permissoesCountDepois}");
    }

    private static async Task AssociarPermissoesAosPapeis(GestusDbContexto context, RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üîó Associando permiss√µes aos pap√©is...");

        var todasPermissoes = await context.Permissoes.Where(p => p.Ativo).ToListAsync();

        // SuperAdmin - TODAS as permiss√µes (incluindo as novas de email)
        var superAdminPapel = await roleManager.FindByNameAsync("SuperAdmin");
        if (superAdminPapel != null)
        {
            await AssociarPermissoesAoPapel(context, superAdminPapel.Id, todasPermissoes, logger, "SuperAdmin");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è Papel SuperAdmin n√£o encontrado");
        }

        // Admin - Todas exceto controle total
        var adminPapel = await roleManager.FindByNameAsync("Admin");
        if (adminPapel != null)
        {
            var permissoesAdmin = todasPermissoes
                .Where(p => p.Nome != "Sistema.Controle.Total")
                .ToList();
            await AssociarPermissoesAoPapel(context, adminPapel.Id, permissoesAdmin, logger, "Admin");
        }

        // Usuario - Permiss√µes b√°sicas + visualizar configura√ß√µes de email
        var usuarioPapel = await roleManager.FindByNameAsync("Usuario");
        if (usuarioPapel != null)
        {
            var permissoesUsuario = todasPermissoes
                .Where(p => p.Nome == "Usuarios.Visualizar" || 
                           p.Nome == "Papeis.Visualizar" || 
                           p.Nome == "Permissoes.Visualizar" ||
                           p.Nome == "sistema.email.ler") // ‚úÖ ADICIONADO
                .ToList();
            await AssociarPermissoesAoPapel(context, usuarioPapel.Id, permissoesUsuario, logger, "Usuario");
        }

        // GestorUsuarios - Gest√£o de usu√°rios + email
        var gestorUsuariosPapel = await roleManager.FindByNameAsync("GestorUsuarios");
        if (gestorUsuariosPapel != null)
        {
            var permissoesGestorUsuarios = todasPermissoes
                .Where(p => p.Recurso == "Usuarios" || 
                           p.Nome == "sistema.email.ler" ||
                           p.Nome == "templates.testar")
                .ToList();
            await AssociarPermissoesAoPapel(context, gestorUsuariosPapel.Id, permissoesGestorUsuarios, logger, "GestorUsuarios");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è Papel GestorUsuarios n√£o encontrado");
        }

        // GestorPermissoes - Gest√£o de permiss√µes e pap√©is + email
        var gestorPermissoesPapel = await roleManager.FindByNameAsync("GestorPermissoes");
        if (gestorPermissoesPapel != null)
        {
            var permissoesGestorPermissoes = todasPermissoes
                .Where(p => p.Recurso == "Permissoes" || 
                           p.Recurso == "Papeis" ||
                           p.Nome == "sistema.email.ler" ||
                           p.Nome == "templates.criar" ||
                           p.Nome == "templates.editar")
                .ToList();
            await AssociarPermissoesAoPapel(context, gestorPermissoesPapel.Id, permissoesGestorPermissoes, logger, "GestorPermissoes");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è Papel GestorPermissoes n√£o encontrado");
        }

        // Auditor - Apenas visualiza√ß√£o + leitura de email
        var auditorPapel = await roleManager.FindByNameAsync("Auditor");
        if (auditorPapel != null)
        {
            var permissoesAuditor = todasPermissoes
                .Where(p => p.Acao == "Visualizar" || 
                           p.Acao == "Listar" || 
                           p.Recurso == "Auditoria" ||
                           p.Nome == "sistema.email.ler")
                .ToList();
            await AssociarPermissoesAoPapel(context, auditorPapel.Id, permissoesAuditor, logger, "Auditor");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è Papel Auditor n√£o encontrado");
        }
    }

    private static async Task AssociarPermissoesAoPapel(GestusDbContexto context, int papelId, List<Permissao> permissoes, ILogger logger, string nomePapel)
    {
        var permissoesExistentes = await context.Set<PapelPermissao>()
            .Where(pp => pp.PapelId == papelId)
            .Select(pp => pp.PermissaoId)
            .ToListAsync();

        var novasPermissoes = permissoes
            .Where(p => !permissoesExistentes.Contains(p.Id))
            .ToList();

        foreach (var permissao in novasPermissoes)
        {
            var papelPermissao = new PapelPermissao
            {
                PapelId = papelId,
                PermissaoId = permissao.Id
            };

            context.Set<PapelPermissao>().Add(papelPermissao);
        }

        var totalPermissoes = permissoesExistentes.Count + novasPermissoes.Count;
        logger.LogInformation($"üîó Permiss√µes associadas ao papel '{nomePapel}': {totalPermissoes}");
    }

    private static async Task CriarScopesOpenIddict(IOpenIddictScopeManager scopeManager, ILogger logger)
    {
        logger.LogInformation("üîß Criando scopes OpenIddict...");

        if (await scopeManager.FindByNameAsync("profile") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "profile",
                DisplayName = "Profile",
                Description = "Profile information",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'profile' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'profile' j√° existe no OpenIddict");
        }

        if (await scopeManager.FindByNameAsync("email") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "email",
                DisplayName = "Email",
                Description = "Email address",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'email' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'email' j√° existe no OpenIddict");
        }

        if (await scopeManager.FindByNameAsync("roles") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "roles",
                DisplayName = "Roles",
                Description = "User roles and permissions",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'roles' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'roles' j√° existe no OpenIddict");
        }
    }

    private static async Task CriarGruposBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üë• Criando grupos base...");

        var gruposBase = new[]
        {
            new { Nome = "Administradores", Descricao = "Grupo de administradores do sistema", Tipo = "Sistema" },
            new { Nome = "Gestores", Descricao = "Grupo de gestores operacionais", Tipo = "Operacional" },
            new { Nome = "Usuarios", Descricao = "Grupo de usu√°rios padr√£o", Tipo = "Geral" },
            new { Nome = "Auditores", Descricao = "Grupo de auditores", Tipo = "Funcional" }
        };

        foreach (var grupoInfo in gruposBase)
        {
            var grupoExiste = await context.Grupos
                .AnyAsync(g => g.Nome == grupoInfo.Nome);

            if (!grupoExiste)
            {
                var novoGrupo = new Grupo
                {
                    Nome = grupoInfo.Nome,
                    Descricao = grupoInfo.Descricao,
                    Tipo = grupoInfo.Tipo,
                    Ativo = true
                };

                context.Grupos.Add(novoGrupo);
                logger.LogInformation($"‚úÖ Grupo criado: {grupoInfo.Nome}");
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Grupo '{grupoInfo.Nome}' j√° existe");
            }
        }
    }
}