using Gestus.Modelos;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using OpenIddict.Abstractions;

namespace Gestus.Dados;

public static class SeederInicial
{
    public static async Task ExecutarAsync(IServiceProvider serviceProvider)
    {
        var context = serviceProvider.GetRequiredService<GestusDbContexto>();
        var userManager = serviceProvider.GetRequiredService<UserManager<Usuario>>();
        var roleManager = serviceProvider.GetRequiredService<RoleManager<Papel>>();
        var logger = serviceProvider.GetRequiredService<ILogger<Program>>();
        var configuration = serviceProvider.GetRequiredService<IConfiguration>();

        // ‚úÖ ADICIONAR: Gerenciador de aplica√ß√µes e scopes OpenIddict
        var applicationManager = serviceProvider.GetRequiredService<IOpenIddictApplicationManager>();
        var scopeManager = serviceProvider.GetRequiredService<IOpenIddictScopeManager>();

        try
        {
            logger.LogInformation("üå± Iniciando seeder de dados iniciais...");

            // Verificar conex√£o com banco
            var canConnect = await context.Database.CanConnectAsync();
            if (!canConnect)
            {
                logger.LogError("‚ùå N√£o foi poss√≠vel conectar ao banco de dados");
                return;
            }

            logger.LogInformation("üìä Conex√£o com banco: OK");

            // ‚úÖ ORDEM CORRETA DE EXECU√á√ÉO
            await CriarScopesOpenIddict(scopeManager, logger);
            await CriarAplicacoesOpenIddict(applicationManager, configuration, logger);
            await CriarPapeisBase(roleManager, logger);
            await CriarPermissoesBase(context, logger);
            await AssociarPermissoesAosPapeis(context, roleManager, logger);
            await CriarSuperAdmin(userManager, logger);
            await CriarGruposBase(context, logger);
            await CriarTemplatesEmail(context, logger);

            // ‚úÖ TIPOS/STATUS DE APLICA√á√ÉO E APLICA√á√ÉO GESTUS
            await CriarTiposStatusAplicacaoBase(context, logger);
            await CriarAplicacaoGestus(context, configuration, logger);

            // ‚úÖ CRIAR USU√ÅRIOS PADR√ÉO
            var superAdmin = await CriarSuperAdmin(userManager, logger);
            var adminUsuario = await CriarAdministrador(userManager, logger);

            // ‚úÖ CONCEDER ACESSO √Ä APLICA√á√ÉO GESTUS PARA SUPERADMIN E ADMIN
            await ConcederAcessoAplicacaoGestus(context, logger, superAdmin?.Id);
            await ConcederAcessoAplicacaoGestus(context, logger, adminUsuario?.Id);

            // Salvar mudan√ßas finais
            logger.LogInformation("üíæ Salvando mudan√ßas no banco...");
            var mudancasSalvas = await context.SaveChangesAsync();
            logger.LogInformation($"üíæ {mudancasSalvas} mudan√ßas salvas no banco");

            logger.LogInformation("‚úÖ Seeder executado com sucesso!");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "‚ùå Erro durante a execu√ß√£o do seeder");
            throw;
        }
    }

    private static async Task CriarTemplatesEmail(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üìß Criando templates de email...");

        // Buscar configura√ß√£o de email existente
        var configuracaoEmail = await context.Set<ConfiguracaoEmail>()
            .Where(c => c.Ativo)
            .FirstOrDefaultAsync();

        if (configuracaoEmail == null)
        {
            logger.LogWarning("‚ö†Ô∏è Nenhuma configura√ß√£o de email encontrada. Pulando cria√ß√£o de templates.");
            return;
        }

        // ‚úÖ CRIAR TODOS OS TEMPLATES DE UMA VEZ
        await CriarTemplateSeNaoExistir(context, configuracaoEmail.Id, "BoasVindas", logger);
        await CriarTemplateSeNaoExistir(context, configuracaoEmail.Id, "RecuperarSenha", logger);
        await CriarTemplateSeNaoExistir(context, configuracaoEmail.Id, "ConfirmarEmail", logger);
    }

    private static async Task CriarTemplateSeNaoExistir(GestusDbContexto context, int configuracaoEmailId, string tipo, ILogger logger)
    {
        var templateExists = await context.Set<TemplateEmail>()
            .AnyAsync(t => t.Tipo == tipo && t.ConfiguracaoEmailId == configuracaoEmailId);

        if (!templateExists)
        {
            var template = new TemplateEmail
            {
                ConfiguracaoEmailId = configuracaoEmailId,
                Tipo = tipo,
                Assunto = ObterAssuntoPadrao(tipo),
                CorpoHtml = ObterCorpoHtmlPadrao(tipo),
                CorpoTexto = ObterCorpoTextoPadrao(tipo),
                Ativo = true,
                DataCriacao = DateTime.UtcNow
            };

            context.Set<TemplateEmail>().Add(template);
            logger.LogInformation($"‚úÖ Template '{tipo}' criado");
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è Template '{tipo}' j√° existe");
        }
    }

    private static string ObterAssuntoPadrao(string tipo)
    {
        return tipo switch
        {
            "BoasVindas" => "Bem-vindo(a) ao {NomeSistema}!",
            "RecuperarSenha" => "Recupera√ß√£o de Senha - {NomeSistema}",
            "ConfirmarEmail" => "Confirme seu email - {NomeSistema}",
            _ => $"Notifica√ß√£o - {tipo}"
        };
    }

    private static string ObterCorpoHtmlPadrao(string tipo)
    {
        return tipo switch
        {
            "RecuperarSenha" => @"
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <title>Recupera√ß√£o de Senha</title>
    </head>
    <body style='margin: 0; padding: 20px; font-family: Arial, sans-serif; background-color: #f5f5f5;'>
        <div style='max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);'>
            <div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center;'>
                <h1 style='color: white; margin: 0; font-size: 28px; font-weight: 300;'>üîê Recupera√ß√£o de Senha</h1>
                <p style='color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;'>{NomeSistema}</p>
            </div>
            <div style='padding: 40px 30px;'>
                <h2 style='color: #333; margin: 0 0 20px 0; font-size: 24px; font-weight: 400;'>Ol√°, {NomeUsuario}!</h2>
                <p style='color: #666; line-height: 1.6; margin: 0 0 20px 0; font-size: 16px;'>
                    Recebemos uma solicita√ß√£o para redefinir a senha da sua conta em <strong>{EmailUsuario}</strong>.
                </p>
                <div style='text-align: center; margin: 30px 0;'>
                    <a href='{LinkRecuperacao}' style='display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: 500; font-size: 16px;'>
                        üîë Redefinir Senha
                    </a>
                </div>
                <div style='background: #f8f9ff; border-left: 4px solid #667eea; padding: 20px; margin: 30px 0; border-radius: 0 5px 5px 0;'>
                    <p style='margin: 0; color: #555; font-size: 14px; line-height: 1.5;'>
                        <strong>‚è∞ Importante:</strong> Este link expira em <strong>{DataExpiracao}</strong> por motivos de seguran√ßa.
                    </p>
                </div>
            </div>
            <div style='background: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e9ecef; text-align: center;'>
                <p style='margin: 0; color: #6c757d; font-size: 12px; line-height: 1.5;'>
                    Este √© um email autom√°tico do <strong>{NomeSistema}</strong>.<br>
                    Por favor, n√£o responda a este email.
                </p>
            </div>
        </div>
    </body>
    </html>",

            "BoasVindas" => @"
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <title>Bem-vindo!</title>
    </head>
    <body style='margin: 0; padding: 20px; font-family: Arial, sans-serif; background-color: #f5f5f5;'>
        <div style='max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);'>
            <div style='background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 30px; text-align: center;'>
                <h1 style='color: white; margin: 0; font-size: 28px; font-weight: 300;'>üéâ Bem-vindo!</h1>
                <p style='color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;'>{NomeSistema}</p>
            </div>
            <div style='padding: 40px 30px;'>
                <h2 style='color: #333; margin: 0 0 20px 0; font-size: 24px; font-weight: 400;'>Ol√°, {NomeUsuario}!</h2>
                <p style='color: #666; line-height: 1.6; margin: 0 0 20px 0; font-size: 16px;'>
                    Sua conta foi criada com sucesso no <strong>{NomeSistema}</strong>! üéä
                </p>
                <div style='text-align: center; margin: 30px 0;'>
                    <a href='{LinkLogin}' style='display: inline-block; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: 500; font-size: 16px;'>
                        üöÄ Acessar Sistema
                    </a>
                </div>
            </div>
            <div style='background: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e9ecef; text-align: center;'>
                <p style='margin: 0; color: #6c757d; font-size: 12px; line-height: 1.5;'>
                    Este √© um email autom√°tico do <strong>{NomeSistema}</strong>.
                </p>
            </div>
        </div>
    </body>
    </html>",

            "ConfirmarEmail" => @"
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <title>Confirmar Email</title>
    </head>
    <body style='margin: 0; padding: 20px; font-family: Arial, sans-serif; background-color: #f5f5f5;'>
        <div style='max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);'>
            <div style='background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); padding: 30px; text-align: center;'>
                <h1 style='color: white; margin: 0; font-size: 28px; font-weight: 300;'>üìß Confirmar Email</h1>
                <p style='color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;'>{NomeSistema}</p>
            </div>
            <div style='padding: 40px 30px;'>
                <h2 style='color: #333; margin: 0 0 20px 0; font-size: 24px; font-weight: 400;'>Ol√°, {NomeUsuario}!</h2>
                <p style='color: #666; line-height: 1.6; margin: 0 0 20px 0; font-size: 16px;'>
                    Para finalizar o cadastro, confirme seu email: <strong>{EmailUsuario}</strong>
                </p>
                <div style='text-align: center; margin: 30px 0;'>
                    <a href='{LinkConfirmacao}' style='display: inline-block; background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: 500; font-size: 16px;'>
                        ‚úÖ Confirmar Email
                    </a>
                </div>
            </div>
            <div style='background: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e9ecef; text-align: center;'>
                <p style='margin: 0; color: #6c757d; font-size: 12px; line-height: 1.5;'>
                    Este √© um email autom√°tico do <strong>{NomeSistema}</strong>.
                </p>
            </div>
        </div>
    </body>
    </html>",

            _ => $@"
    <html>
    <body>
        <h2>{tipo} - {{NomeSistema}}</h2>
        <p>Ol√° {{NomeUsuario}},</p>
        <p>Esta √© uma mensagem do sistema {{NomeSistema}}.</p>
        <p>Template padr√£o para o tipo: {tipo}</p>
    </body>
    </html>"
        };
    }

    private static string ObterCorpoTextoPadrao(string tipo)
    {
        return tipo switch
        {
            "RecuperarSenha" => @"
    RECUPERA√á√ÉO DE SENHA - {NomeSistema}

    Ol√° {NomeUsuario}!

    Recebemos uma solicita√ß√£o para redefinir a senha da sua conta ({EmailUsuario}).

    Para criar uma nova senha, acesse o link abaixo:
    {LinkRecuperacao}

    IMPORTANTE: Este link expira em {DataExpiracao} por motivos de seguran√ßa.

    Se voc√™ n√£o solicitou esta altera√ß√£o, pode ignorar este email.

    ---
    Este √© um email autom√°tico do {NomeSistema}.",

            "BoasVindas" => @"
    BEM-VINDO AO {NomeSistema}!

    Ol√° {NomeUsuario}!

    Sua conta foi criada com sucesso! 

    Email: {EmailUsuario}

    Para acessar o sistema, clique no link:
    {LinkLogin}

    ---
    Este √© um email autom√°tico do {NomeSistema}.",

            "ConfirmarEmail" => @"
    CONFIRMAR EMAIL - {NomeSistema}

    Ol√° {NomeUsuario}!

    Para finalizar o cadastro, confirme seu email: {EmailUsuario}

    Clique no link abaixo para confirmar:
    {LinkConfirmacao}

    Se voc√™ n√£o criou uma conta no {NomeSistema}, ignore este email.

    ---
    Este √© um email autom√°tico do {NomeSistema}.",

            _ => $@"
    {tipo.ToUpper()} - {{NomeSistema}}

    Ol√° {{NomeUsuario}},

    Esta √© uma mensagem do sistema {{NomeSistema}}.
    Template padr√£o para o tipo: {tipo}

    Email: {{EmailUsuario}}"
        };
    }

    private static async Task CriarAplicacoesOpenIddict(IOpenIddictApplicationManager applicationManager, IConfiguration configuration, ILogger logger)
    {
        logger.LogInformation("üîß Criando aplica√ß√µes OpenIddict...");

        // Carregar configura√ß√µes de clients do OpenIddict
        var oidcSection = configuration.GetSection("OpenIddict");
        var apiClientId = oidcSection.GetValue<string>("Api:ClientId") ?? "gestus_api";
        var apiClientSecret = oidcSection.GetValue<string>("Api:ClientSecret") ?? "gestus_api_secret_2024";

        var spaClientId = oidcSection.GetValue<string>("Spa:ClientId") ?? "gestus_spa";
        var spaRedirectUris = oidcSection.GetSection("Spa:RedirectUris").Get<string[]>() ?? Array.Empty<string>();
        var spaPostLogoutUris = oidcSection.GetSection("Spa:PostLogoutRedirectUris").Get<string[]>() ?? Array.Empty<string>();

        // Aplica√ß√£o para API (Resource Server)
        if (await applicationManager.FindByClientIdAsync(apiClientId) == null)
        {
            await applicationManager.CreateAsync(new OpenIddictApplicationDescriptor
            {
                ClientId = apiClientId,
                ClientSecret = apiClientSecret,
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus API",
                ClientType = OpenIddictConstants.ClientTypes.Confidential,
                Permissions =
        {
            OpenIddictConstants.Permissions.Endpoints.Token,
            OpenIddictConstants.Permissions.Endpoints.Introspection,
            OpenIddictConstants.Permissions.GrantTypes.ClientCredentials,
            OpenIddictConstants.Permissions.GrantTypes.Password,
            OpenIddictConstants.Permissions.GrantTypes.RefreshToken, // ‚úÖ Refresh token grant
            OpenIddictConstants.Permissions.Scopes.Email,
            OpenIddictConstants.Permissions.Scopes.Profile,
            OpenIddictConstants.Permissions.Scopes.Roles,
            // ‚úÖ CORRE√á√ÉO: Usar a constante correta para offline_access
            OpenIddictConstants.Permissions.Prefixes.Scope + OpenIddictConstants.Scopes.OfflineAccess,
            "scp:openid"
        }
            });

            logger.LogInformation("‚úÖ Aplica√ß√£o '{ClientId}' criada no OpenIddict", apiClientId);
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o '{ClientId}' j√° existe no OpenIddict", apiClientId);

            // ‚úÖ VERIFICAR SE PRECISA ATUALIZAR PERMISS√ïES
            var existingApp = await applicationManager.FindByClientIdAsync(apiClientId);
            if (existingApp != null)
            {
                var descriptor = new OpenIddictApplicationDescriptor();
                await applicationManager.PopulateAsync(descriptor, existingApp);

                // ‚úÖ CORRE√á√ÉO: Verificar com a constante correta
                var offlineAccessPermission = OpenIddictConstants.Permissions.Prefixes.Scope + OpenIddictConstants.Scopes.OfflineAccess;
                if (!descriptor.Permissions.Contains(offlineAccessPermission))
                {
                    descriptor.Permissions.Add(offlineAccessPermission);
                    await applicationManager.UpdateAsync(existingApp, descriptor);
                    logger.LogInformation("‚úÖ Permiss√£o offline_access adicionada √† aplica√ß√£o '{ClientId}'", apiClientId);
                }
            }
        }

        // Aplica√ß√£o para Frontend (SPA)
        if (await applicationManager.FindByClientIdAsync(spaClientId) == null)
        {
            var descriptor = new OpenIddictApplicationDescriptor
            {
                ClientId = spaClientId,
                ConsentType = OpenIddictConstants.ConsentTypes.Implicit,
                DisplayName = "Gestus SPA",
                ClientType = OpenIddictConstants.ClientTypes.Public,
                Permissions =
        {
            OpenIddictConstants.Permissions.Endpoints.Authorization,
            OpenIddictConstants.Permissions.Endpoints.Token,
            OpenIddictConstants.Permissions.GrantTypes.AuthorizationCode,
            OpenIddictConstants.Permissions.GrantTypes.RefreshToken, // ‚úÖ Refresh token para SPA
            OpenIddictConstants.Permissions.ResponseTypes.Code,
            OpenIddictConstants.Permissions.Scopes.Email,
            OpenIddictConstants.Permissions.Scopes.Profile,
            OpenIddictConstants.Permissions.Scopes.Roles,
            // ‚úÖ CORRE√á√ÉO: Usar a constante correta para offline_access
            OpenIddictConstants.Permissions.Prefixes.Scope + OpenIddictConstants.Scopes.OfflineAccess,
            "scp:openid"
        },
                Requirements =
        {
            OpenIddictConstants.Requirements.Features.ProofKeyForCodeExchange
        }
            };

            // Adicionar URIs de configura√ß√£o se houver
            if (spaRedirectUris.Length == 0 || spaPostLogoutUris.Length == 0)
            {
                logger.LogWarning("‚ö†Ô∏è URIs do SPA n√£o configuradas (OpenIddict:Spa:RedirectUris / PostLogoutRedirectUris). Usando padr√£o http(s)://localhost:3000");
                descriptor.RedirectUris.Add(new Uri("http://localhost:3000/callback"));
                descriptor.PostLogoutRedirectUris.Add(new Uri("http://localhost:3000/"));
                descriptor.RedirectUris.Add(new Uri("https://localhost:3000/callback"));
                descriptor.PostLogoutRedirectUris.Add(new Uri("https://localhost:3000/"));
            }
            else
            {
                foreach (var uri in spaRedirectUris) descriptor.RedirectUris.Add(new Uri(uri));
                foreach (var uri in spaPostLogoutUris) descriptor.PostLogoutRedirectUris.Add(new Uri(uri));
            }

            await applicationManager.CreateAsync(descriptor);
            logger.LogInformation("‚úÖ Aplica√ß√£o '{ClientId}' criada no OpenIddict", spaClientId);
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o '{ClientId}' j√° existe no OpenIddict", spaClientId);
        }
    }

    private static async Task CriarPapeisBase(RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üìã Criando pap√©is base...");

        var papeisBase = new[]
        {
            new { Nome = "SuperAdmin", Descricao = "Super Administrador - Controle total do sistema", Categoria = "Sistema", Nivel = 1000 },
            new { Nome = "Admin", Descricao = "Administrador - Gerenciamento operacional", Categoria = "Sistema", Nivel = 500 },
            new { Nome = "Usuario", Descricao = "Usu√°rio - Acesso b√°sico ao sistema", Categoria = "Sistema", Nivel = 100 },
            new { Nome = "GestorUsuarios", Descricao = "Gestor de Usu√°rios - Pode gerenciar usu√°rios", Categoria = "Funcional", Nivel = 300 },
            new { Nome = "GestorPermissoes", Descricao = "Gestor de Permiss√µes - Pode gerenciar permiss√µes", Categoria = "Funcional", Nivel = 400 },
            new { Nome = "Auditor", Descricao = "Auditor - Acesso apenas leitura para auditoria", Categoria = "Funcional", Nivel = 200 }
        };

        var papeisCountAntes = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes antes: {papeisCountAntes}");

        foreach (var papelInfo in papeisBase)
        {
            logger.LogInformation($"üìã Verificando papel: {papelInfo.Nome}");

            if (!await roleManager.RoleExistsAsync(papelInfo.Nome))
            {
                var novoPapel = new Papel
                {
                    Name = papelInfo.Nome,
                    NormalizedName = papelInfo.Nome.ToUpper(),
                    Descricao = papelInfo.Descricao,
                    Categoria = papelInfo.Categoria,
                    Nivel = papelInfo.Nivel,
                    Ativo = true
                };

                var resultado = await roleManager.CreateAsync(novoPapel);
                if (resultado.Succeeded)
                {
                    logger.LogInformation($"‚úÖ Papel criado: {papelInfo.Nome}");
                }
                else
                {
                    logger.LogError($"‚ùå Erro ao criar papel {papelInfo.Nome}: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Papel '{papelInfo.Nome}' j√° existe");
            }
        }

        var papeisCountDepois = await roleManager.Roles.CountAsync();
        logger.LogInformation($"üìã Pap√©is existentes depois: {papeisCountDepois}");
    }

    private static async Task<Usuario?> CriarSuperAdmin(UserManager<Usuario> userManager, ILogger logger)
    {
        logger.LogInformation("üëë Criando usu√°rio Super Admin...");
        logger.LogInformation("üëë Verificando se usu√°rio willian.cavalcante@skymsen.com j√° existe...");

        var emailSuper = "willian.cavalcante@skymsen.com";
        var superAdminExiste = await userManager.FindByEmailAsync(emailSuper);

        if (superAdminExiste == null)
        {
            var superAdmin = new Usuario
            {
                UserName = emailSuper,
                Email = emailSuper,
                EmailConfirmed = true,
                Nome = "Super",
                Sobrenome = "Admin",
                NomeCompleto = "Super Admin",
                Ativo = true,
                DataCriacao = DateTime.UtcNow
            };

            var resultado = await userManager.CreateAsync(superAdmin, "Reboot3!");

            if (resultado.Succeeded)
            {
                logger.LogInformation($"‚úÖ Super Admin criado com ID: {superAdmin.Id}");

                var papelSuperAdminExiste = await userManager.IsInRoleAsync(superAdmin, "SuperAdmin");
                if (!papelSuperAdminExiste)
                {
                    var resultadoPapel = await userManager.AddToRoleAsync(superAdmin, "SuperAdmin");
                    if (resultadoPapel.Succeeded)
                    {
                        logger.LogInformation("‚úÖ Papel SuperAdmin atribu√≠do ao usu√°rio");
                        return superAdmin;
                    }
                    else
                    {
                        logger.LogError($"‚ùå Erro ao atribuir papel SuperAdmin: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                        return superAdmin;
                    }
                }
                return superAdmin;
            }
            else
            {
                logger.LogError($"‚ùå Erro ao criar Super Admin: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                return null;
            }
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è  Super Admin j√° existe (ID: {superAdminExiste.Id})");

            var temPapel = await userManager.IsInRoleAsync(superAdminExiste, "SuperAdmin");
            if (!temPapel)
            {
                var resultadoPapel = await userManager.AddToRoleAsync(superAdminExiste, "SuperAdmin");
                if (resultadoPapel.Succeeded)
                {
                    logger.LogInformation("‚úÖ Papel SuperAdmin atribu√≠do ao usu√°rio existente");
                }
                else
                {
                    logger.LogError($"‚ùå Erro ao atribuir papel SuperAdmin ao usu√°rio existente: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                }
            }
            else
            {
                logger.LogInformation($"üîç Usu√°rio tem papel SuperAdmin: {temPapel}");
            }

            return superAdminExiste;
        }
    }

    private static async Task CriarPermissoesBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üîê Criando permiss√µes base...");

        var permissoesBase = new[]
        {
            // ‚úÖ PERMISS√ïES EXISTENTES (manter)
            new { Nome = "Usuarios.Listar", Descricao = "Listar usu√°rios", Recurso = "Usuarios", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Usuarios.Visualizar", Descricao = "Visualizar detalhes de usu√°rios", Recurso = "Usuarios", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Usuarios.Criar", Descricao = "Criar novos usu√°rios", Recurso = "Usuarios", Acao = "Criar", Categoria = "Sistema" },
            new { Nome = "Usuarios.Editar", Descricao = "Editar usu√°rios existentes", Recurso = "Usuarios", Acao = "Editar", Categoria = "Sistema" },
            new { Nome = "Usuarios.Remover", Descricao = "Remover usu√°rios (soft delete)", Recurso = "Usuarios", Acao = "Remover", Categoria = "Sistema" },
            new { Nome = "Usuarios.Reativar", Descricao = "Reativar usu√°rios desativados", Recurso = "Usuarios", Acao = "Reativar", Categoria = "Sistema" },
            
            // ‚úÖ NOVAS PERMISS√ïES CR√çTICAS PARA SUPER ADMIN
            new { Nome = "Usuarios.ExcluirPermanente", Descricao = "Exclus√£o permanente de usu√°rios (hard delete)", Recurso = "Usuarios", Acao = "ExcluirPermanente", Categoria = "Sistema" },
            new { Nome = "Usuarios.AlterarSenha", Descricao = "Alterar senha de outros usu√°rios", Recurso = "Usuarios", Acao = "AlterarSenha", Categoria = "Sistema" },
            new { Nome = "Usuarios.GerenciarPapeis", Descricao = "Gerenciar pap√©is de usu√°rios", Recurso = "Usuarios", Acao = "GerenciarPapeis", Categoria = "Sistema" },
            new { Nome = "Usuarios.BuscaAvancada", Descricao = "Busca avan√ßada de usu√°rios", Recurso = "Usuarios", Acao = "BuscaAvancada", Categoria = "Sistema" },
            new { Nome = "Usuarios.OperacoesLote", Descricao = "Opera√ß√µes em lote com usu√°rios", Recurso = "Usuarios", Acao = "OperacoesLote", Categoria = "Sistema" },
            
            // ‚úÖ PERMISS√ïES DE EMAIL (ADICIONAR ESTA QUE EST√Å FALTANDO)
            new { Nome = "Email.Listar", Descricao = "Listar configura√ß√µes de email", Recurso = "Email", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Email.Visualizar", Descricao = "Visualizar configura√ß√µes de email", Recurso = "Email", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Email.Criar", Descricao = "Criar configura√ß√µes de email", Recurso = "Email", Acao = "Criar", Categoria = "Sistema" },
            new { Nome = "Email.Editar", Descricao = "Editar configura√ß√µes de email", Recurso = "Email", Acao = "Editar", Categoria = "Sistema" },
            new { Nome = "Email.Remover", Descricao = "Remover configura√ß√µes de email", Recurso = "Email", Acao = "Remover", Categoria = "Sistema" },
            new { Nome = "Email.Enviar", Descricao = "Enviar emails", Recurso = "Email", Acao = "Enviar", Categoria = "Sistema" },
            new { Nome = "Email.Configurar", Descricao = "Configurar templates de email", Recurso = "Email", Acao = "Configurar", Categoria = "Sistema" },
            
            // ‚úÖ OUTRAS PERMISS√ïES...
            new { Nome = "Papeis.Listar", Descricao = "Listar pap√©is", Recurso = "Papeis", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Papeis.Visualizar", Descricao = "Visualizar detalhes de pap√©is", Recurso = "Papeis", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Papeis.Criar", Descricao = "Criar novos pap√©is", Recurso = "Papeis", Acao = "Criar", Categoria = "Sistema" },
            new { Nome = "Papeis.Editar", Descricao = "Editar pap√©is existentes", Recurso = "Papeis", Acao = "Editar", Categoria = "Sistema" },
            new { Nome = "Papeis.Remover", Descricao = "Remover pap√©is", Recurso = "Papeis", Acao = "Remover", Categoria = "Sistema" },
            new { Nome = "Papeis.GerenciarPermissoes", Descricao = "Gerenciar permiss√µes de pap√©is", Recurso = "Papeis", Acao = "GerenciarPermissoes", Categoria = "Sistema" },

            new { Nome = "Permissoes.Listar", Descricao = "Listar permiss√µes", Recurso = "Permissoes", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Permissoes.Visualizar", Descricao = "Visualizar detalhes de permiss√µes", Recurso = "Permissoes", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Permissoes.Criar", Descricao = "Criar novas permiss√µes", Recurso = "Permissoes", Acao = "Criar", Categoria = "Sistema" },
            new { Nome = "Permissoes.Editar", Descricao = "Editar permiss√µes existentes", Recurso = "Permissoes", Acao = "Editar", Categoria = "Sistema" },
            new { Nome = "Permissoes.Remover", Descricao = "Remover permiss√µes", Recurso = "Permissoes", Acao = "Remover", Categoria = "Sistema" },

            new { Nome = "Grupos.Listar", Descricao = "Listar grupos", Recurso = "Grupos", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Grupos.Visualizar", Descricao = "Visualizar detalhes de grupos", Recurso = "Grupos", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Grupos.Criar", Descricao = "Criar novos grupos", Recurso = "Grupos", Acao = "Criar", Categoria = "Sistema" },
            new { Nome = "Grupos.Editar", Descricao = "Editar grupos existentes", Recurso = "Grupos", Acao = "Editar", Categoria = "Sistema" },
            new { Nome = "Grupos.Remover", Descricao = "Remover grupos", Recurso = "Grupos", Acao = "Remover", Categoria = "Sistema" },
            new { Nome = "Grupos.GerenciarMembros", Descricao = "Gerenciar membros de grupos", Recurso = "Grupos", Acao = "GerenciarMembros", Categoria = "Sistema" },

            new { Nome = "Auditoria.Listar", Descricao = "Listar registros de auditoria", Recurso = "Auditoria", Acao = "Listar", Categoria = "Sistema" },
            new { Nome = "Auditoria.Visualizar", Descricao = "Visualizar detalhes de auditoria", Recurso = "Auditoria", Acao = "Visualizar", Categoria = "Sistema" },
            new { Nome = "Auditoria.Exportar", Descricao = "Exportar dados de auditoria", Recurso = "Auditoria", Acao = "Exportar", Categoria = "Sistema" },

            new { Nome = "Sistema.Configurar", Descricao = "Configurar sistema", Recurso = "Sistema", Acao = "Configurar", Categoria = "Sistema" },
            new { Nome = "Sistema.Monitorar", Descricao = "Monitorar sistema e logs", Recurso = "Sistema", Acao = "Monitorar", Categoria = "Sistema" },
            new { Nome = "Sistema.Backup", Descricao = "Fazer backup do sistema", Recurso = "Sistema", Acao = "Backup", Categoria = "Sistema" },
            new { Nome = "Sistema.Restore", Descricao = "Restaurar backup do sistema", Recurso = "Sistema", Acao = "Restore", Categoria = "Sistema" }
        };

        // ‚úÖ VERIFICA√á√ÉO CORRETA DE DUPLICA√á√ÉO (por RECURSO e A√á√ÉO)
        var permissoesExistentes = await context.Permissoes
            .Select(p => new { p.Recurso, p.Acao })
            .ToListAsync();

        var permissoesParaCriar = new List<Permissao>();

        foreach (var permissaoInfo in permissoesBase)
        {
            // ‚úÖ VERIFICAR POR RECURSO E A√á√ÉO (n√£o por nome)
            var permissaoExiste = permissoesExistentes.Any(p =>
                p.Recurso == permissaoInfo.Recurso && p.Acao == permissaoInfo.Acao);

            if (!permissaoExiste)
            {
                permissoesParaCriar.Add(new Permissao
                {
                    Nome = permissaoInfo.Nome,
                    Descricao = permissaoInfo.Descricao,
                    Recurso = permissaoInfo.Recurso,
                    Acao = permissaoInfo.Acao,
                    Categoria = permissaoInfo.Categoria,
                    Ativo = true,
                    DataCriacao = DateTime.UtcNow
                });
            }
        }

        if (permissoesParaCriar.Any())
        {
            try
            {
                context.Permissoes.AddRange(permissoesParaCriar);
                await context.SaveChangesAsync();
                logger.LogInformation($"‚úÖ {permissoesParaCriar.Count} novas permiss√µes criadas");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "‚ùå Erro ao criar permiss√µes. Algumas podem j√° existir.");

                // ‚úÖ SALVAR UMA POR UMA PARA IDENTIFICAR DUPLICATAS
                var sucessos = 0;
                foreach (var permissao in permissoesParaCriar)
                {
                    try
                    {
                        // ‚úÖ VERIFICAR NOVAMENTE ANTES DE INSERIR
                        var jaExiste = await context.Permissoes
                            .AnyAsync(p => p.Recurso == permissao.Recurso && p.Acao == permissao.Acao);

                        if (!jaExiste)
                        {
                            context.Permissoes.Add(permissao);
                            await context.SaveChangesAsync();
                            sucessos++;
                            logger.LogInformation($"‚úÖ Permiss√£o {permissao.Nome} criada");
                        }
                        else
                        {
                            logger.LogInformation($"‚ö†Ô∏è Permiss√£o {permissao.Nome} j√° existe");
                        }
                    }
                    catch (Exception permEx)
                    {
                        logger.LogWarning($"‚ö†Ô∏è Erro ao criar permiss√£o {permissao.Nome}: {permEx.Message}");

                        // ‚úÖ LIMPAR TRACKING PARA PR√ìXIMA TENTATIVA
                        context.Entry(permissao).State = Microsoft.EntityFrameworkCore.EntityState.Detached;
                    }
                }

                if (sucessos > 0)
                {
                    logger.LogInformation($"‚úÖ {sucessos} permiss√µes criadas com sucesso");
                }
            }
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Todas as permiss√µes j√° existem");
        }

        var totalPermissoes = await context.Permissoes.CountAsync();
        logger.LogInformation($"üìã Total de permiss√µes no sistema: {totalPermissoes}");
    }

    private static async Task AssociarPermissoesAosPapeis(GestusDbContexto context, RoleManager<Papel> roleManager, ILogger logger)
    {
        logger.LogInformation("üîó Associando permiss√µes aos pap√©is...");

        var todasPermissoes = await context.Permissoes.Where(p => p.Ativo).ToListAsync();

        // ‚úÖ SuperAdmin atua como usu√°rio root e n√£o precisa de permiss√µes expl√≠citas
        var superAdminPapel = await roleManager.FindByNameAsync("SuperAdmin");
        if (superAdminPapel != null)
        {
            logger.LogInformation("üëë SuperAdmin n√£o requer associa√ß√£o expl√≠cita de permiss√µes (bypass total)");
        }
        else
        {
            logger.LogError("‚ùå Papel SuperAdmin n√£o encontrado!");
        }

        // ‚úÖ ADMIN - PERMISS√ïES OPERACIONAIS (SEM SISTEMA CR√çTICO)
        var adminPapel = await roleManager.FindByNameAsync("Admin");
        if (adminPapel != null)
        {
            // ‚úÖ Administrador: TODAS as permiss√µes, exceto gerenciamento de pap√©is/administradores/super admin e exclus√£o permanente de usu√°rios
            var permissoesAdmin = todasPermissoes
                .Where(p =>
                    // Excluir capacidades de gerenciar pap√©is
                    !(p.Recurso == "Usuarios" && p.Acao == "GerenciarPapeis") &&
                    !(p.Recurso == "Papeis" && new[] { "Criar", "Editar", "Remover", "GerenciarPermissoes" }.Contains(p.Acao)) &&
                    // Por seguran√ßa, n√£o permitir exclus√£o permanente de usu√°rios
                    !(p.Recurso == "Usuarios" && p.Acao == "ExcluirPermanente")
                )
                .ToList();

            await AssociarPermissoesAoPapel(context, adminPapel.Id, permissoesAdmin, logger, "Admin");
            logger.LogInformation($"‚úÖ Admin agora tem {permissoesAdmin.Count} permiss√µes (com ressalvas)");
        }

        // ‚úÖ USU√ÅRIO - PERMISS√ïES B√ÅSICAS
        var usuarioPapel = await roleManager.FindByNameAsync("Usuario");
        if (usuarioPapel != null)
        {
            var permissoesUsuario = todasPermissoes.Where(p =>
                // Apenas visualizar pr√≥prio perfil (ser√° controlado no controller)
                (p.Recurso == "Usuarios" && p.Acao == "Visualizar")
            ).ToList();

            await AssociarPermissoesAoPapel(context, usuarioPapel.Id, permissoesUsuario, logger, "Usuario");
            logger.LogInformation($"‚úÖ Usuario agora tem {permissoesUsuario.Count} permiss√µes");
        }

        // ‚úÖ GESTOR DE USU√ÅRIOS - PERMISS√ïES DE USU√ÅRIOS
        var gestorUsuariosPapel = await roleManager.FindByNameAsync("GestorUsuarios");
        if (gestorUsuariosPapel != null)
        {
            var permissoesGestorUsuarios = todasPermissoes.Where(p =>
                // Usu√°rios (sem exclus√£o permanente e sem gerenciar pap√©is de admin)
                (p.Recurso == "Usuarios" && !new[] { "ExcluirPermanente", "GerenciarPapeis" }.Contains(p.Acao)) ||
                // Grupos (visualizar)
                (p.Recurso == "Grupos" && new[] { "Listar", "Visualizar" }.Contains(p.Acao))
            ).ToList();

            await AssociarPermissoesAoPapel(context, gestorUsuariosPapel.Id, permissoesGestorUsuarios, logger, "GestorUsuarios");
            logger.LogInformation($"‚úÖ GestorUsuarios agora tem {permissoesGestorUsuarios.Count} permiss√µes");
        }
        else
        {
            logger.LogWarning("‚ö†Ô∏è Papel GestorUsuarios n√£o encontrado");
        }

        logger.LogInformation("üîó Associa√ß√£o de permiss√µes conclu√≠da!");
    }

    private static async Task AssociarPermissoesAoPapel(GestusDbContexto context, int papelId, List<Permissao> permissoes, ILogger logger, string nomePapel)
    {
        var permissoesExistentes = await context.PapelPermissoes
            .Where(pp => pp.PapelId == papelId)
            .Select(pp => pp.PermissaoId)
            .ToListAsync();

        var novasAssociacoes = new List<PapelPermissao>();

        foreach (var permissao in permissoes)
        {
            if (!permissoesExistentes.Contains(permissao.Id))
            {
                novasAssociacoes.Add(new PapelPermissao
                {
                    PapelId = papelId,
                    PermissaoId = permissao.Id,
                    DataAtribuicao = DateTime.UtcNow,
                    Ativo = true
                });
            }
        }

        if (novasAssociacoes.Any())
        {
            try
            {
                context.PapelPermissoes.AddRange(novasAssociacoes);
                await context.SaveChangesAsync();
                logger.LogInformation($"üîó {novasAssociacoes.Count} novas permiss√µes associadas ao papel {nomePapel}");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, $"‚ùå Erro ao associar permiss√µes ao papel {nomePapel}");
            }
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è Todas as permiss√µes j√° est√£o associadas ao papel {nomePapel}");
        }
    }

    private static async Task CriarGruposBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üë• Criando grupos base...");

        var gruposBase = new[]
        {
            new { Nome = "Administradores", Descricao = "Grupo de administradores do sistema", Tipo = "Sistema" },
            new { Nome = "Gestores", Descricao = "Grupo de gestores operacionais", Tipo = "Operacional" },
            new { Nome = "Usuarios", Descricao = "Grupo de usu√°rios padr√£o", Tipo = "Padr√£o" },
            new { Nome = "Auditores", Descricao = "Grupo de auditores", Tipo = "Auditoria" }
        };

        foreach (var grupoInfo in gruposBase)
        {
            var grupoExiste = await context.Grupos.AnyAsync(g => g.Nome == grupoInfo.Nome);
            if (!grupoExiste)
            {
                var novoGrupo = new Grupo
                {
                    Nome = grupoInfo.Nome,
                    Descricao = grupoInfo.Descricao,
                    Tipo = grupoInfo.Tipo,
                    Ativo = true,
                    DataCriacao = DateTime.UtcNow
                };

                context.Grupos.Add(novoGrupo);
                logger.LogInformation($"‚úÖ Grupo '{grupoInfo.Nome}' criado");
            }
            else
            {
                logger.LogInformation($"‚ö†Ô∏è  Grupo '{grupoInfo.Nome}' j√° existe");
            }
        }
    }

    private static async Task<Usuario?> CriarAdministrador(UserManager<Usuario> userManager, ILogger logger)
    {
        logger.LogInformation("üë§ Criando usu√°rio Administrador...");
        var emailAdmin = "admin@gestus.local";
        var adminExiste = await userManager.FindByEmailAsync(emailAdmin);

        if (adminExiste == null)
        {
            var admin = new Usuario
            {
                UserName = emailAdmin,
                Email = emailAdmin,
                EmailConfirmed = true,
                Nome = "Administrador",
                Sobrenome = "Gestus",
                NomeCompleto = "Administrador",
                Ativo = true,
                DataCriacao = DateTime.UtcNow
            };

            var resultado = await userManager.CreateAsync(admin, "Reboot3!");
            if (resultado.Succeeded)
            {
                logger.LogInformation($"‚úÖ Administrador criado com ID: {admin.Id}");

                var temPapelAdmin = await userManager.IsInRoleAsync(admin, "Admin");
                if (!temPapelAdmin)
                {
                    var resultadoPapel = await userManager.AddToRoleAsync(admin, "Admin");
                    if (!resultadoPapel.Succeeded)
                    {
                        logger.LogError($"‚ùå Erro ao atribuir papel Admin: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                    }
                }
                return admin;
            }
            else
            {
                logger.LogError($"‚ùå Erro ao criar Administrador: {string.Join(", ", resultado.Errors.Select(e => e.Description))}");
                return null;
            }
        }
        else
        {
            logger.LogInformation($"‚ö†Ô∏è  Administrador j√° existe (ID: {adminExiste.Id})");
            var temPapel = await userManager.IsInRoleAsync(adminExiste, "Admin");
            if (!temPapel)
            {
                var resultadoPapel = await userManager.AddToRoleAsync(adminExiste, "Admin");
                if (!resultadoPapel.Succeeded)
                {
                    logger.LogError($"‚ùå Erro ao atribuir papel Admin ao usu√°rio existente: {string.Join(", ", resultadoPapel.Errors.Select(e => e.Description))}");
                }
            }
            return adminExiste;
        }
    }

    private static async Task CriarScopesOpenIddict(IOpenIddictScopeManager scopeManager, ILogger logger)
    {
        logger.LogInformation("üîß Criando scopes OpenIddict...");

        // Scope profile
        if (await scopeManager.FindByNameAsync("profile") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "profile",
                DisplayName = "Profile",
                Description = "Access to profile information",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'profile' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'profile' j√° existe no OpenIddict");
        }

        // Scope email
        if (await scopeManager.FindByNameAsync("email") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "email",
                DisplayName = "Email",
                Description = "Access to email address",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'email' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'email' j√° existe no OpenIddict");
        }

        // Scope roles
        if (await scopeManager.FindByNameAsync("roles") == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = "roles",
                DisplayName = "Roles",
                Description = "Access to user roles",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'roles' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'roles' j√° existe no OpenIddict");
        }

        // ‚úÖ CORRE√á√ÉO: Usar OpenIddictConstants.Scopes.OfflineAccess (sem .Permissions.Scopes)
        if (await scopeManager.FindByNameAsync(OpenIddictConstants.Scopes.OfflineAccess) == null)
        {
            await scopeManager.CreateAsync(new OpenIddictScopeDescriptor
            {
                Name = OpenIddictConstants.Scopes.OfflineAccess,
                DisplayName = "Offline Access",
                Description = "Access to refresh tokens for offline access",
                Resources = { "gestus_api" }
            });
            logger.LogInformation("‚úÖ Scope 'offline_access' criado no OpenIddict");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Scope 'offline_access' j√° existe no OpenIddict");
        }
    }

    // =========================
    // APLICA√á√ïES DO SISTEMA
    // =========================
    private static async Task CriarTiposStatusAplicacaoBase(GestusDbContexto context, ILogger logger)
    {
        logger.LogInformation("üß± Criando tipos e status de aplica√ß√£o base...");

        // TipoAplicacao: webapp
        if (!await context.TiposAplicacao.AnyAsync(t => t.Codigo == "webapp"))
        {
            context.TiposAplicacao.Add(new TipoAplicacao
            {
                Codigo = "webapp",
                Nome = "Aplica√ß√£o Web",
                Descricao = "Aplica√ß√£o Web baseada em navegador",
                Ordem = 1,
                DataCriacao = DateTime.UtcNow
            });
            logger.LogInformation("‚úÖ TipoAplicacao 'webapp' criado");
        }

        // StatusAplicacao: ativa
        if (!await context.StatusAplicacao.AnyAsync(s => s.Codigo == "ativa"))
        {
            context.StatusAplicacao.Add(new StatusAplicacao
            {
                Codigo = "ativa",
                Nome = "Ativa",
                Descricao = "Aplica√ß√£o ativa e dispon√≠vel",
                CorFundo = "#28a745",
                CorTexto = "#ffffff",
                Icone = "‚úÖ",
                PermiteAcesso = true,
                PermiteNovoUsuario = true,
                VisivelParaUsuarios = true,
                Padrao = true,
                Ordem = 1,
                DataCriacao = DateTime.UtcNow
            });
            logger.LogInformation("‚úÖ StatusAplicacao 'ativa' criado");
        }

        await context.SaveChangesAsync();
    }

    private static async Task CriarAplicacaoGestus(GestusDbContexto context, IConfiguration configuration, ILogger logger)
    {
        logger.LogInformation("üß© Criando aplica√ß√£o 'Gestus'...");

        var baseUrl = configuration["App:BaseUrl"] ?? "https://localhost:7001";
        var tipo = await context.TiposAplicacao.FirstOrDefaultAsync(t => t.Codigo == "webapp");
        var status = await context.StatusAplicacao.FirstOrDefaultAsync(s => s.Codigo == "ativa");

        if (tipo == null || status == null)
        {
            logger.LogWarning("‚ö†Ô∏è Tipo 'webapp' ou Status 'ativa' n√£o encontrados. Pulando cria√ß√£o de aplica√ß√£o Gestus.");
            return;
        }

        var existe = await context.Aplicacoes.AnyAsync(a => a.Codigo == "gestus");
        if (!existe)
        {
            var app = new Aplicacao
            {
                Nome = "Gestus",
                Codigo = "gestus",
                Descricao = "Plataforma Gestus IAM",
                UrlBase = baseUrl,
                TipoAplicacaoId = tipo.Id,
                StatusAplicacaoId = status.Id,
                Versao = "1.0.0",
                Ativa = true,
                RequerAprovacao = false,
                PermiteAutoRegistro = false,
                NivelSeguranca = 5,
                CriadoPorId = 1,
                DataCriacao = DateTime.UtcNow
            };
            context.Aplicacoes.Add(app);
            await context.SaveChangesAsync();
            logger.LogInformation("‚úÖ Aplica√ß√£o 'Gestus' criada");
        }
        else
        {
            logger.LogInformation("‚ö†Ô∏è Aplica√ß√£o 'Gestus' j√° existe");
        }
    }

    private static async Task ConcederAcessoAplicacaoGestus(GestusDbContexto context, ILogger logger, int? usuarioId)
    {
        if (!usuarioId.HasValue) return;

        var appGestus = await context.Aplicacoes.FirstOrDefaultAsync(a => a.Codigo == "gestus");
        if (appGestus == null) return;

        var existe = await context.UsuariosAplicacao.AnyAsync(ua => ua.UsuarioId == usuarioId.Value && ua.AplicacaoId == appGestus.Id);
        if (!existe)
        {
            context.UsuariosAplicacao.Add(new UsuarioAplicacao
            {
                UsuarioId = usuarioId.Value,
                AplicacaoId = appGestus.Id,
                Aprovado = true,
                DataAprovacao = DateTime.UtcNow,
                Justificativa = "Acesso padr√£o",
                Ativo = true
            });
            await context.SaveChangesAsync();
            logger.LogInformation("‚úÖ Acesso do usu√°rio {UsuarioId} √† aplica√ß√£o Gestus concedido", usuarioId);
        }
    }
}
